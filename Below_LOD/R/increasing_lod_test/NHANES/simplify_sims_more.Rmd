---
title: "One Pattern Sims"
author: "Lizzy Gibson"
date: "6/09/2020"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 5
---

```{r setup, include=FALSE}
require("knitr")
opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
options(scipen = 999)
library(R.matlab)
library(tidyverse)
library(gridExtra)
library(Matrix)
library(matconv)
library(patchwork)
library(janitor)
library(ggcorrplot)
library(ggfortify)  
library(factoextra)
library(knitr)
library(haven)
library(rlist)
library(mvtnorm)
library(reshape2)
library(GGally)
library(grDevices)
```

## Simulate

```{r, scores}
# Simulate independent scores
set.seed(1988)
scores <- exp(rnorm(100))
# summary(scores)
# sd(scores)

scores %>%
  as_tibble() %>% 
  ggplot(aes(x = value)) +
  geom_histogram() + 
  theme_minimal()

# Simulate 1 pattern
pattern <- t(c(1,1,1,1,1,1,0,0,0,0))

# Add noise
noise <- matrix(NA, nrow = 100, ncol = 10)
seeds <- 1:10
for (i in 1:length(seeds)) {
  set.seed(seeds[i])
  noise[,i] <- exp(rnorm(100, mean = 0, sd = 1))
}

# Multiply scores by pattern
sim_all <- as_tibble((scores %*% pattern) + noise)
summary(sim_all)
sim_all[sim_all < 0] <- 0 # non-negative
sim_all <- as_tibble(scale(sim_all, center = FALSE, 
                           scale = apply(sim_all, 2, sd, na.rm = TRUE))) # standardize do not center
#sim_all

sim_all %>%
  mutate(id = 1:nrow(.)) %>% 
  gather(key = pop, value = value, -id) %>% 
  ggplot(aes(x = value)) +
  geom_histogram() + facet_wrap(~pop) +
  theme_minimal()

ggcorr(sim_all, method = c("everything", "spearman"), limits = FALSE,
       label = TRUE, label_size = 3, label_alpha = TRUE,
       hjust = 0.85, size = 3, color = "grey50", layout.exp = 1)
```

```{r, neg}
mix_data_lod_10 <- sim_all %>%
  mutate(V1 = ifelse(V1 < quantile(V1, probs = .10), -1, V1)) %>% as.matrix()
  
# Create version with 20% lowest values for each variable as below the LOD
mix_data_lod_20 <- sim_all %>% 
  mutate(V1 = ifelse(V1 < quantile(V1, probs = .20), -1, V1)) %>% as.matrix()

# Create version with 30% lowest values for each variable as below the LOD
mix_data_lod_30 <- sim_all %>% 
  mutate(V1 = ifelse(V1 < quantile(V1, probs = .30), -1, V1)) %>% as.matrix()

# Create version with 40% lowest values for each variable as below the LOD
mix_data_lod_40 <- sim_all %>% 
  mutate(V1 = ifelse(V1 < quantile(V1, probs = .40), -1, V1)) %>% as.matrix()

# Create version with 50% lowest values for each variable as below the LOD
mix_data_lod_50 <- sim_all %>% 
  mutate(V1 = ifelse(V1 < quantile(V1, probs = .50), -1, V1)) %>% as.matrix()

# Create version with 10% lowest values for each variable as below the LOD
mix_data_lod_10_sqrt2 <- sim_all %>% 
  mutate(V1 = ifelse(V1 < quantile(V1, probs = .10), (quantile(V1, probs = .10)/sqrt(2)), V1)) %>% as.matrix()

# Create version with 20% lowest values for each variable as below the LOD
mix_data_lod_20_sqrt2 <- sim_all %>% 
  mutate(V1 = ifelse(V1 < quantile(V1, probs = .20), (quantile(V1, probs = .20)/sqrt(2)), V1)) %>% as.matrix()

# Create version with 30% lowest values for each variable as below the LOD
mix_data_lod_30_sqrt2 <- sim_all %>% 
  mutate(V1 = ifelse(V1 < quantile(V1, probs = .30), (quantile(V1, probs = .30)/sqrt(2)), V1)) %>% as.matrix()

# Create version with 40% lowest values for each variable as below the LOD
mix_data_lod_40_sqrt2 <- sim_all %>% 
  mutate(V1 = ifelse(V1 < quantile(V1, probs = .40), (quantile(V1, probs = .40)/sqrt(2)), V1)) %>% as.matrix()

# Create version with 50% lowest values for each variable as below the LOD
mix_data_lod_50_sqrt2 <- sim_all %>% 
  mutate(V1 = ifelse(V1 < quantile(V1, probs = .50), (quantile(V1, probs = .50)/sqrt(2)), V1)) %>% as.matrix()

# LODs
delta10 <- c(quantile(sim_all$V1, probs = 0.10), rep(0, times = 9))

delta20 <- c(quantile(sim_all$V1, probs = 0.20), rep(0, times = 9))

delta30 <- c(quantile(sim_all$V1, probs = 0.30), rep(0, times = 9))

delta40 <- c(quantile(sim_all$V1, probs = 0.40), rep(0, times = 9))

delta50 <- c(quantile(sim_all$V1, probs = 0.50), rep(0, times = 9))
```

```{r, lod_function}
prox_l1 <- function(Y, c) {
  
  myzero <- matrix(data = 0, ncol = ncol(Y), nrow = nrow(Y))
  X <- sign(Y) * pmax(abs(Y) - c, myzero, na.rm = TRUE)
  X
} 

############################################################

prox_nuclear <- function(Y, c) {
  
  USV <- svd(Y)
  U <- USV$u
  S <- USV$d
  V <- USV$v
  
  myzero <- vector("numeric", length = length(S))
  S_new <- sign(S) * pmax(abs(S) - c, myzero, na.rm = TRUE)
  X <- U %*% diag(S_new) %*% t(V)
  nuclearX  <- sum(abs(S_new))

    list(X = X, nuclearX = nuclearX)
}

############################################################

is_same <- function(SAME_THRESH, ...) {
  flag <- TRUE
  varargin <- list(...)
  if (length(varargin) == 2) {
    if (max(abs(varargin[[1]] - varargin[[2]])) > SAME_THRESH) {
      flag <- FALSE
    }
  }
  else if (length(varargin) == 3) {
    if ((max(abs(varargin[[1]] - varargin[[2]])) > SAME_THRESH) |
        (max(abs(varargin[[1]] - varargin[[3]])) > SAME_THRESH) |
        (max(abs(varargin[[2]] - varargin[[3]])) > SAME_THRESH)) {
      flag <- FALSE
    }
  }
  flag
}

############################################################

loss_lod <- function(X, D, LOD) {

    X_lod <- ((X - D)     * (D >= 0)) +
             ((X - LOD)   * (D < 0 & (X > LOD))) +
              (X          * (D < 0 & X < 0))
  
  l <- sum(X_lod^2) / 2
  l
}

############################################################

pcp_lod <- function(D, lambda, mu, LOD) {
  
  m <- nrow(D)
  n <- ncol(D)
  rho <- 1 # Augmented Lagrangian coefficient (rate)
  
  L1 <- matrix(0, m, n)
  L2 <- matrix(0, m, n)
  L3 <- matrix(0, m, n)
  
  S1 <- matrix(0, m, n)
  S2 <- matrix(0, m, n)
  
  Z1 <- matrix(0, m, n)
  Z2 <- matrix(0, m, n)
  Z3 <- matrix(0, m, n)
  
  # Max iteration
  MAX_ITER <- 5000
  
  # Convergence Thresholds
  LOSS_THRESH <- 1e-5
  SAME_THRESH <- 1e-4
  
  if (is.vector(LOD)) {
    empty = matrix(1, nrow = nrow(D), ncol = ncol(D))
    LOD = t(t(empty) * LOD)
  }
  
  loss <- vector("numeric", MAX_ITER)
  
  for (i in 1:MAX_ITER) {
    
    nuc <- prox_nuclear( ((L2 + L3 - (Z1 + Z2)/rho)/2), 1/2/rho)
    L1 <- nuc[[1]]
    nuclearL1 <- nuc[[2]] #nuclearX
    
    S1 <- prox_l1((S2 - Z3/rho), lambda/rho)
    
      L2_opt1 <- (mu*rho*D     + (mu + rho)*Z1 - mu*Z3 + (mu + rho)*rho*L1 - mu*rho*S1) / (2*mu*rho + rho^2)
      L2_opt2 <- L1 + Z1/rho
      L2_opt3 <- ((mu*rho*LOD + (((mu + rho)*Z1) - (mu*Z3) + ((mu + rho)*rho*L1) - (mu*rho*S1)))) / ((2*mu*rho) + (rho^2))
      L2_opt4 <- (               (mu + rho)*Z1 - mu*Z3 + (mu + rho)*rho*L1 - mu*rho*S1) / (2*mu*rho + rho^2)

      L2_new <- (L2_opt1 * (D >= 0)) +
        (L2_opt2 * ((D < 0) & (((L2 + S2) >= 0) & ((L2 + S2) <= LOD)))) +
        (L2_opt3 * ((D < 0) & (((L2 + S2) > LOD)))) +
        (L2_opt4 * ((D < 0) & (((L2 + S2) < 0))))

      S2_opt1 <- (mu*rho*D     + (mu + rho)*Z3 - (mu*Z1) + (mu + rho)*rho*S1 - mu*rho*L1) / (2*mu*rho + rho^2)
      S2_opt2 <- S1 + (Z3/rho)
      S2_opt3 <- (((mu*rho*LOD) + (((mu + rho)*Z3) - (mu*Z1) + ((mu + rho)*rho*S1) - (mu*rho*L1)))) / ((2*mu*rho) + (rho^2))
      S2_opt4 <- (               (mu + rho)*Z3 - (mu*Z1) + (mu + rho)*rho*S1 - mu*rho*L1) / (2*mu*rho + rho^2)

      S2 <- (S2_opt1 * (D >= 0)) +
        (S2_opt2 * (((D < 0) & ((L2 + S2) >= 0) & ((L2 + S2) <= LOD)))) +
        (S2_opt3 * (((D < 0) & ((L2 + S2) > LOD)))) +
        (S2_opt4 * (((D < 0) & ((L2 + S2) < 0))))
   
    L2 <- L2_new
    
    L3 <- pmax(L1 + Z2/rho, 0, na.rm = TRUE)
    # % Non-Negativity constraint!
    
    Z1 <- Z1 + rho*(L1 - L2)
    Z2 <- Z2 + rho*(L1 - L3)
    Z3 <- Z3 + rho*(S1 - S2)
    # % Z accumulate differnces between L and L and between S and S
    
    loss[i] <- nuclearL1 + 
      (lambda*sum(abs(S1))) +
      (mu*loss_lod((L2 + S2), D, LOD)) +
      sum(Z1*(L1 - L2)) +
      sum(Z2*(L1 - L3)) +
      sum(Z3*(S1 - S2)) +
      (rho/2 * (sum((L1-L2)^2) + sum((L1 - L3)^2) + sum((S1 - S2)^2)))
    # % The code block above takes LOD into account.
    
    print(str_c(i, " Obj: ", loss[i]))
        
    if ((i != 1) && 
        (abs(loss[i-1] - loss[i]) < LOSS_THRESH) && 
        is_same(SAME_THRESH, L1, L2, L3) &&
        is_same(SAME_THRESH, S1, S2)) {
      break} # % Convergence criteria!
  }
  
  L <- L3 # (L1 + L2 + L3) / 3
  S <- S1 #(S1 + S2) / 2
  list(L = L, S = S, loss = loss)
}

# Old function
soft_thresholding <- function(v, lambda) {
  myzero <- matrix(data = 0, ncol = ncol(v), nrow = nrow(v))
  w <- sign(v) * pmax(abs(v) - lambda, myzero)
  w
} 

soft_thresholding_diag <- function(v, lambda) {
  myzero <- vector("numeric", length = length(v))
  w <- sign(v) * pmax(abs(v) - lambda, myzero)
  w
} 

singular_value_threshold <- function(M, lambda) {
  
  USV <- svd(M)
  U <- USV$u
  S <- USV$d
  V <- USV$v
    
  N <- U %*% diag(soft_thresholding_diag(S, lambda)) %*% t(V)
  
  v  <- sum(soft_thresholding_diag(S, lambda))
  
  svt <- list(N = N, v = v) 
  svt
}

original_pcp <- function(D, lambda, mu) {
  
  m <- nrow(D)
  n <- ncol(D)
  
  S <- matrix(0, nrow = m, ncol = n)
  L <- matrix(0, nrow = m, ncol = n)
  
  iter <- 0
  MAX_ITER <- 5000
  done <- FALSE
  
  # Convergence Thresholds
  LOSS_THRESH <- 1e-4
  loss <- vector("numeric", MAX_ITER)
  
  while (!done) {
    
    iter <- iter + 1
    
    svt <- singular_value_threshold((D - S), 1/mu)
    L <- svt[[1]] #svt$N
    v <- svt[[2]]
    
    S <- soft_thresholding((D - L), lambda/mu)
    
    obj <- v + lambda * sum(abs(S)) + (mu/2) * norm((D - L - S), type = "F")^2
    loss[iter] <- obj
    
    print(str_c(iter, " Obj: ", obj))
    
    if (iter >= MAX_ITER | 
        (iter != 1) && (abs(loss[iter-1] - loss[iter]) < LOSS_THRESH)) {done <- TRUE}
    
  }
  list(L = L, S = S, Lambda = lambda, Mu = mu, obj_value = obj)
}

# nonnegative sparse version
pcp_lod_nnS <- function(D, lambda, mu, LOD) {
  
  m <- nrow(D)
  n <- ncol(D)
  rho <- 1 # Augmented Lagrangian coefficient (rate)
  
  L1 <- matrix(0, m, n)
  L2 <- matrix(0, m, n)
  L3 <- matrix(0, m, n)
  
  S1 <- matrix(0, m, n)
  S2 <- matrix(0, m, n)
  S3 <- matrix(0, m, n) # ADDED
  
  Z1 <- matrix(0, m, n)
  Z2 <- matrix(0, m, n)
  Z3 <- matrix(0, m, n)
  Z4 <- matrix(0, m, n) # ADDED
  
  # Max iteration
  MAX_ITER <- 5000
  
  # Convergence Thresholds
  LOSS_THRESH <- 1e-5
  SAME_THRESH <- 1e-4
  
  if (is.vector(LOD)) {
  #tf = ifelse(D < 0, TRUE, FALSE)
  #LOD = t(t(tf) * LOD)
    empty = matrix(1, nrow = nrow(D), ncol = ncol(D))
    LOD = t(t(empty) * LOD)
    }
  
  loss <- vector("numeric", MAX_ITER)
  
  for (i in 1:MAX_ITER) {
    
    nuc <- prox_nuclear(((L2 + L3 - (Z1 + Z2)/rho)/2), 1/2/rho)
    L1 <- nuc[[1]]
    nuclearL1 <- nuc[[2]] #nuclearX
    
    S1 <- prox_l1(((S2 + S3 - (Z3 + Z4)/rho)/2), lambda/rho) # ADDED
      #prox_l1(S2 - Z3/rho, lambda/rho)
    
    L2_opt1 <- (mu*rho*D     + (mu + rho)*Z1 - mu*Z3 + (mu + rho)*rho*L1 - mu*rho*S1) / (2*mu*rho + rho^2)
    L2_opt2 <- L1 + Z1/rho
    L2_opt3 <- ((mu*rho*LOD + (((mu + rho)*Z1) - (mu*Z3) + ((mu + rho)*rho*L1) - (mu*rho*S1)))) / ((2*mu*rho) + (rho^2))
    L2_opt4 <- (               (mu + rho)*Z1 - mu*Z3 + (mu + rho)*rho*L1 - mu*rho*S1) / (2*mu*rho + rho^2)

    L2 <- (L2_opt1 * (D >= 0)) +
        (L2_opt2 * ((D < 0) & (((L2 + S2) >= 0) & ((L2 + S2) <= LOD)))) +
        (L2_opt3 * ((D < 0) & (((L2 + S2) > LOD)))) +
        (L2_opt4 * ((D < 0) & (((L2 + S2) < 0))))

    S2_opt1 <- (mu*rho*D     + (mu + rho)*Z3 - (mu*Z1) + (mu + rho)*rho*S1 - mu*rho*L1) / (2*mu*rho + rho^2)
    S2_opt2 <- S1 + (Z3/rho)
    S2_opt3 <- (((mu*rho*LOD) + (((mu + rho)*Z3) - (mu*Z1) + ((mu + rho)*rho*S1) - (mu*rho*L1)))) / ((2*mu*rho) + (rho^2))
    S2_opt4 <- (               (mu + rho)*Z3 - (mu*Z1) + (mu + rho)*rho*S1 - mu*rho*L1) / (2*mu*rho + rho^2)

    S2 <- (S2_opt1 * (D >= 0)) +
        (S2_opt2 * (((D < 0) & ((L2 + S2) >= 0) & ((L2 + S2) <= LOD)))) +
        (S2_opt3 * (((D < 0) & ((L2 + S2) > LOD)))) +
        (S2_opt4 * (((D < 0) & ((L2 + S2) < 0))))
      
    L3 <- pmax(L1 + Z2/rho, 0, na.rm = TRUE)
    # % Non-Negativity constraint!
    
    ## ADDED
    S3 <- pmax(S1 + Z4/rho, 0, na.rm = TRUE)
    
    Z1 <- Z1 + rho*(L1 - L2)
    Z2 <- Z2 + rho*(L1 - L3)
    Z3 <- Z3 + rho*(S1 - S2)
    Z4 <- Z4 + rho*(S1 - S3) # ADDED
    # % Z accumulate differnces between L and L and between S and S
    
    loss[i] <- nuclearL1 + 
      (lambda*sum(abs(S1))) +
      (mu*loss_lod((L2 + S2), D, LOD)) +
      sum(Z1*(L1 - L2)) +
      sum(Z2*(L1 - L3)) +
      sum(Z3*(S1 - S2)) +
      sum(Z4*(S1 - S3)) + # ADDED
      (rho/2 * (sum((L1-L2)^2) + sum((L1 - L3)^2) + sum((S1 - S2)^2)) + sum((S1 - S3)^2)) # ADDED
    # % The code block above takes LOD into account.
    
    print(str_c(i, " Obj: ", loss[i]))
        
    if ((i != 1) && 
        (abs(loss[i-1] - loss[i]) < LOSS_THRESH) && 
        is_same(SAME_THRESH, L1, L2, L3) &&
        is_same(SAME_THRESH, S1, S2, S3)) { # ADDED
      break} # % Convergence criteria!
  }
  
  L <- L3 #(L1 + L2 + L3) / 3
  S <- S3 #(S1 + S2 + S3) / 3
  list(L = L, S = S, loss = loss)
}
```

```{r, jingkai_leave, cache = TRUE, include=FALSE}
m <- nrow(sim_all)
p <- ncol(sim_all)

lambda_mix <- 1/sqrt(m)
mu_mix <- sqrt(p/(2*log(m*p)))

mix <- as.matrix(sim_all)

dim(mix)
length(delta10)

results_0  <- pcp_lod(mix,             lambda_mix, mu_mix, 0)
results_10 <- pcp_lod(mix_data_lod_10, lambda_mix, mu_mix, delta10)
results_20 <- pcp_lod(mix_data_lod_20, lambda_mix, mu_mix, delta20)
results_30 <- pcp_lod(mix_data_lod_30, lambda_mix, mu_mix, delta30)
results_40 <- pcp_lod(mix_data_lod_40, lambda_mix, mu_mix, delta40)
results_50 <- pcp_lod(mix_data_lod_50, lambda_mix, mu_mix, delta50)

L_lod0 <- results_0[[1]]
S_lod0 <- results_0[[2]]
L_lod10 <- results_10[[1]]
S_lod10 <- results_10[[2]]
L_lod20 <- results_20[[1]]
S_lod20 <- results_20[[2]]
L_lod30 <- results_30[[1]]
S_lod30 <- results_30[[2]]
L_lod40 <- results_40[[1]]
S_lod40 <- results_40[[2]]
L_lod50 <- results_50[[1]]
S_lod50 <- results_50[[2]]

# svd(L_lod50)$d
# rankMatrix(L_lod50)
```

```{r, nns, cache = TRUE, include=FALSE}
results_0_nnS  <- pcp_lod_nnS(mix,             lambda_mix, mu_mix, 0)
results_10_nnS <- pcp_lod_nnS(mix_data_lod_10, lambda_mix, mu_mix, delta10)
results_20_nnS <- pcp_lod_nnS(mix_data_lod_20, lambda_mix, mu_mix, delta20)
results_30_nnS <- pcp_lod_nnS(mix_data_lod_30, lambda_mix, mu_mix, delta30)
results_40_nnS <- pcp_lod_nnS(mix_data_lod_40, lambda_mix, mu_mix, delta40)
results_50_nnS <- pcp_lod_nnS(mix_data_lod_50, lambda_mix, mu_mix, delta50)

L_lod0_nnS <- results_0_nnS[[1]]
S_lod0_nnS <- results_0_nnS[[2]]
L_lod10_nnS <- results_10_nnS[[1]]
S_lod10_nnS <- results_10_nnS[[2]]
L_lod20_nnS <- results_20_nnS[[1]]
S_lod20_nnS <- results_20_nnS[[2]]
L_lod30_nnS <- results_30_nnS[[1]]
S_lod30_nnS <- results_30_nnS[[2]]
L_lod40_nnS <- results_40_nnS[[1]]
S_lod40_nnS <- results_40_nnS[[2]]
L_lod50_nnS <- results_50_nnS[[1]]
S_lod50_nnS <- results_50_nnS[[2]]
```

```{r, original, cache = TRUE, include=FALSE}
results_0_sqrt2  <- original_pcp(mix,                   lambda_mix, mu_mix)
results_10_sqrt2 <- original_pcp(mix_data_lod_10_sqrt2, lambda_mix, mu_mix)
results_20_sqrt2 <- original_pcp(mix_data_lod_20_sqrt2, lambda_mix, mu_mix)
results_30_sqrt2 <- original_pcp(mix_data_lod_30_sqrt2, lambda_mix, mu_mix)
results_40_sqrt2 <- original_pcp(mix_data_lod_40_sqrt2, lambda_mix, mu_mix)
results_50_sqrt2 <- original_pcp(mix_data_lod_50_sqrt2, lambda_mix, mu_mix)

L_lod0_sqrt2 <- results_0_sqrt2[[1]]
S_lod0_sqrt2 <- results_0_sqrt2[[2]]
L_lod10_sqrt2 <- results_10_sqrt2[[1]]
S_lod10_sqrt2 <- results_10_sqrt2[[2]]
L_lod20_sqrt2 <- results_20_sqrt2[[1]]
S_lod20_sqrt2 <- results_20_sqrt2[[2]]
L_lod30_sqrt2 <- results_30_sqrt2[[1]]
S_lod30_sqrt2 <- results_30_sqrt2[[2]]
L_lod40_sqrt2 <- results_40_sqrt2[[1]]
S_lod40_sqrt2 <- results_40_sqrt2[[2]]
L_lod50_sqrt2 <- results_50_sqrt2[[1]]
S_lod50_sqrt2 <- results_50_sqrt2[[2]]
```

## X - L - S

```{r, xls}
F_norm <- as_tibble(cbind(`0%` = norm((mix - L_lod0 - S_lod0), type = "F")/norm((mix), type = "F"),
      `10%` = norm((mix - L_lod10 - S_lod10), type = "F")/norm((mix), type = "F"),
      `20%` = norm((mix - L_lod20 - S_lod20), type = "F")/norm((mix), type = "F"),
      `30%` = norm((mix - L_lod30 - S_lod30), type = "F")/norm((mix), type = "F"),
      `40%` = norm((mix - L_lod40 - S_lod40), type = "F")/norm((mix), type = "F"),
      `50%` = norm((mix - L_lod50 - S_lod50), type = "F")/norm((mix), type = "F"))) %>% 
  gather(Percent, norm) %>% 
  mutate(Method = "LOD PCP")

F_norm_sqrt2 <- as_tibble(cbind(`0%` = norm((mix - L_lod0_sqrt2 - S_lod0_sqrt2), type = "F")/norm((mix), type = "F"),
      `10%` = norm((mix - L_lod10_sqrt2 - S_lod10_sqrt2), type = "F")/norm((mix), type = "F"),
      `20%` = norm((mix - L_lod20_sqrt2 - S_lod20_sqrt2), type = "F")/norm((mix), type = "F"),
      `30%` = norm((mix - L_lod30_sqrt2 - S_lod30_sqrt2), type = "F")/norm((mix), type = "F"),
      `40%` = norm((mix - L_lod40_sqrt2 - S_lod40_sqrt2), type = "F")/norm((mix), type = "F"),
      `50%` = norm((mix - L_lod50_sqrt2 - S_lod50_sqrt2), type = "F")/norm((mix), type = "F"))) %>% 
  gather(Percent, norm) %>% 
  mutate(Method = paste0("PCP w/ LOD/", intToUtf8(8730),2))

F_norm_nnS <- as_tibble(cbind(`0%` = norm((mix - L_lod0_nnS - S_lod0_nnS), type = "F")/norm((mix), type = "F"),
      `10%` = norm((mix - L_lod10_nnS - S_lod10_nnS), type = "F")/norm((mix), type = "F"),
      `20%` = norm((mix - L_lod20_nnS - S_lod20_nnS), type = "F")/norm((mix), type = "F"),
      `30%` = norm((mix - L_lod30_nnS - S_lod30_nnS), type = "F")/norm((mix), type = "F"),
      `40%` = norm((mix - L_lod40_nnS - S_lod40_nnS), type = "F")/norm((mix), type = "F"),
      `50%` = norm((mix - L_lod50_nnS - S_lod50_nnS), type = "F")/norm((mix), type = "F"))) %>% 
  gather(Percent, norm) %>% 
  mutate(Method = "LOD PCP nnS")
```

* X = simulated dataset
* L = low rank solution matrix
* S = sparse solution matrix

```{r, fig.align = "center"}
rbind(F_norm_sqrt2, F_norm, F_norm_nnS) %>% ggplot(aes(x = Percent, y = norm)) + 
  geom_point(aes(color = Method)) + geom_path(aes(group = Method, color = Method)) + theme_bw() +
  labs(x = "Percent Below LOD", y = "norm(X-L-S) / norm(X)",
       title = "Relative Prediction Error")
```

## Individual Solution Matrices

```{r, ind}
L_diff <- as_tibble(cbind(`0%` = norm((L_lod0 - L_lod0), type = "F")/norm((L_lod0), type = "F"),
      `10%` = norm((L_lod10 - L_lod0), type = "F")/norm((L_lod0), type = "F"),
      `20%` = norm((L_lod20 - L_lod0), type = "F")/norm((L_lod0), type = "F"),
      `30%` = norm((L_lod30 - L_lod0), type = "F")/norm((L_lod0), type = "F"),
      `40%` = norm((L_lod40 - L_lod0), type = "F")/norm((L_lod0), type = "F"),
      `50%` = norm((L_lod50 - L_lod0), type = "F")/norm((L_lod0), type = "F"))) %>% 
  gather(Percent, norm) %>% 
  mutate(Matrix = "Low-Rank",
         Method = "LOD PCP")

S_diff <- as_tibble(cbind(`0%` = norm((S_lod0 - S_lod0), type = "F")/norm((S_lod0), type = "F"),
      `10%` = norm((S_lod10 - S_lod0), type = "F")/norm((S_lod0), type = "F"),
      `20%` = norm((S_lod20 - S_lod0), type = "F")/norm((S_lod0), type = "F"),
      `30%` = norm((S_lod30 - S_lod0), type = "F")/norm((S_lod0), type = "F"),
      `40%` = norm((S_lod40 - S_lod0), type = "F")/norm((S_lod0), type = "F"),
      `50%` = norm((S_lod50 - S_lod0), type = "F")/norm((S_lod0), type = "F"))) %>% 
  gather(Percent, norm) %>% 
  mutate(Matrix = "Sparse",
         Method = "LOD PCP")

L_diff_sqrt2 <- as_tibble(cbind(`0%` = norm((L_lod0_sqrt2 - L_lod0_sqrt2), type = "F")/norm((L_lod0_sqrt2), type = "F"),
      `10%` = norm((L_lod10_sqrt2 - L_lod0_sqrt2), type = "F")/norm((L_lod0_sqrt2), type = "F"),
      `20%` = norm((L_lod20_sqrt2 - L_lod0_sqrt2), type = "F")/norm((L_lod0_sqrt2), type = "F"),
      `30%` = norm((L_lod30_sqrt2 - L_lod0_sqrt2), type = "F")/norm((L_lod0_sqrt2), type = "F"),
      `40%` = norm((L_lod40_sqrt2 - L_lod0_sqrt2), type = "F")/norm((L_lod0_sqrt2), type = "F"),
      `50%` = norm((L_lod50_sqrt2 - L_lod0_sqrt2), type = "F")/norm((L_lod0_sqrt2), type = "F"))) %>% 
  gather(Percent, norm) %>% 
  mutate(Matrix = "Low-Rank",
         Method = paste0("PCP w/ LOD/", intToUtf8(8730),2))

S_diff_sqrt2 <- as_tibble(cbind(`0%` = norm((S_lod0_sqrt2 - S_lod0_sqrt2), type = "F")/norm((S_lod0_sqrt2), type = "F"),
      `10%` = norm((S_lod10_sqrt2 - S_lod0_sqrt2), type = "F")/norm((S_lod0_sqrt2), type = "F"),
      `20%` = norm((S_lod20_sqrt2 - S_lod0_sqrt2), type = "F")/norm((S_lod0_sqrt2), type = "F"),
      `30%` = norm((S_lod30_sqrt2 - S_lod0_sqrt2), type = "F")/norm((S_lod0_sqrt2), type = "F"),
      `40%` = norm((S_lod40_sqrt2 - S_lod0_sqrt2), type = "F")/norm((S_lod0_sqrt2), type = "F"),
      `50%` = norm((S_lod50_sqrt2 - S_lod0_sqrt2), type = "F")/norm((S_lod0_sqrt2), type = "F"))) %>% 
  gather(Percent, norm) %>% 
  mutate(Matrix = "Sparse",
         Method = paste0("PCP w/ LOD/", intToUtf8(8730),2))

L_diff_nnS <- as_tibble(cbind(`0%` = norm((L_lod0_nnS - L_lod0_nnS), type = "F")/norm((L_lod0_nnS), type = "F"),
      `10%` = norm((L_lod10_nnS - L_lod0_nnS), type = "F")/norm((L_lod0_nnS), type = "F"),
      `20%` = norm((L_lod20_nnS - L_lod0_nnS), type = "F")/norm((L_lod0_nnS), type = "F"),
      `30%` = norm((L_lod30_nnS - L_lod0_nnS), type = "F")/norm((L_lod0_nnS), type = "F"),
      `40%` = norm((L_lod40_nnS - L_lod0_nnS), type = "F")/norm((L_lod0_nnS), type = "F"),
      `50%` = norm((L_lod50_nnS - L_lod0_nnS), type = "F")/norm((L_lod0_nnS), type = "F"))) %>% 
  gather(Percent, norm) %>% 
  mutate(Matrix = "Low-Rank",
         Method = "LOD PCP nnS")

S_diff_nnS <- as_tibble(cbind(`0%` = norm((S_lod0_nnS - S_lod0_nnS), type = "F")/norm((S_lod0_nnS), type = "F"),
      `10%` = norm((S_lod10_nnS - S_lod0_nnS), type = "F")/norm((S_lod0_nnS), type = "F"),
      `20%` = norm((S_lod20_nnS - S_lod0_nnS), type = "F")/norm((S_lod0_nnS), type = "F"),
      `30%` = norm((S_lod30_nnS - S_lod0_nnS), type = "F")/norm((S_lod0_nnS), type = "F"),
      `40%` = norm((S_lod40_nnS - S_lod0_nnS), type = "F")/norm((S_lod0_nnS), type = "F"),
      `50%` = norm((S_lod50_nnS - S_lod0_nnS), type = "F")/norm((S_lod0_nnS), type = "F"))) %>% 
  gather(Percent, norm) %>% 
  mutate(Matrix = "Sparse",
         Method = "LOD PCP nnS")
```

* Reference is solution matix with 0\% \<LOD  
* Low rank solution matrices compared with low rank solution with 0\% \<LOD
* Sparse solution matrices compared with sparse solution with 0\% \<LOD

```{r, fig.align = "center"}
rbind(L_diff_sqrt2, S_diff_sqrt2,
      L_diff, S_diff,
      L_diff_nnS, S_diff_nnS) %>%
  ggplot(aes(x = Percent, y = norm, group = interaction(Matrix,Method), color = Method)) + 
  geom_point() + geom_path(aes(linetype = Matrix)) + theme_bw() +
  labs(x = "Percent Below LOD", y = "norm(difference) / norm(lod0))",
       title = "Relative Error in Solution Matrices")
```



## Values \<LOD vs \>LOD

```{r, delt_0}
mix_data_lod_10_0 <- sim_all %>%
  mutate(V1 = ifelse(V1 < quantile(V1, probs = .10), 0, V1)) %>% as.matrix()
  
# Create version with 20% lowest values for each variable as below the LOD
mix_data_lod_20_0 <- sim_all %>% 
  mutate(V1 = ifelse(V1 < quantile(V1, probs = .20), 0, V1)) %>% as.matrix()

# Create version with 30% lowest values for each variable as below the LOD
mix_data_lod_30_0 <- sim_all %>% 
  mutate(V1 = ifelse(V1 < quantile(V1, probs = .30), 0, V1)) %>% as.matrix()

# Create version with 40% lowest values for each variable as below the LOD
mix_data_lod_40_0 <- sim_all %>% 
  mutate(V1 = ifelse(V1 < quantile(V1, probs = .40), 0, V1)) %>% as.matrix()

# Create version with 50% lowest values for each variable as below the LOD
mix_data_lod_50_0 <- sim_all %>% 
  mutate(V1 = ifelse(V1 < quantile(V1, probs = .50), 0, V1)) %>% as.matrix()
```

```{r, above_below}
# BELOW LOD
# TRUE = <LOD
tf_lod_0 <- sim_all[,1] %>% 
  as_tibble() %>% 
  mutate_all(function(x) ifelse(x == -1, TRUE, FALSE))
l_blod_0 <- as.matrix(tf_lod_0*L_lod0[,1])
s_blod_0 <- as.matrix(tf_lod_0*S_lod0[,1])
blod_0 <- as.matrix(sim_all[,1]*tf_lod_0)

tf_lod_10 <- mix_data_lod_10[,1] %>% 
  as_tibble() %>%
  mutate_all(function(x) ifelse(x == -1, TRUE, FALSE))
l_blod_10 <- as.matrix(tf_lod_10*L_lod10[,1])
s_blod_10 <- as.matrix(tf_lod_10*S_lod10[,1])
blod_10 <- as.matrix(sim_all[,1]*tf_lod_10)

tf_lod_20 <- mix_data_lod_20[,1] %>% 
  as_tibble() %>% 
  mutate_all(function(x) ifelse(x == -1, TRUE, FALSE))
l_blod_20 <- as.matrix(tf_lod_20*L_lod20[,1])
s_blod_20 <- as.matrix(tf_lod_20*S_lod20[,1])
blod_20 <- as.matrix(sim_all[,1]*tf_lod_20)

tf_lod_30 <- mix_data_lod_30[,1] %>% 
  as_tibble() %>% 
  mutate_all(function(x) ifelse(x == -1, TRUE, FALSE))
l_blod_30 <- as.matrix(tf_lod_30*L_lod30[,1])
s_blod_30 <- as.matrix(tf_lod_30*S_lod30[,1])
blod_30 <- as.matrix(sim_all[,1]*tf_lod_30)

tf_lod_40 <- mix_data_lod_40[,1] %>% 
  as_tibble() %>% 
  mutate_all(function(x) ifelse(x == -1, TRUE, FALSE))
l_blod_40 <- as.matrix(tf_lod_40*L_lod40[,1])
s_blod_40 <- as.matrix(tf_lod_40*S_lod40[,1])
blod_40 <- as.matrix(sim_all[,1]*tf_lod_40)

tf_lod_50 <- mix_data_lod_50[,1] %>% 
  as_tibble() %>% 
  mutate_all(function(x) ifelse(x == -1, TRUE, FALSE))
l_blod_50 <- as.matrix(tf_lod_50*L_lod50[,1])
s_blod_50 <- as.matrix(tf_lod_50*S_lod50[,1])
blod_50 <- as.matrix(sim_all[,1]*tf_lod_50) 

norm_vec <- function(x) sqrt(sum(x^2))

#Subtract true values and divide by norm of true
less_diff <- as_tibble(cbind(`0%` = norm_vec(blod_0 - l_blod_0 - s_blod_0), #/norm((mix), type = "F"),
      `10%` = norm_vec(blod_10 - l_blod_10 - s_blod_10), #/norm((blod_10), type = "F"),
      `20%` = norm_vec(blod_20 - l_blod_20 - s_blod_20)/norm((blod_20)),
      `30%` = norm_vec(blod_30 - l_blod_30 - s_blod_30)/norm((blod_30)),
      `40%` = norm_vec(blod_40 - l_blod_40 - s_blod_40)/norm((blod_40)),
      `50%` = norm_vec(blod_50 - l_blod_50 - s_blod_50)/norm((blod_50)))) %>% 
  gather(Percent, norm) %>% 
  mutate(Values = "< LOD",
         Method = "LOD PCP")

l_above_blod_0 <- as.matrix((!tf_lod_0)*L_lod0[,1])
s_above_blod_0 <- as.matrix((!tf_lod_0)*S_lod0[,1])

l_above_blod_10 <- as.matrix((!tf_lod_10)*L_lod10[,1])
s_above_blod_10 <- as.matrix((!tf_lod_10)*S_lod10[,1])

l_above_blod_20 <- as.matrix((!tf_lod_20)*L_lod20[,1])
s_above_blod_20 <- as.matrix((!tf_lod_20)*S_lod20[,1])

l_above_blod_30 <- as.matrix((!tf_lod_30)*L_lod30[,1])
s_above_blod_30 <- as.matrix((!tf_lod_30)*S_lod30[,1])

l_above_blod_40 <- as.matrix((!tf_lod_40)*L_lod40[,1])
s_above_blod_40 <- as.matrix((!tf_lod_40)*S_lod40[,1])

l_above_blod_50 <- as.matrix((!tf_lod_50)*L_lod50[,1])
s_above_blod_50 <- as.matrix((!tf_lod_50)*S_lod50[,1])

#divide by true values
# mix_data_lod_##_0 datasets replaced <LOD with zero, so use them as reference for >LOD
above_diff <- as_tibble(cbind(
  `0%`  = norm_vec(mix[,1]  - l_above_blod_0  - s_above_blod_0)/norm_vec(mix[,1]),
  `10%` = norm_vec(mix_data_lod_10_0[,1] - l_above_blod_10 - s_above_blod_10)/
    norm_vec(mix_data_lod_10_0[,1]),
  `20%` = norm_vec(mix_data_lod_20_0[,1] - l_above_blod_20 - s_above_blod_20)/
    norm_vec(mix_data_lod_20_0[,1]),
  `30%` = norm_vec(mix_data_lod_30_0[,1] - l_above_blod_30 - s_above_blod_30)/
    norm_vec(mix_data_lod_30_0[,1]),
  `40%` = norm_vec(mix_data_lod_40_0[,1] - l_above_blod_40 - s_above_blod_40)/
    norm_vec(mix_data_lod_40_0[,1]),
  `50%` = norm_vec(mix_data_lod_50_0[,1] - l_above_blod_50 - s_above_blod_50)/
    norm_vec(mix_data_lod_50_0[,1]))) %>%
  gather(Percent, norm) %>% 
  mutate(Values = "> LOD",
         Method = "LOD PCP")

L_blod_0_sqrt2 <- as.matrix(tf_lod_0*L_lod0_sqrt2[,1])
S_blod_0_sqrt2 <- as.matrix(tf_lod_0*S_lod0_sqrt2[,1])

L_blod_10_sqrt2 <- as.matrix(tf_lod_10*L_lod10_sqrt2[,1])
S_blod_10_sqrt2 <- as.matrix(tf_lod_10*S_lod10_sqrt2[,1])

L_blod_20_sqrt2 <- as.matrix(tf_lod_20*L_lod20_sqrt2[,1])
S_blod_20_sqrt2 <- as.matrix(tf_lod_20*S_lod20_sqrt2[,1])

L_blod_30_sqrt2 <- as.matrix(tf_lod_30*L_lod30_sqrt2[,1])
S_blod_30_sqrt2 <- as.matrix(tf_lod_30*S_lod30_sqrt2[,1])

L_blod_40_sqrt2 <- as.matrix(tf_lod_40*L_lod40_sqrt2[,1])
S_blod_40_sqrt2 <- as.matrix(tf_lod_40*S_lod40_sqrt2[,1])

L_blod_50_sqrt2 <- as.matrix(tf_lod_50*L_lod50_sqrt2[,1])
S_blod_50_sqrt2 <- as.matrix(tf_lod_50*S_lod50_sqrt2[,1])

less_diff_sqrt2 <- as_tibble(
  cbind(`0%`  = norm_vec(blod_0  - L_blod_0_sqrt2  - S_blod_0_sqrt2), #/norm((blod_0), type = "F"),
        `10%` = norm_vec(blod_10 - L_blod_10_sqrt2 - S_blod_10_sqrt2), #/norm((blod_10), type = "F"),
        `20%` = norm_vec(blod_20 - L_blod_20_sqrt2 - S_blod_20_sqrt2)/norm_vec(blod_20),
        `30%` = norm_vec(blod_30 - L_blod_30_sqrt2 - S_blod_30_sqrt2)/norm_vec(blod_30),
        `40%` = norm_vec(blod_40 - L_blod_40_sqrt2 - S_blod_40_sqrt2)/norm_vec(blod_40),
        `50%` = norm_vec(blod_50 - L_blod_50_sqrt2 - S_blod_50_sqrt2)/norm_vec(blod_50))) %>% 
  gather(Percent, norm) %>% 
  mutate(Values = "< LOD",
         Method = paste0("PCP w/ LOD/", intToUtf8(8730),2))

L_above_blod_0_sqrt2 <- as.matrix((!tf_lod_0)*L_lod0_sqrt2[,1])
S_above_blod_0_sqrt2 <- as.matrix((!tf_lod_0)*S_lod0_sqrt2[,1])

L_above_blod_10_sqrt2 <- as.matrix((!tf_lod_10)*L_lod10_sqrt2[,1])
S_above_blod_10_sqrt2 <- as.matrix((!tf_lod_10)*S_lod10_sqrt2[,1])

L_above_blod_20_sqrt2 <- as.matrix((!tf_lod_20)*L_lod20_sqrt2[,1])
S_above_blod_20_sqrt2 <- as.matrix((!tf_lod_20)*S_lod20_sqrt2[,1])

L_above_blod_30_sqrt2 <- as.matrix((!tf_lod_30)*L_lod30_sqrt2[,1])
S_above_blod_30_sqrt2 <- as.matrix((!tf_lod_30)*S_lod30_sqrt2[,1])

L_above_blod_40_sqrt2 <- as.matrix((!tf_lod_40)*L_lod40_sqrt2[,1])
S_above_blod_40_sqrt2 <- as.matrix((!tf_lod_40)*S_lod40_sqrt2[,1])

L_above_blod_50_sqrt2 <- as.matrix((!tf_lod_50)*L_lod50_sqrt2[,1])
S_above_blod_50_sqrt2 <- as.matrix((!tf_lod_50)*S_lod50_sqrt2[,1])

#divide by true values
above_diff_sqrt2 <- as_tibble(cbind(
  `0%`  = norm_vec(mix[,1]  - L_above_blod_0_sqrt2  - S_above_blod_0_sqrt2)/norm_vec(mix[,1]),
  `10%` = norm_vec(mix_data_lod_10_0[,1] - L_above_blod_10_sqrt2 - S_above_blod_10_sqrt2)/norm_vec(mix_data_lod_10_0[,1]),
  `20%` = norm_vec(mix_data_lod_20_0[,1] - L_above_blod_20_sqrt2 - S_above_blod_20_sqrt2)/norm_vec(mix_data_lod_20_0[,1]),
  `30%` = norm_vec(mix_data_lod_30_0[,1] - L_above_blod_30_sqrt2 - S_above_blod_30_sqrt2)/norm_vec(mix_data_lod_30_0[,1]),
  `40%` = norm_vec(mix_data_lod_40_0[,1] - L_above_blod_40_sqrt2 - S_above_blod_40_sqrt2)/norm_vec(mix_data_lod_40_0[,1]),
  `50%` = norm_vec(mix_data_lod_50_0[,1] - L_above_blod_50_sqrt2 - S_above_blod_50_sqrt2)/norm_vec(mix_data_lod_50_0[,1]))) %>% 
  gather(Percent, norm) %>% 
  mutate(Values = "> LOD",
         Method = paste0("PCP w/ LOD/", intToUtf8(8730),2))

l_above_blod_0_nnS <- as.matrix((!tf_lod_0)*L_lod0_nnS[,1])
s_above_blod_0_nnS <- as.matrix((!tf_lod_0)*S_lod0_nnS[,1])

l_above_blod_10_nnS <- as.matrix((!tf_lod_10)*L_lod10_nnS[,1])
s_above_blod_10_nnS <- as.matrix((!tf_lod_10)*S_lod10_nnS[,1])

l_above_blod_20_nnS <- as.matrix((!tf_lod_20)*L_lod20_nnS[,1])
s_above_blod_20_nnS <- as.matrix((!tf_lod_20)*S_lod20_nnS[,1])

l_above_blod_30_nnS <- as.matrix((!tf_lod_30)*L_lod30_nnS[,1])
s_above_blod_30_nnS <- as.matrix((!tf_lod_30)*S_lod30_nnS[,1])

l_above_blod_40_nnS <- as.matrix((!tf_lod_40)*L_lod40_nnS[,1])
s_above_blod_40_nnS <- as.matrix((!tf_lod_40)*S_lod40_nnS[,1])

l_above_blod_50_nnS <- as.matrix((!tf_lod_50)*L_lod50_nnS[,1])
s_above_blod_50_nnS <- as.matrix((!tf_lod_50)*S_lod50_nnS[,1])

#divide by true values
above_diff_nnS <- as_tibble(cbind(
  `0%`  = norm_vec(mix[,1]  - l_above_blod_0_nnS - s_above_blod_0_nnS)/norm_vec(mix[,1]),
  `10%` = norm_vec(mix_data_lod_10_0[,1] - l_above_blod_10_nnS - s_above_blod_10_nnS)/norm_vec(mix_data_lod_10_0[,1]),
  `20%` = norm_vec(mix_data_lod_20_0[,1] - l_above_blod_20_nnS - s_above_blod_20_nnS)/norm_vec(mix_data_lod_20_0[,1]),
  `30%` = norm_vec(mix_data_lod_30_0[,1] - l_above_blod_30_nnS - s_above_blod_30_nnS)/norm_vec(mix_data_lod_30_0[,1]),
  `40%` = norm_vec(mix_data_lod_40_0[,1] - l_above_blod_40_nnS - s_above_blod_40_nnS)/norm_vec(mix_data_lod_40_0[,1]),
  `50%` = norm_vec(mix_data_lod_50_0[,1] - l_above_blod_50_nnS - s_above_blod_50_nnS)/norm_vec(mix_data_lod_50_0[,1]))) %>% 
  gather(Percent, norm) %>% 
  mutate(Values = "> LOD",
         Method = "LOD PCP nnS")

l_blod_0_nnS <- as.matrix(tf_lod_0*L_lod0_nnS[,1])
s_blod_0_nnS <- as.matrix(tf_lod_0*S_lod0_nnS[,1])

l_blod_10_nnS <- as.matrix(tf_lod_10*L_lod10_nnS[,1])
s_blod_10_nnS <- as.matrix(tf_lod_10*S_lod10_nnS[,1])

l_blod_20_nnS <- as.matrix(tf_lod_20*L_lod20_nnS[,1])
s_blod_20_nnS <- as.matrix(tf_lod_20*S_lod20_nnS[,1])

l_blod_30_nnS <- as.matrix(tf_lod_30*L_lod30_nnS[,1])
s_blod_30_nnS <- as.matrix(tf_lod_30*S_lod30_nnS[,1])

l_blod_40_nnS <- as.matrix(tf_lod_40*L_lod40_nnS[,1])
s_blod_40_nnS <- as.matrix(tf_lod_40*S_lod40_nnS[,1])

l_blod_50_nnS <- as.matrix(tf_lod_50*L_lod50_nnS[,1])
s_blod_50_nnS <- as.matrix(tf_lod_50*S_lod50_nnS[,1])

#Subtract true values and divide by norm of true
less_diff_nnS <- as_tibble(cbind(`0%` = norm_vec(blod_0 - l_blod_0_nnS - s_blod_0_nnS), #/norm((mix), type = "F"),
      `10%` = norm_vec(blod_10 - l_blod_10_nnS - s_blod_10_nnS), #/
        # norm((blod_10), type = "F"),
      `20%` = norm_vec(blod_20 - l_blod_20_nnS - s_blod_20_nnS)/
        norm_vec(blod_20),
      `30%` = norm_vec(blod_30 - l_blod_30_nnS - s_blod_30_nnS)/
        norm_vec(blod_30),
      `40%` = norm_vec(blod_40 - l_blod_40_nnS - s_blod_40_nnS)/
        norm_vec(blod_40),
      `50%` = norm_vec(blod_50 - l_blod_50_nnS - s_blod_50_nnS)/
        norm_vec(blod_50))) %>% 
  gather(Percent, norm) %>% 
  mutate(Values = "< LOD",
         Method = "LOD PCP nnS")
```

* Values \> and \< LOD stratified
* Sum of low rank and sparse solution matrices (L \+ S) compared to simulated data (X)

```{r, fig.align = "center"}
rbind(above_diff, 
      less_diff,
      above_diff_sqrt2, 
      less_diff_sqrt2,
      above_diff_nnS,
      less_diff_nnS) %>% 
  mutate(norm = ifelse(Values == "> LOD" & Method == "LOD PCP", norm - 0.005, norm)) %>% 
  ggplot(aes(x = Percent, y = norm, group = interaction(Values, Method), color = Method)) + 
  geom_point(aes()) + geom_path(aes(linetype = Values)) + theme_bw() +
  labs(x = "Percent Below LOD", 
       y = "norm(X-L-S) / norm(X)",
       title = "Relative Error in Values < LOD & > LOD")
```



## SVD

```{r}
svd(L_lod0)$d
```

### Right singular vectors

```{r, svdv}
# Extract right singular vectors from each low rank solution matrix
V_lod0  <-  svd(L_lod0)$v[,1:2]
V_lod10 <- svd(L_lod10)$v[,1:2]
V_lod20 <- svd(L_lod20)$v[,1:2]
V_lod30 <- svd(L_lod30)$v[,1:2]
V_lod40 <- svd(L_lod40)$v[,1:2]
V_lod50 <- svd(L_lod50)$v[,1:2]

# Hack to flip singular vectos -- Use correlation
# cor(V_lod0, V_lod10)
# cor(V_lod0, V_lod20)
# cor(V_lod0, V_lod30)
# cor(V_lod0, V_lod40)
# cor(V_lod0, V_lod50)

V_diff <- as_tibble(cbind(`0%` =norm((V_lod0 - V_lod0), type = "F")/norm((V_lod0), type = "F"),
      `10%` =norm((V_lod10 - V_lod0), type = "F")/norm((V_lod0), type = "F"),
      `20%` =norm((V_lod20 - V_lod0), type = "F")/norm((V_lod0), type = "F"),
      `30%` =norm((V_lod30 - V_lod0), type = "F")/norm((V_lod0), type = "F"),
      `40%` =norm((V_lod40 - V_lod0), type = "F")/norm((V_lod0), type = "F"),
      `50%` =norm((V_lod50 - V_lod0), type = "F")/norm((V_lod0), type = "F"))) %>% 
  gather(Percent, norm) %>% 
  mutate(Method = "LOD PCP")

#V_diff

# Extract right singular vectors from each low rank solution matrix
V_lod0_sqrt2  <-  svd(L_lod0_sqrt2)$v[,1:2]
V_lod10_sqrt2 <- svd(L_lod10_sqrt2)$v[,1:2]
V_lod20_sqrt2 <- svd(L_lod20_sqrt2)$v[,1:2]
V_lod30_sqrt2 <- svd(L_lod30_sqrt2)$v[,1:2]
V_lod40_sqrt2 <- svd(L_lod40_sqrt2)$v[,1:2]
V_lod50_sqrt2 <- svd(L_lod50_sqrt2)$v[,1:2]

# cor(V_lod0_sqrt2, V_lod10_sqrt2)
# cor(V_lod0_sqrt2, V_lod20_sqrt2)
# cor(V_lod0_sqrt2, V_lod30_sqrt2)
# cor(V_lod0_sqrt2, V_lod40_sqrt2)
# cor(V_lod0_sqrt2, V_lod50_sqrt2)

V_lod40_sqrt2[,2] <- -V_lod40_sqrt2[,2]

V_diff_sqrt2 <- as_tibble(cbind(`0%` =norm((V_lod0_sqrt2 - V_lod0_sqrt2), type = "F")/norm((V_lod0_sqrt2), type = "F"),
      `10%` =norm((V_lod10_sqrt2 - V_lod0_sqrt2), type = "F")/norm((V_lod0_sqrt2), type = "F"),
      `20%` =norm((V_lod20_sqrt2 - V_lod0_sqrt2), type = "F")/norm((V_lod0_sqrt2), type = "F"),
      `30%` =norm((V_lod30_sqrt2 - V_lod0_sqrt2), type = "F")/norm((V_lod0_sqrt2), type = "F"),
      `40%` =norm((V_lod40_sqrt2 - V_lod0_sqrt2), type = "F")/norm((V_lod0_sqrt2), type = "F"),
      `50%` =norm((V_lod50_sqrt2 - V_lod0_sqrt2), type = "F")/norm((V_lod0_sqrt2), type = "F"))) %>% 
  gather(Percent, norm) %>% 
  mutate(Method = paste0("PCP w/ LOD/", intToUtf8(8730),2))

#V_diff_sqrt2

# Extract right singular vectors from each low rank solution matrix
V_lod0_nnS  <-  svd(L_lod0_nnS)$v[,1:2]
V_lod10_nnS <- svd(L_lod10_nnS)$v[,1:2]
V_lod20_nnS <- svd(L_lod20_nnS)$v[,1:2]
V_lod30_nnS <- svd(L_lod30_nnS)$v[,1:2]
V_lod40_nnS <- svd(L_lod40_nnS)$v[,1:2]
V_lod50_nnS <- svd(L_lod50_nnS)$v[,1:2]

# Hack to flip singular vectos -- Use correlation
# cor(V_lod0_nnS, V_lod10_nnS)
# cor(V_lod0_nnS, V_lod20_nnS)
# cor(V_lod0_nnS, V_lod30_nnS)
# cor(V_lod0_nnS, V_lod40_nnS)
# cor(V_lod0_nnS, V_lod50_nnS)

V_diff_nnS<- as_tibble(cbind(`0%` =norm((V_lod0_nnS - V_lod0_nnS), type = "F")/norm((V_lod0_nnS), type = "F"),
      `10%` =norm((V_lod10_nnS - V_lod0_nnS), type = "F")/norm((V_lod0_nnS), type = "F"),
      `20%` =norm((V_lod20_nnS - V_lod0_nnS), type = "F")/norm((V_lod0_nnS), type = "F"),
      `30%` =norm((V_lod30_nnS - V_lod0_nnS), type = "F")/norm((V_lod0_nnS), type = "F"),
      `40%` =norm((V_lod40_nnS - V_lod0_nnS), type = "F")/norm((V_lod0_nnS), type = "F"),
      `50%` =norm((V_lod50_nnS - V_lod0_nnS), type = "F")/norm((V_lod0_nnS), type = "F"))) %>% 
  gather(Percent, norm) %>% 
  mutate(Method = "LOD PCP nnS")

#V_diff_nnS
```

* Reference is right singular vector matrix of SVD of low rank solution matix with 0\% \<LOD

```{r, fig.align = "center"}
rbind(V_diff,
      V_diff_sqrt2,
      V_diff_nnS) %>% ggplot(aes(x = Percent, y = norm, group = Method, color = Method)) + 
  geom_point() + geom_path() + theme_bw() +
  labs(x = "Percent Below LOD", 
       y = "norm(SV - SV_lod0) / norm(SV_lod0)",
       title = "Relative Error in Low-Rank Solution Right Singular Vectors")
```

### Left singular vectors

```{r, svdu}
u_lod0  <-  svd(L_lod0)$u[,1:2]
u_lod10 <- svd(L_lod10)$u[,1:2]
u_lod20 <- svd(L_lod20)$u[,1:2]
u_lod30 <- svd(L_lod30)$u[,1:2]
u_lod40 <- svd(L_lod40)$u[,1:2]
u_lod50 <- svd(L_lod50)$u[,1:2]

u_diff <- as_tibble(cbind(`0%` =norm((u_lod0 - u_lod0), type = "F")/norm((u_lod0), type = "F"),
      `10%` =norm((u_lod10 - u_lod0), type = "F")/norm((u_lod0), type = "F"),
      `20%` =norm((u_lod20 - u_lod0), type = "F")/norm((u_lod0), type = "F"),
      `30%` =norm((u_lod30 - u_lod0), type = "F")/norm((u_lod0), type = "F"),
      `40%` =norm((u_lod40 - u_lod0), type = "F")/norm((u_lod0), type = "F"),
      `50%` =norm((u_lod50 - u_lod0), type = "F")/norm((u_lod0), type = "F"))) %>% 
  gather(Percent, norm) %>% 
mutate(Method = "LOD PCP")

# u_diff

u_lod0_sqrt2  <-  svd(L_lod0_sqrt2)$u[,1:2]
u_lod10_sqrt2 <- svd(L_lod10_sqrt2)$u[,1:2]
u_lod20_sqrt2 <- svd(L_lod20_sqrt2)$u[,1:2]
u_lod30_sqrt2 <- svd(L_lod30_sqrt2)$u[,1:2]
u_lod40_sqrt2 <- svd(L_lod40_sqrt2)$u[,1:2]
u_lod50_sqrt2 <- svd(L_lod50_sqrt2)$u[,1:2]

u_lod40_sqrt2[,2] <- -u_lod40_sqrt2[,2]

u_diff_sqrt2 <- as_tibble(cbind(`0%` =norm((u_lod0_sqrt2 - u_lod0_sqrt2), type = "F")/norm((u_lod0_sqrt2), type = "F"),
      `10%` =norm((u_lod10_sqrt2 - u_lod0_sqrt2), type = "F")/norm((u_lod0_sqrt2), type = "F"),
      `20%` =norm((u_lod20_sqrt2 - u_lod0_sqrt2), type = "F")/norm((u_lod0_sqrt2), type = "F"),
      `30%` =norm((u_lod30_sqrt2 - u_lod0_sqrt2), type = "F")/norm((u_lod0_sqrt2), type = "F"),
      `40%` =norm((u_lod40_sqrt2 - u_lod0_sqrt2), type = "F")/norm((u_lod0_sqrt2), type = "F"),
      `50%` =norm((u_lod50_sqrt2 - u_lod0_sqrt2), type = "F")/norm((u_lod0_sqrt2), type = "F"))) %>% 
  gather(Percent, norm) %>% 
  mutate(Method = paste0("PCP w/ LOD/", intToUtf8(8730),2))

u_lod0_nnS  <-  svd(L_lod0_nnS)$u[,1:2]
u_lod10_nnS <- svd(L_lod10_nnS)$u[,1:2]
u_lod20_nnS <- svd(L_lod20_nnS)$u[,1:2]
u_lod30_nnS <- svd(L_lod30_nnS)$u[,1:2]
u_lod40_nnS <- svd(L_lod40_nnS)$u[,1:2]
u_lod50_nnS <- svd(L_lod50_nnS)$u[,1:2]

u_diff_nnS<- as_tibble(cbind(`0%` =norm((u_lod0_nnS - u_lod0_nnS), type = "F")/norm((u_lod0_nnS), type = "F"),
      `10%` =norm((u_lod10_nnS - u_lod0_nnS), type = "F")/norm((u_lod0_nnS), type = "F"),
      `20%` =norm((u_lod20_nnS - u_lod0_nnS), type = "F")/norm((u_lod0_nnS), type = "F"),
      `30%` =norm((u_lod30_nnS - u_lod0_nnS), type = "F")/norm((u_lod0_nnS), type = "F"),
      `40%` =norm((u_lod40_nnS - u_lod0_nnS), type = "F")/norm((u_lod0_nnS), type = "F"),
      `50%` =norm((u_lod50_nnS - u_lod0_nnS), type = "F")/norm((u_lod0_nnS), type = "F"))) %>% 
  gather(Percent, norm) %>% 
mutate(Method = "LOD PCP nnS")

# u_diff_nnS
```

* Reference is left singular vector matrix of SVD of low rank solution matix with 0\% \<LOD

```{r, fig.align = "center"}
rbind(u_diff,
      u_diff_sqrt2,
      u_diff_nnS) %>% ggplot(aes(x = Percent, y = norm, group = Method, color = Method)) + 
  geom_point() + geom_path() + theme_bw() +
  labs(x = "Percent Below LOD", 
       y = "norm(SV - SV_lod0) / norm(SV_lod0)",
       title = "Relative Error in Low-Rank Solution Left Singular Vectors")
```

### Singular Values

```{r}
d_lod0  <- svd(L_lod0)$d[1:2]
d_lod10 <- svd(L_lod10)$d[1:2]
d_lod20 <- svd(L_lod20)$d[1:2]
d_lod30 <- svd(L_lod30)$d[1:2]
d_lod40 <- svd(L_lod40)$d[1:2]
d_lod50 <- svd(L_lod50)$d[1:2]

norm_vec <- function(x) sqrt(sum(x^2))

d_diff <- as_tibble(cbind(`0%` = norm_vec(d_lod0 - d_lod0)/norm_vec(d_lod0),
      `10%` = norm_vec(d_lod10 - d_lod0)/norm_vec(d_lod0),
      `20%` = norm_vec(d_lod20 - d_lod0)/norm_vec(d_lod0),
      `30%` = norm_vec(d_lod30 - d_lod0)/norm_vec(d_lod0),
      `40%` = norm_vec(d_lod40 - d_lod0)/norm_vec(d_lod0),
      `50%` = norm_vec(d_lod50 - d_lod0)/norm_vec(d_lod0))) %>% 
  gather(Percent, norm) %>% 
  mutate(Method = "LOD PCP")

d_lod0_sqrt2  <- svd(L_lod0_sqrt2)$d[1:2]
d_lod10_sqrt2 <- svd(L_lod10_sqrt2)$d[1:2]
d_lod20_sqrt2 <- svd(L_lod20_sqrt2)$d[1:2]
d_lod30_sqrt2 <- svd(L_lod30_sqrt2)$d[1:2]
d_lod40_sqrt2 <- svd(L_lod40_sqrt2)$d[1:2]
d_lod50_sqrt2 <- svd(L_lod50_sqrt2)$d[1:2]

d_diff_sqrt2 <- as_tibble(cbind(`0%` = norm_vec(d_lod0_sqrt2 - d_lod0_sqrt2)/norm_vec(d_lod0_sqrt2),
      `10%` = norm_vec(d_lod10_sqrt2 - d_lod0_sqrt2)/norm_vec(d_lod0_sqrt2),
      `20%` = norm_vec(d_lod20_sqrt2 - d_lod0_sqrt2)/norm_vec(d_lod0_sqrt2),
      `30%` = norm_vec(d_lod30_sqrt2 - d_lod0_sqrt2)/norm_vec(d_lod0_sqrt2),
      `40%` = norm_vec(d_lod40_sqrt2 - d_lod0_sqrt2)/norm_vec(d_lod0_sqrt2),
      `50%` = norm_vec(d_lod50_sqrt2 - d_lod0_sqrt2)/norm_vec(d_lod0_sqrt2))) %>% 
  gather(Percent, norm) %>% 
  mutate(Method = paste0("PCP w/ LOD/", intToUtf8(8730),2))

d_lod0_nnS  <- svd(L_lod0_nnS)$d[1:2]
d_lod10_nnS <- svd(L_lod10_nnS)$d[1:2]
d_lod20_nnS <- svd(L_lod20_nnS)$d[1:2]
d_lod30_nnS <- svd(L_lod30_nnS)$d[1:2]
d_lod40_nnS <- svd(L_lod40_nnS)$d[1:2]
d_lod50_nnS <- svd(L_lod50_nnS)$d[1:2]

norm_vec <- function(x) sqrt(sum(x^2))

d_diff_nnS<- as_tibble(cbind(`0%` = norm_vec(d_lod0_nnS - d_lod0_nnS)/norm_vec(d_lod0_nnS),
      `10%` = norm_vec(d_lod10_nnS - d_lod0_nnS)/norm_vec(d_lod0_nnS),
      `20%` = norm_vec(d_lod20_nnS - d_lod0_nnS)/norm_vec(d_lod0_nnS),
      `30%` = norm_vec(d_lod30_nnS - d_lod0_nnS)/norm_vec(d_lod0_nnS),
      `40%` = norm_vec(d_lod40_nnS - d_lod0_nnS)/norm_vec(d_lod0_nnS),
      `50%` = norm_vec(d_lod50_nnS - d_lod0_nnS)/norm_vec(d_lod0_nnS))) %>% 
  gather(Percent, norm) %>% 
  mutate(Method = "LOD PCP nnS")
```

* Reference is singular value vector of SVD of low rank solution matix with 0\% \<LOD

```{r, fig.align = "center"}
rbind(d_diff_sqrt2,
      d_diff,
      d_diff_nnS) %>% ggplot(aes(x = Percent, y = norm, group = Method, color = Method)) + 
  geom_point() + geom_path() + theme_bw() +
  labs(x = "Percent Below LOD", 
       y = "norm(SV - SV_lod0) / norm(SV_lod0)",
       title = "Relative Error in Low-Rank Solution Singular Values")
```



## True v. Predicted

### Viz
```{r, tp_lod1}
true_pred <- as_tibble(cbind(Simulated = mix[,1],
                          `0%` = L_lod0[,1] + S_lod0[,1],
                          `10%` = L_lod10[,1] + S_lod10[,1],
                          `20%` = L_lod20[,1] + S_lod20[,1],
                          `30%` = L_lod30[,1] + S_lod30[,1],
                          `40%` = L_lod40[,1] + S_lod40[,1],
                          `50%` = L_lod50[,1] + S_lod50[,1],
          id = 1:100)) %>% gather(key = Percent, value = Predicted, -Simulated, -id) %>% 
  mutate(LOD = c(rep(0, 100), rep(quantile(mix[,1], .10), 100),
                 rep(quantile(mix[,1], .20), 100),
                 rep(quantile(mix[,1], .30), 100),
                 rep(quantile(mix[,1], .40), 100),
                 rep(quantile(mix[,1], .50), 100)))
```

```{r, fig.align="center"}
true_pred %>% 
  ggplot(aes(x = Simulated, y = Predicted)) + 
  geom_hline(yintercept = 0, color = 'grey', linetype = 'dashed') +
  geom_rect(aes(xmin = 0, xmax = LOD, ymin = 0, ymax = LOD),
                   fill = "pink", alpha = 0.03) +
  geom_abline(intercept = 0, slope = 1, color = 'grey', linetype = 'dashed') +
  geom_point(aes(color = Percent)) +
  facet_wrap(~Percent) +
  theme_bw() + theme(legend.position = "none") +
  labs(title= "PCP-LOD Simulated v. Predicted Values (L + S) for POP V1")
```

```{r, fig.align="center"}
true_pred %>% 
  filter(Simulated <= LOD) %>% 
  ggplot(aes(x = Simulated, y = Predicted)) + 
  geom_hline(yintercept = 0, color = 'grey', linetype = 'dashed') +
  geom_rect(aes(xmin = 0, xmax = LOD, ymin = 0, ymax = LOD),
                   fill = "pink", alpha = 0.03) +
  geom_abline(intercept = 0, slope = 1, color = 'grey', linetype = 'dashed') +
  geom_point(aes(color = Percent)) +
  facet_wrap(~Percent) +
  theme_bw() + theme(legend.position = "none") +
  labs(title= "PCP-LOD Simulated v. Predicted Values (L + S) for POP V1 <LOD")
```

```{r, sqrt2_tp_lod}
true_pred_sqrt2 <- as_tibble(cbind(Simulated = mix[,1],
                          `0%` = L_lod0_sqrt2[,1] + S_lod0_sqrt2[,1],
                          `10%` = L_lod10_sqrt2[,1] + S_lod10_sqrt2[,1],
                          `20%` = L_lod20_sqrt2[,1] + S_lod20_sqrt2[,1],
                          `30%` = L_lod30_sqrt2[,1] + S_lod30_sqrt2[,1],
                          `40%` = L_lod30_sqrt2[,1] + S_lod30_sqrt2[,1],
                          `50%` = L_lod30_sqrt2[,1] + S_lod30_sqrt2[,1],
          id = 1:100)) %>% gather(key = Percent, value = Predicted, -Simulated, -id) %>% 
  mutate(LOD = c(rep(0, 100), rep(quantile(mix[,1], .10), 100),
                 rep(quantile(mix[,1], .20), 100),
                 rep(quantile(mix[,1], .30), 100),
                 rep(quantile(mix[,1], .40), 100),
                 rep(quantile(mix[,1], .50), 100)))
```

```{r, fig.align="center"}
true_pred_sqrt2 %>% 
  ggplot(aes(x = Simulated, y = Predicted)) + 
  geom_hline(yintercept = 0, color = 'grey', linetype = 'dashed') +
  geom_rect(aes(xmin = 0, xmax = LOD, ymin = 0, ymax = LOD),
                   fill = "pink", alpha = 0.03) +
  geom_abline(intercept = 0, slope = 1, color = 'grey', linetype = 'dashed') +
  geom_point(aes(color = Percent)) +
  facet_wrap(~Percent) +
  theme_bw() + theme(legend.position = "none") +
  labs(title= "Original PCP w/ LOD/sqrt(2) Simulated v. Predicted Values (L + S) for POP V1")
```

```{r, fig.align="center"}
true_pred_sqrt2 %>% 
  filter(Simulated <= LOD) %>% 
  ggplot(aes(x = Simulated, y = Predicted)) + 
  geom_hline(yintercept = 0, color = 'grey', linetype = 'dashed') +
  geom_rect(aes(xmin = 0, xmax = LOD, ymin = 0, ymax = LOD),
                   fill = "pink", alpha = 0.03) +
  geom_abline(intercept = 0, slope = 1, color = 'grey', linetype = 'dashed') +
  geom_point(aes(color = Percent)) +
  facet_wrap(~Percent) +
  theme_bw() + theme(legend.position = "none") +
  labs(title= "Original PCP w/ LOD/sqrt(2) Simulated v. Predicted Values (L + S) for POP V1 <LOD")
```

```{r, nns_tp_lod}
true_pred_nnS <- as_tibble(cbind(Simulated = mix[,1],
                          `0%` = L_lod0_nnS[,1] + S_lod0_nnS[,1],
                          `10%` = L_lod10_nnS[,1] + S_lod10_nnS[,1],
                          `20%` = L_lod20_nnS[,1] + S_lod20_nnS[,1],
                          `30%` = L_lod30_nnS[,1] + S_lod30_nnS[,1],
                          `40%` = L_lod30_nnS[,1] + S_lod30_nnS[,1],
                          `50%` = L_lod30_nnS[,1] + S_lod30_nnS[,1],
          id = 1:100)) %>% gather(key = Percent, value = Predicted, -Simulated, -id) %>% 
  mutate(LOD = c(rep(0, 100), rep(quantile(mix[,1], .10), 100),
                 rep(quantile(mix[,1], .20), 100),
                 rep(quantile(mix[,1], .30), 100),
                 rep(quantile(mix[,1], .40), 100),
                 rep(quantile(mix[,1], .50), 100)))
```

```{r, fig.align="center"}
true_pred_nnS %>% 
  ggplot(aes(x = Simulated, y = Predicted)) + 
  geom_hline(yintercept = 0, color = 'grey', linetype = 'dashed') +
  geom_rect(aes(xmin = 0, xmax = LOD, ymin = 0, ymax = LOD),
                   fill = "pink", alpha = 0.03) +
  geom_abline(intercept = 0, slope = 1, color = 'grey', linetype = 'dashed') +
  geom_point(aes(color = Percent)) +
  facet_wrap(~Percent) +
  theme_bw() + theme(legend.position = "none") +
  labs(title= "nnS PCP-LOD Simulated v. Predicted Values (L + S) for POP V1")
```

```{r, fig.align="center"}
true_pred_nnS %>% 
  filter(Simulated <= LOD) %>% 
  ggplot(aes(x = Simulated, y = Predicted)) + 
  geom_hline(yintercept = 0, color = 'grey', linetype = 'dashed') +
  geom_rect(aes(xmin = 0, xmax = LOD, ymin = 0, ymax = LOD),
                   fill = "pink", alpha = 0.03) +
  geom_abline(intercept = 0, slope = 1, color = 'grey', linetype = 'dashed') +
  geom_point(aes(color = Percent)) +
  facet_wrap(~Percent) +
  theme_bw() + theme(legend.position = "none") +
  labs(title= "nnS PCP-LOD Simulated v. Predicted Values (L + S) for POP V1 <LOD")
```

## Relative Error

### PCP-LOD
#### V1

```{r, relerror, echo=FALSE}
### <LOD
pcp_pred1 <- true_pred %>%
  filter(Simulated < LOD) %>% 
  mutate(l2 = (Simulated - Predicted)^2,
         l1 = abs(Simulated - Predicted)) %>%
  group_by(Percent) %>% 
           summarise(Fro = round(sqrt(sum(l2))/sqrt(sum(Simulated^2)),2),
                     l1 = round(sqrt(sum(l1))/sqrt(sum(Simulated)),2),
                     linf = round(max(l1)/max(Simulated),2)) %>% 
  mutate(Group = "V1 <LOD",
         Method = "PCP-LOD")

pcp_pred1 %>% 
  select(-Group, -Method) %>% 
  kable(caption = "PCP-LOD Relative Error in V1 <LOD")

### Overall
pcp_pred2 <- true_pred %>%
  mutate(l2 = (Simulated - Predicted)^2,
         l1 = abs(Simulated - Predicted)) %>%
  group_by(Percent) %>% 
           summarise(Fro = round(sqrt(sum(l2))/sqrt(sum(Simulated^2)),2),
                     l1 = round(sqrt(sum(l1))/sqrt(sum(Simulated)),2),
                     linf = round(max(l1)/max(Simulated),2)) %>% 
  mutate(Group = "All V1",
         Method = "PCP-LOD")

pcp_pred2 %>% 
  select(-Group, -Method) %>% 
  kable(caption = "PCP-LOD Relative Error in All V1")

### >LOD
pcp_pred3 <- true_pred %>%
  filter(Simulated >= LOD) %>% 
  mutate(l2 = (Simulated - Predicted)^2,
         l1 = abs(Simulated - Predicted)) %>%
  group_by(Percent) %>% 
           summarise(Fro = round(sqrt(sum(l2))/sqrt(sum(Simulated^2)),2),
                     l1 = round(sqrt(sum(l1))/sqrt(sum(Simulated)),2),
                     linf = round(max(l1)/max(Simulated),2)) %>% 
  mutate(Group = "V1 >LOD",
         Method = "PCP-LOD")

pcp_pred3 %>% 
  select(-Group, -Method) %>% 
  kable(caption = "PCP-LOD Relative Error in V1 >LOD")
```

#### All

```{r, makeall, include=FALSE}
pcp_pred_sim <- sim_all %>% 
  mutate(id = 1:100) %>% 
  pivot_longer(cols = V1:V10,
               names_to = "Variable",
               values_to = "Simulated")

add_lods <- as_tibble(rbind(c("0%",0), 
      c("10%", quantile(mix[,1], .10)), 
      c("20%", quantile(mix[,1], .20)),
      c("30%", quantile(mix[,1], .30)), 
      c("40%", quantile(mix[,1], .40)),
      c("50%", quantile(mix[,1], .50)))) %>% rename(Percent = 1, LOD = 2) %>% 
  mutate(LOD = as.numeric(LOD),
         Variable = "V1")

pcp_pred_all <- (L_lod0 + S_lod0) %>% as_tibble() %>% mutate(Percent = "0%") %>% 
  rbind(., (L_lod10 + S_lod10) %>% as_tibble() %>% mutate(Percent = "10%")) %>% 
  rbind(., (L_lod20 + S_lod20) %>% as_tibble() %>% mutate(Percent = "20%")) %>% 
  rbind(., (L_lod30 + S_lod30) %>% as_tibble() %>% mutate(Percent = "30%")) %>% 
  rbind(., (L_lod40 + S_lod40) %>% as_tibble() %>% mutate(Percent = "40%")) %>% 
  rbind(., (L_lod50 + S_lod50) %>% as_tibble() %>% mutate(Percent = "50%")) %>%
  mutate(id = rep(1:100, 6)) %>% 
  pivot_longer(cols = V1:V10,
               names_to = "Variable",
               values_to = "Predicted") %>% 
  left_join(., pcp_pred_sim, by = c("id", "Variable")) %>% 
  left_join(., add_lods, by = c("Percent", "Variable")) %>% 
  replace_na(list(LOD = 0))
```

```{r, allerror, echo=FALSE}
### <LOD are only V1

### Overall
pcp_pred4 <- pcp_pred_all %>%
  mutate(l2 = (Simulated - Predicted)^2,
         l1 = abs(Simulated - Predicted)) %>%
  group_by(Percent) %>% 
           summarise(Fro = round(sqrt(sum(l2))/sqrt(sum(Simulated^2)),2),
                     l1 = round(sqrt(sum(l1))/sqrt(sum(Simulated)),2),
                     linf = round(max(l1)/max(Simulated),2)) %>% 
  mutate(Group = "Overall",
         Method = "PCP-LOD") %>% 
  select(Group, everything())

pcp_pred4 %>% 
  select(-Group, -Method) %>% 
  kable(caption = "PCP-LOD Overall Relative Error")

### >LOD
pcp_pred5 <- pcp_pred_all %>%
  filter(Simulated >= LOD) %>% 
  mutate(l2 = (Simulated - Predicted)^2,
         l1 = abs(Simulated - Predicted)) %>%
  group_by(Percent) %>% 
           summarise(Fro = round(sqrt(sum(l2))/sqrt(sum(Simulated^2)),2),
                     l1 = round(sqrt(sum(l1))/sqrt(sum(Simulated)),2),
                     linf = round(max(l1)/max(Simulated),2)) %>% 
  mutate(Group = "All >LOD",
         Method = "PCP-LOD") %>% 
  select(Group, everything())

pcp_pred5 %>% 
  select(-Group, -Method) %>%   
  kable(caption = "Relative Error in All >LOD")
```


### PCP w/ LOD/sqrt2

#### V1

```{r, relerror1, echo=FALSE}
### <LOD
pcp_pred_sqrt21 <- true_pred_sqrt2 %>%
  filter(Simulated < LOD) %>% 
  mutate(l2 = (Simulated - Predicted)^2,
         l1 = abs(Simulated - Predicted)) %>%
  group_by(Percent) %>% 
  summarise(Fro = round(sqrt(sum(l2))/sqrt(sum(Simulated^2)),2),
            l1 = round(sqrt(sum(l1))/sqrt(sum(Simulated)),2),
            linf = round(max(l1)/max(Simulated),2)) %>% 
  mutate(Group = "V1 <LOD",
         Method = "LOD/sqrt(2)")

pcp_pred_sqrt21 %>% 
  select(-Group, -Method) %>% 
  kable(caption = "LOD/sqrt(2) Relative Error in V1 <LOD")

### Overall
pcp_pred_sqrt22 <- true_pred_sqrt2 %>%
  mutate(l2 = (Simulated - Predicted)^2,
         l1 = abs(Simulated - Predicted)) %>%
  group_by(Percent) %>% 
  summarise(Fro = round(sqrt(sum(l2))/sqrt(sum(Simulated^2)),2),
            l1 = round(sqrt(sum(l1))/sqrt(sum(Simulated)),2),
            linf = round(max(l1)/max(Simulated),2)) %>% 
  mutate(Group = "All V1",
         Method = "LOD/sqrt(2)")

pcp_pred_sqrt22 %>% 
  select(-Group, -Method) %>% 
  kable(caption = "LOD/sqrt(2) Relative Error in All V1")

### >LOD
pcp_pred_sqrt23 <- true_pred_sqrt2 %>%
  filter(Simulated >= LOD) %>% 
  mutate(l2 = (Simulated - Predicted)^2,
         l1 = abs(Simulated - Predicted)) %>%
  group_by(Percent) %>% 
  summarise(Fro = round(sqrt(sum(l2))/sqrt(sum(Simulated^2)),2),
            l1 = round(sqrt(sum(l1))/sqrt(sum(Simulated)),2),
            linf = round(max(l1)/max(Simulated),2)) %>% 
  mutate(Group = "V1 >LOD",
         Method = "LOD/sqrt(2)")

pcp_pred_sqrt23 %>% 
  select(-Group, -Method) %>% 
  kable(caption = "LOD/sqrt(2) Relative Error in V1 >LOD")
```

#### All

```{r, makeall1, include=FALSE}
pcp_pred_sqrt2 <- (L_lod0_sqrt2 + S_lod0_sqrt2) %>% as_tibble() %>% mutate(Percent = "0%") %>% 
  rbind(., (L_lod10_sqrt2 + S_lod10_sqrt2) %>% as_tibble() %>% mutate(Percent = "10%")) %>% 
  rbind(., (L_lod20_sqrt2 + S_lod20_sqrt2) %>% as_tibble() %>% mutate(Percent = "20%")) %>% 
  rbind(., (L_lod30_sqrt2 + S_lod30_sqrt2) %>% as_tibble() %>% mutate(Percent = "30%")) %>% 
  rbind(., (L_lod40_sqrt2 + S_lod40_sqrt2) %>% as_tibble() %>% mutate(Percent = "40%")) %>% 
  rbind(., (L_lod50_sqrt2 + S_lod50_sqrt2) %>% as_tibble() %>% mutate(Percent = "50%")) %>%
  mutate(id = rep(1:100, 6)) %>% 
  pivot_longer(cols = V1:V10,
               names_to = "Variable",
               values_to = "Predicted") %>% 
  left_join(., pcp_pred_sim, by = c("id", "Variable")) %>% 
  left_join(., add_lods, by = c("Percent", "Variable")) %>% 
  replace_na(list(LOD = 0))
```

```{r, allerror1, echo=FALSE}
### <LOD are only V1

### Overall
pcp_pred_sqrt24 <- pcp_pred_sqrt2 %>%
  mutate(l2 = (Simulated - Predicted)^2,
         l1 = abs(Simulated - Predicted)) %>%
  group_by(Percent) %>% 
  summarise(Fro = round(sqrt(sum(l2))/sqrt(sum(Simulated^2)),2),
            l1 = round(sqrt(sum(l1))/sqrt(sum(Simulated)),2),
            linf = round(max(l1)/max(Simulated),2)) %>% 
  mutate(Group = "Overall",
         Method = "LOD/sqrt(2)") %>% 
  select(Group, everything())

pcp_pred_sqrt24 %>% 
  select(-Group, -Method) %>% 
  kable(caption = "LOD/sqrt(2) Overall Relative Error")

### >LOD
pcp_pred_sqrt25 <- pcp_pred_sqrt2 %>%
  filter(Simulated >= LOD) %>% 
  mutate(l2 = (Simulated - Predicted)^2,
         l1 = abs(Simulated - Predicted)) %>%
  group_by(Percent) %>% 
  summarise(Fro = round(sqrt(sum(l2))/sqrt(sum(Simulated^2)),2),
            l1 = round(sqrt(sum(l1))/sqrt(sum(Simulated)),2),
            linf = round(max(l1)/max(Simulated),2)) %>% 
  mutate(Group = "All >LOD",
         Method = "LOD/sqrt(2)") %>% 
  select(Group, everything())

pcp_pred_sqrt25 %>% 
  select(-Group, -Method) %>%   
  kable(caption = "Relative Error in All >LOD")
```

### nnS PCP-LOD

#### V1

```{r, relerror1, echo=FALSE}
### <LOD
pcp_pred_nnS1 <- true_pred_nnS %>%
  filter(Simulated < LOD) %>% 
  mutate(l2 = (Simulated - Predicted)^2,
         l1 = abs(Simulated - Predicted)) %>%
  group_by(Percent) %>% 
  summarise(Fro = round(sqrt(sum(l2))/sqrt(sum(Simulated^2)),2),
            l1 = round(sqrt(sum(l1))/sqrt(sum(Simulated)),2),
            linf = round(max(l1)/max(Simulated),2)) %>% 
  mutate(Group = "V1 <LOD",
         Method = "nnS PCP-LOD")

pcp_pred_nnS1 %>% 
  select(-Group, -Method) %>% 
  kable(caption = "nnS PCP-LOD Relative Error in V1 <LOD")

### Overall
pcp_pred_nnS2 <- true_pred_nnS %>%
  mutate(l2 = (Simulated - Predicted)^2,
         l1 = abs(Simulated - Predicted)) %>%
  group_by(Percent) %>% 
  summarise(Fro = round(sqrt(sum(l2))/sqrt(sum(Simulated^2)),2),
            l1 = round(sqrt(sum(l1))/sqrt(sum(Simulated)),2),
            linf = round(max(l1)/max(Simulated),2)) %>% 
  mutate(Group = "All V1",
         Method = "nnS PCP-LOD")

pcp_pred_nnS2 %>% 
  select(-Group, -Method) %>% 
  kable(caption = "nnS PCP-LOD Relative Error in All V1")

### >LOD
pcp_pred_nnS3 <- true_pred_nnS %>%
  filter(Simulated >= LOD) %>% 
  mutate(l2 = (Simulated - Predicted)^2,
         l1 = abs(Simulated - Predicted)) %>%
  group_by(Percent) %>% 
  summarise(Fro = round(sqrt(sum(l2))/sqrt(sum(Simulated^2)),2),
            l1 = round(sqrt(sum(l1))/sqrt(sum(Simulated)),2),
            linf = round(max(l1)/max(Simulated),2)) %>% 
  mutate(Group = "V1 >LOD",
         Method = "nnS PCP-LOD")

pcp_pred_nnS3 %>% 
  select(-Group, -Method) %>% 
  kable(caption = "nnS PCP-LOD Relative Error in V1 >LOD")
```

#### All

```{r, makeall1, include=FALSE}
pcp_pred_nnS <- (L_lod0_nnS + S_lod0_nnS) %>% as_tibble() %>% mutate(Percent = "0%") %>% 
  rbind(., (L_lod10_nnS + S_lod10_nnS) %>% as_tibble() %>% mutate(Percent = "10%")) %>% 
  rbind(., (L_lod20_nnS + S_lod20_nnS) %>% as_tibble() %>% mutate(Percent = "20%")) %>% 
  rbind(., (L_lod30_nnS + S_lod30_nnS) %>% as_tibble() %>% mutate(Percent = "30%")) %>% 
  rbind(., (L_lod40_nnS + S_lod40_nnS) %>% as_tibble() %>% mutate(Percent = "40%")) %>% 
  rbind(., (L_lod50_nnS + S_lod50_nnS) %>% as_tibble() %>% mutate(Percent = "50%")) %>%
  mutate(id = rep(1:100, 6)) %>% 
  pivot_longer(cols = V1:V10,
               names_to = "Variable",
               values_to = "Predicted") %>% 
  left_join(., pcp_pred_sim, by = c("id", "Variable")) %>% 
  left_join(., add_lods, by = c("Percent", "Variable")) %>% 
  replace_na(list(LOD = 0))
```

```{r, allerror1, echo=FALSE}
### <LOD are only V1

### Overall
pcp_pred_nnS4 <- pcp_pred_nnS %>%
  mutate(l2 = (Simulated - Predicted)^2,
         l1 = abs(Simulated - Predicted)) %>%
  group_by(Percent) %>% 
  summarise(Fro = round(sqrt(sum(l2))/sqrt(sum(Simulated^2)),2),
            l1 = round(sqrt(sum(l1))/sqrt(sum(Simulated)),2),
            linf = round(max(l1)/max(Simulated),2)) %>% 
  mutate(Group = "Overall",
         Method = "nnS PCP-LOD") %>% 
  select(Group, everything())

pcp_pred_nnS4 %>% 
  select(-Group, -Method) %>% 
  kable(caption = "nnS PCP-LOD Overall Relative Error")

### >LOD
pcp_pred_nnS5 <- pcp_pred_nnS %>%
  filter(Simulated >= LOD) %>% 
  mutate(l2 = (Simulated - Predicted)^2,
         l1 = abs(Simulated - Predicted)) %>%
  group_by(Percent) %>% 
  summarise(Fro = round(sqrt(sum(l2))/sqrt(sum(Simulated^2)),2),
            l1 = round(sqrt(sum(l1))/sqrt(sum(Simulated)),2),
            linf = round(max(l1)/max(Simulated),2)) %>% 
  mutate(Group = "All >LOD",
         Method = "nnS PCP-LOD") %>% 
  select(Group, everything())

pcp_pred_nnS5 %>% 
  select(-Group, -Method) %>%   
  kable(caption = "Relative Error in All >LOD")
```

### Viz

```{r, fig.align = "center", echo = FALSE}
rbind(pcp_pred1, pcp_pred2, pcp_pred3, pcp_pred5, pcp_pred4,
      pcp_pred_nnS1, pcp_pred_nnS2, pcp_pred_nnS3, pcp_pred_nnS5, pcp_pred_nnS4,
      pcp_pred_sqrt21, pcp_pred_sqrt22, pcp_pred_sqrt23, pcp_pred_sqrt25, pcp_pred_sqrt24) %>% 
  ggplot(aes(x = Percent, y = Fro, group= interaction(Group, Method), color = Method)) + 
  geom_point(aes()) + geom_path(aes(linetype = Group)) + theme_bw() +
  labs(x = "Percent Below LOD", y = "Relative Norm",
       title = "Relative Frobenius Error")
```

```{r, fig.align = "center", echo = FALSE}
rbind(pcp_pred1, pcp_pred2, pcp_pred3, pcp_pred5, pcp_pred4,
      pcp_pred_nnS1, pcp_pred_nnS2, pcp_pred_nnS3, pcp_pred_nnS5, pcp_pred_nnS4,
      pcp_pred_sqrt21, pcp_pred_sqrt22, pcp_pred_sqrt23, pcp_pred_sqrt25, pcp_pred_sqrt24) %>% 
  ggplot(aes(x = Percent, y = l1, group= interaction(Group, Method), color = Method)) + 
  geom_point(aes()) + geom_path(aes(linetype = Group)) + theme_bw() +
  labs(x = "Percent Below LOD", y = "Relative Norm",
       title = "Relative L1 Error")
```

## Values \<LOD

```{r, l22s, include=FALSE}
t_na_lod_0 <- sim_all[,1] %>% 
  as_tibble() %>% 
  mutate_all(function(x) ifelse(x == -1, TRUE, NA))
l_blod_0_na <- as_tibble(t_na_lod_0*L_lod0[,1])
s_blod_0_na <- as_tibble(t_na_lod_0*S_lod0[,1])
blod_0_na <- as_tibble(sim_all[,1]*t_na_lod_0)

t_na_lod_10 <- mix_data_lod_10[,1] %>% 
  as_tibble() %>%
  mutate_all(function(x) ifelse(x == -1, TRUE, NA))
l_blod_10_na <- as_tibble(t_na_lod_10*L_lod10[,1])
s_blod_10_na <- as_tibble(t_na_lod_10*S_lod10[,1])
blod_10_na <- as_tibble(sim_all[,1]*t_na_lod_10)

t_na_lod_20 <- mix_data_lod_20[,1] %>% 
  as_tibble() %>% 
  mutate_all(function(x) ifelse(x == -1, TRUE, NA))
l_blod_20_na <- as_tibble(t_na_lod_20*L_lod20[,1])
s_blod_20_na <- as_tibble(t_na_lod_20*S_lod20[,1])
blod_20_na <- as_tibble(sim_all[,1]*t_na_lod_20)

t_na_lod_30 <- mix_data_lod_30[,1] %>% 
  as_tibble() %>% 
  mutate_all(function(x) ifelse(x == -1, TRUE, NA))
l_blod_30_na <- as_tibble(t_na_lod_30*L_lod30[,1])
s_blod_30_na <- as_tibble(t_na_lod_30*S_lod30[,1])
blod_30_na <- as_tibble(sim_all[,1]*t_na_lod_30)

t_na_lod_40 <- mix_data_lod_40[,1] %>% 
  as_tibble() %>% 
  mutate_all(function(x) ifelse(x == -1, TRUE, NA))
l_blod_40_na <- as_tibble(t_na_lod_40*L_lod40[,1])
s_blod_40_na <- as_tibble(t_na_lod_40*S_lod40[,1])
blod_40_na <- as_tibble(sim_all[,1]*t_na_lod_40)

t_na_lod_50 <- mix_data_lod_50[,1] %>% 
  as_tibble() %>% 
  mutate_all(function(x) ifelse(x == -1, TRUE, NA))
l_blod_50_na <- as_tibble(t_na_lod_50*L_lod50[,1])
s_blod_50_na <- as_tibble(t_na_lod_50*S_lod50[,1])
blod_50_na <- as_tibble(sim_all[,1]*t_na_lod_50) 

L_blod_0_sqrt2_na <- as_tibble(t_na_lod_0*L_lod0_sqrt2[,1])
S_blod_0_sqrt2_na <- as_tibble(t_na_lod_0*S_lod0_sqrt2[,1])

L_blod_10_sqrt2_na <- as_tibble(t_na_lod_10*L_lod10_sqrt2[,1])
S_blod_10_sqrt2_na <- as_tibble(t_na_lod_10*S_lod10_sqrt2[,1])

L_blod_20_sqrt2_na <- as_tibble(t_na_lod_20*L_lod20_sqrt2[,1])
S_blod_20_sqrt2_na <- as_tibble(t_na_lod_20*S_lod20_sqrt2[,1])

L_blod_30_sqrt2_na <- as_tibble(t_na_lod_30*L_lod30_sqrt2[,1])
S_blod_30_sqrt2_na <- as_tibble(t_na_lod_30*S_lod30_sqrt2[,1])

L_blod_40_sqrt2_na <- as_tibble(t_na_lod_40*L_lod40_sqrt2[,1])
S_blod_40_sqrt2_na <- as_tibble(t_na_lod_40*S_lod40_sqrt2[,1])

L_blod_50_sqrt2_na <- as_tibble(t_na_lod_50*L_lod50_sqrt2[,1])
S_blod_50_sqrt2_na <- as_tibble(t_na_lod_50*S_lod50_sqrt2[,1])

LOD10 <- delta10[1]
LOD20 <- delta20[1]
LOD30 <- delta30[1]
LOD40 <- delta40[1]
LOD50 <- delta50[1]
LOD <- as_tibble(rbind(LOD10, LOD20, LOD30, LOD40, LOD50)) %>% rename(LOD = 1)
LODall <- cbind(Percent = rownames(rbind(LOD10, LOD20, LOD30, LOD40, LOD50)), LOD) %>% as_tibble() %>% 
  mutate(Percent = as.character(Percent))

plot_10 <- blod_10_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Original, -rowid) %>% mutate(Percent = "LOD10")
plotl_10 <- l_blod_10_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Low Rank Solution", Percent = "LOD10") %>% left_join(., plot_10, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plots_10 <- s_blod_10_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Sparse Solution", Percent = "LOD10") %>% left_join(., plot_10, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plotall_10 <- (l_blod_10_na + s_blod_10_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Model Prediction", Percent = "LOD10") %>% left_join(., plot_10, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))

plot_20 <- blod_20_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Original, -rowid) %>% mutate(Percent = "LOD20") 
plotl_20 <- l_blod_20_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Low Rank Solution", Percent = "LOD20") %>% left_join(., plot_20, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plots_20 <- s_blod_20_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Sparse Solution", Percent = "LOD20") %>% left_join(., plot_20, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plotall_20 <- (l_blod_20_na + s_blod_20_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Model Prediction", Percent = "LOD20") %>% left_join(., plot_20, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent")) 

plot_30 <- blod_30_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Original, -rowid) %>% mutate(Percent = "LOD30")
plotl_30 <- l_blod_30_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Low Rank Solution", Percent = "LOD30") %>% left_join(., plot_30, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plots_30 <- s_blod_30_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Sparse Solution", Percent = "LOD30") %>% left_join(., plot_30, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent")) 
plotall_30 <- (l_blod_30_na + s_blod_30_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Model Prediction", Percent = "LOD30") %>% left_join(., plot_30, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent")) 

plot_40 <- blod_40_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Original, -rowid) %>% mutate(Percent = "LOD40") 
plotl_40 <- l_blod_40_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Low Rank Solution", Percent = "LOD40") %>% left_join(., plot_40, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plots_40 <- s_blod_40_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Sparse Solution", Percent = "LOD40") %>% left_join(., plot_40, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plotall_40 <- (l_blod_40_na + s_blod_40_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Model Prediction", Percent = "LOD40") %>% left_join(., plot_40, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))

### Merging isn't working // POP = value for all instead of V1--V10 --- fixed
plot_50 <- blod_50_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Original, -rowid) %>% mutate(Percent = "LOD50") 
plotl_50 <- l_blod_50_na %>% as_tibble(.) %>% rowid_to_column(.) %>% 
  mutate(Compare = "Low Rank Solution", Percent = "LOD50") %>% left_join(., plot_50, by = c("rowid", "Percent")) %>% 
  left_join(., LODall, by = c("Percent"))
plots_50 <- s_blod_50_na %>% as_tibble(.) %>% rowid_to_column(.) %>% 
  mutate(Compare = "Sparse Solution", Percent = "LOD50") %>% left_join(., plot_50, by = c("rowid", "Percent")) %>%
  left_join(., LODall, by = c("Percent")) 
plotall_50 <- (l_blod_50_na + s_blod_50_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% 
  mutate(Compare = "Model Prediction", Percent = "LOD50") %>% left_join(., plot_50, by = c("rowid", "Percent")) %>% 
  left_join(., LODall, by = c("Percent"))

org <- rbind(plot_10,
        plot_20,
        plot_30,
        plot_40,
        plot_50) %>% rename(Value = Original) %>% 
  mutate(Compare = "Original") %>% 
  left_join(., LODall, by = c("Percent"))

plotall <- rbind(plotl_10,
      plots_10,
      plotall_10,
      plotl_20,
      plots_20,
      plotall_20,
      plotl_30,
      plots_30,
      plotall_30, 
      plotl_40,
      plots_40,
      plotall_40,
      plotl_50,
      plots_50,
      plotall_50)

l_blod_0_nnS_na <- as_tibble(t_na_lod_0*L_lod0_nnS)
s_blod_0_nnS_na <- as_tibble(t_na_lod_0*S_lod0_nnS)

l_blod_10_nnS_na <- as_tibble(t_na_lod_10*L_lod10_nnS)
s_blod_10_nnS_na <- as_tibble(t_na_lod_10*S_lod10_nnS)

l_blod_20_nnS_na <- as_tibble(t_na_lod_20*L_lod20_nnS)
s_blod_20_nnS_na <- as_tibble(t_na_lod_20*S_lod20_nnS)

l_blod_30_nnS_na <- as_tibble(t_na_lod_30*L_lod30_nnS)
s_blod_30_nnS_na <- as_tibble(t_na_lod_30*S_lod30_nnS)

l_blod_40_nnS_na <- as_tibble(t_na_lod_40*L_lod40_nnS)
s_blod_40_nnS_na <- as_tibble(t_na_lod_40*S_lod40_nnS)

l_blod_50_nnS_na <- as_tibble(t_na_lod_50*L_lod50_nnS)
s_blod_50_nnS_na <- as_tibble(t_na_lod_50*S_lod50_nnS)

plotl_10_nnS <- l_blod_10_nnS_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Low Rank Solution", Percent = "LOD10") %>% left_join(., plot_10, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plots_10_nnS <- s_blod_10_nnS_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Sparse Solution", Percent = "LOD10") %>% left_join(., plot_10, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plotall_10_nnS <- (l_blod_10_nnS_na + s_blod_10_nnS_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Model Prediction", Percent = "LOD10") %>% left_join(., plot_10, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))

plotl_20_nnS <- l_blod_20_nnS_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Low Rank Solution", Percent = "LOD20") %>% left_join(., plot_20, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plots_20_nnS <- s_blod_20_nnS_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Sparse Solution", Percent = "LOD20") %>% left_join(., plot_20, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plotall_20_nnS <- (l_blod_20_nnS_na + s_blod_20_nnS_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Model Prediction", Percent = "LOD20") %>% left_join(., plot_20, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent")) 

plotl_30_nnS <- l_blod_30_nnS_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Low Rank Solution", Percent = "LOD30") %>% left_join(., plot_30, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plots_30_nnS <- s_blod_30_nnS_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Sparse Solution", Percent = "LOD30") %>% left_join(., plot_30, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent")) 
plotall_30_nnS <- (l_blod_30_nnS_na + s_blod_30_nnS_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Model Prediction", Percent = "LOD30") %>% left_join(., plot_30, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent")) 

plotl_40_nnS <- l_blod_40_nnS_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Low Rank Solution", Percent = "LOD40") %>% left_join(., plot_40, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plots_40_nnS <- s_blod_40_nnS_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Sparse Solution", Percent = "LOD40") %>% left_join(., plot_40, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plotall_40_nnS <- (l_blod_40_nnS_na + s_blod_40_nnS_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Model Prediction", Percent = "LOD40") %>% left_join(., plot_40, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))

plotl_50_nnS <- l_blod_50_nnS_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Low Rank Solution", Percent = "LOD50") %>% left_join(., plot_50, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plots_50_nnS <- s_blod_50_nnS_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Sparse Solution", Percent = "LOD50") %>% left_join(., plot_50, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent")) 
plotall_50_nnS <- (l_blod_50_nnS_na + s_blod_50_nnS_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Model Prediction", Percent = "LOD50") %>% left_join(., plot_50, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))

plotall_nnS <- rbind(plotl_10_nnS,
      plots_10_nnS,
      plotall_10_nnS,
      plotl_20_nnS,
      plots_20_nnS,
      plotall_20_nnS,
      plotl_30_nnS,
      plots_30_nnS,
      plotall_30_nnS, 
      plotl_40_nnS,
      plots_40_nnS,
      plotall_40_nnS,
      plotl_50_nnS,
      plots_50_nnS,
      plotall_50_nnS)

plotl_10_sqrt2 <- L_blod_10_sqrt2_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Low Rank Solution", Percent = "LOD10") %>% left_join(., plot_10, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plots_10_sqrt2 <- S_blod_10_sqrt2_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Sparse Solution", Percent = "LOD10") %>% left_join(., plot_10, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plotall_10_sqrt2 <- (L_blod_10_sqrt2_na + S_blod_10_sqrt2_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Model Prediction", Percent = "LOD10") %>% left_join(., plot_10, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))

plotl_20_sqrt2 <- L_blod_20_sqrt2_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Low Rank Solution", Percent = "LOD20") %>% left_join(., plot_20, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plots_20_sqrt2 <- S_blod_20_sqrt2_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Sparse Solution", Percent = "LOD20") %>% left_join(., plot_20, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plotall_20_sqrt2 <- (L_blod_20_sqrt2_na + S_blod_20_sqrt2_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Model Prediction", Percent = "LOD20") %>% left_join(., plot_20, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent")) 

plotl_30_sqrt2 <- L_blod_30_sqrt2_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Low Rank Solution", Percent = "LOD30") %>% left_join(., plot_30, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plots_30_sqrt2 <- S_blod_30_sqrt2_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Sparse Solution", Percent = "LOD30") %>% left_join(., plot_30, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent")) 
plotall_30_sqrt2 <- (L_blod_30_sqrt2_na + S_blod_30_sqrt2_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Model Prediction", Percent = "LOD30") %>% left_join(., plot_30, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent")) 

plotl_40_sqrt2 <- L_blod_40_sqrt2_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Low Rank Solution", Percent = "LOD40") %>% left_join(., plot_40, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plots_40_sqrt2 <- S_blod_40_sqrt2_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Sparse Solution", Percent = "LOD40") %>% left_join(., plot_40, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plotall_40_sqrt2 <- (L_blod_40_sqrt2_na + S_blod_40_sqrt2_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Model Prediction", Percent = "LOD40") %>% left_join(., plot_40, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))

plotl_50_sqrt2 <- L_blod_50_sqrt2_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Low Rank Solution", Percent = "LOD50") %>% left_join(., plot_50, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))
plots_50_sqrt2 <- S_blod_50_sqrt2_na %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Sparse Solution", Percent = "LOD50") %>% left_join(., plot_50, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent")) 
plotall_50_sqrt2 <- (L_blod_50_sqrt2_na + S_blod_50_sqrt2_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% mutate(Compare = "Model Prediction", Percent = "LOD50") %>% left_join(., plot_50, by = c("rowid", "Percent")) %>% left_join(., LODall, by = c("Percent"))

plotall_sqrt2 <- rbind(plotl_10_sqrt2,
      plots_10_sqrt2,
      plotall_10_sqrt2,
      plotl_20_sqrt2,
      plots_20_sqrt2,
      plotall_20_sqrt2,
      plotl_30_sqrt2,
      plots_30_sqrt2,
      plotall_30_sqrt2, 
      plotl_40_sqrt2,
      plots_40_sqrt2,
      plotall_40_sqrt2,
      plotl_50_sqrt2,
      plots_50_sqrt2,
      plotall_50_sqrt2)
```

```{r}
plotall %>% 
  filter(Compare == "Low Rank Solution") %>% 
  drop_na(.) %>% 
  mutate(above_lod = ifelse(value > LOD, 1, 0)) %>%
  group_by(Compare, Percent) %>% 
  summarise(above = sum(above_lod),
            total = n()) %>% 
  mutate(Proportion = round(above/total, 2)) %>% 
  ungroup(.) %>% 
  select(Percent, Proportion) %>% 
  kable(., caption = "LOD PCP Low Rank Solution Values >LOD for POP V1")

plotall_nnS %>% 
  filter(Compare == "Low Rank Solution") %>% 
  drop_na(.) %>% 
  mutate(above_lod = ifelse(value > LOD, 1, 0)) %>%
  group_by(Compare, Percent) %>% 
  summarise(above = sum(above_lod),
            total = n()) %>% 
  mutate(Proportion = round(above/total, 2)) %>% 
  ungroup(.) %>% 
  select(Percent, Proportion) %>% 
  kable(., caption = "nnS LOD PCP Low Rank Solution Values >LOD for POP V1")

plotall_sqrt2 %>% 
  filter(Compare == "Low Rank Solution") %>% 
  drop_na(.) %>% 
  mutate(above_lod = ifelse(value > LOD, 1, 0)) %>%
  group_by(Compare, Percent) %>% 
  summarise(above = sum(above_lod),
            total = n()) %>% 
  mutate(Proportion = round(above/total, 2)) %>% 
  ungroup(.) %>% 
  select(Percent, Proportion) %>% 
  kable(., caption = "Original PCP w/ LOD/sqrt(2) Low Rank Solution Values >LOD for POP V1")

rbind(plots_10,
      plots_20,
      plots_30,
      plots_40,
      plots_50) %>% 
  drop_na(.) %>% 
  group_by(Compare, Percent) %>% 
  summarise(Min = min(value),
            Ave = mean(value),
            Max = max(value)) %>% 
  ungroup(.) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  select(-Compare) %>% kable(., caption = "LOD PCP Sparse Solutions for POP V1")

rbind(plots_10_nnS,
      plots_20_nnS,
      plots_30_nnS,
      plots_40_nnS,
      plots_50_nnS) %>% 
  drop_na(.) %>% 
  group_by(Compare, Percent) %>%
  summarise(Min = min (value),
            Mean = mean(value),
            Max = max(value)) %>% 
  ungroup(.) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  select(-Compare) %>% kable(., caption = "nnS LOD PCP Sparse Solutions for POP V1")

rbind(plots_10_sqrt2,
      plots_20_sqrt2,
      plots_30_sqrt2,
      plots_40_sqrt2,
      plots_50_sqrt2) %>% 
  drop_na(.) %>% 
  group_by(Compare, Percent) %>%
  summarise(Min = min (value),
            Mean = mean(value),
            Max = max(value)) %>% 
  ungroup(.) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  select(-Compare) %>% kable(., caption = "Original PCP w/ LOD/sqrt(2) Sparse Solutions for POP V1")
```

* Plus sign (\+) indicates LOD for each chemical

```{r, fig.align = "center"}
org <- org %>% select(rowid, value = Value, Compare, Percent, POP, LOD)

plotall %>% 
  select(-Original) %>% 
  rbind(., org) %>% 
  drop_na(.) %>% 
  #filter(Compare != "Original") %>% 
  # with and without Original
  mutate(Compare = fct_relevel(Compare, "Low Rank Solution",
                            "Sparse Solution",
                            "Model Prediction",
                            "Original")) %>% 
  ggplot(aes(x = Percent, y = value)) + 
  geom_jitter(aes(color = Compare), alpha = 0.75, width = 0.10, height = 0) + 
  theme_bw() +
  geom_point(aes(y = LOD), shape = 3, size = 2) +
  #facet_wrap(.~Percent) +
  labs(x = "% < LOD", 
       y = "Solution Value",
       title = "LOD PCP Solution Values <LOD + Original Values for POP V1") +
  theme(legend.position = "bottom")
```

* Plus sign (\+) indicates LOD for each chemical

```{r, fig.align = "center"}
plotall %>% 
  select(-Original) %>% 
  rbind(., org) %>% 
  drop_na(.) %>% 
  filter(Compare != "Original") %>% 
  # with and without Original
  mutate(Compare = fct_relevel(Compare, "Low Rank Solution",
                            "Sparse Solution",
                            "Model Prediction")) %>% 
  ggplot(aes(x = Percent, y = value)) + 
  geom_jitter(aes(color = Compare), alpha = 0.75, width = 0.10, height = 0) + 
  theme_bw() +
  geom_point(aes(y = LOD), shape = 3, size = 2) +
  #facet_wrap(.~Percent) +
  labs(x = "% < LOD", 
       y = "Solution Value",
       title = "LOD PCP Solution Values <LOD for POP V1") +
  theme(legend.position = "bottom")
```

* Plus sign (\+) indicates LOD for each chemical

```{r, fig.align = "center"}
plotall_nnS %>% 
  select(-Original) %>% 
  rbind(., org) %>% 
  drop_na(.) %>% 
  #filter(Compare != "Original") %>% 
  # with and without Original
  mutate(Compare = fct_relevel(Compare, "Low Rank Solution",
                            "Sparse Solution",
                            "Model Prediction",
                            "Original")) %>% 
  ggplot(aes(x = Percent, y = value)) + 
  geom_jitter(aes(color = Compare), alpha = 0.75, width = 0.10, height = 0) + 
  theme_bw() +
  geom_point(aes(y = LOD), shape = 3, size = 2) +
  #facet_wrap(.~Percent) +
  labs(x = "% < LOD", 
       y = "Solution Value",
       title = "nnS LOD PCP Solution Values <LOD + Original Values for POP V1") +
  theme(legend.position = "bottom")
```

* Plus sign (\+) indicates LOD for each chemical

```{r, fig.align = "center"}
plotall_nnS %>% 
  select(-Original) %>% 
  rbind(., org) %>% 
  drop_na(.) %>% 
  filter(Compare != "Original") %>% 
  # with and without Original
  mutate(Compare = fct_relevel(Compare, "Low Rank Solution",
                            "Sparse Solution",
                            "Model Prediction")) %>% 
  ggplot(aes(x = Percent, y = value)) + 
  geom_jitter(aes(color = Compare), alpha = 0.75, width = 0.10, height = 0) + 
  theme_bw() +
  geom_point(aes(y = LOD), shape = 3, size = 2) +
  #facet_wrap(.~Percent) +
  labs(x = "% < LOD", 
       y = "Solution Value",
       title = "nnS LOD PCP Solution Values <LOD for POP V1") +
  theme(legend.position = "bottom")
```

* Plus sign (\+) indicates LOD for each chemical

```{r, fig.align = "center"}
plotall_sqrt2 %>% 
  select(-Original) %>% 
  rbind(., org) %>% 
  drop_na(.) %>% 
  #filter(Compare != "Original") %>% 
  # with and without Original
  mutate(Compare = fct_relevel(Compare, "Low Rank Solution",
                            "Sparse Solution",
                            "Model Prediction",
                            "Original")) %>% 
  ggplot(aes(x = Percent, y = value)) + 
  geom_jitter(aes(color = Compare), alpha = 0.75, width = 0.10, height = 0) + 
  theme_bw() +
  geom_point(aes(y = LOD), shape = 3, size = 2) +
  #facet_wrap(.~Percent) +
  labs(x = "% < LOD", 
       y = "Solution Value",
       title = "Original PCP w/ LOD/sqrt(2) Solution Values <LOD + Original Values for POP V1") +
  theme(legend.position = "bottom")
```

* Plus sign (\+) indicates LOD for each chemical

```{r, fig.align = "center"}
plotall_sqrt2 %>% 
  select(-Original) %>% 
  rbind(., org) %>% 
  drop_na(.) %>% 
  filter(Compare != "Original") %>% 
  # with and without Original
  mutate(Compare = fct_relevel(Compare, "Low Rank Solution",
                            "Sparse Solution",
                            "Model Prediction")) %>% 
    ggplot(aes(x = Percent, y = value)) + 
  geom_jitter(aes(color = Compare), alpha = 0.75, width = 0.10, height = 0) + 
  theme_bw() +
  geom_point(aes(y = LOD), shape = 3, size = 2) +
  #facet_wrap(.~Percent) +
  labs(x = "% < LOD", 
       y = "Solution Value",
       title = "Original PCP w/ LOD/sqrt(2) Solution Values <LOD for POP V1") +
  theme(legend.position = "bottom")
```

```{r, message=FALSE, fig.align = "center"}
plotall %>% 
  select(-Original) %>% 
  rbind(., org) %>% 
  drop_na(.) %>% 
  #filter(Compare != "Sparse Solution") %>% 
  ggplot(aes(x = value)) + 
  geom_histogram(aes(fill = Compare, color = Compare), alpha = 0.25) + 
  theme_bw() +
  facet_wrap(.~Percent) +
  labs(x = "Solution Value", 
       y = "Count",
       title = "LOD PCP Solution Values <LOD + Original Values for POP V1") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, hjust = 1))

plotall_nnS %>% 
  select(-Original) %>% 
  rbind(., org) %>% 
  drop_na(.) %>% 
  #filter(Compare != "Sparse Solution") %>% 
  ggplot(aes(x = value)) + 
  geom_histogram(aes(fill = Compare, color = Compare), alpha = 0.25) + 
  theme_bw() +
  facet_wrap(.~Percent) +
  labs(x = "Solution Value", 
       y = "Count",
       title = "nnS LOD PCP Solution Values <LOD + Original Values for POP V1") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, hjust = 1))

plotall_sqrt2 %>% 
  select(-Original) %>% 
  rbind(., org) %>% 
  drop_na(.) %>% 
  #filter(Compare != "Sparse Solution") %>% 
  ggplot(aes(x = value)) + 
  geom_histogram(aes(fill = Compare, color = Compare), alpha = 0.25) + 
  theme_bw() +
  facet_wrap(.~Percent) +
  labs(x = "Solution Value", 
       y = "Count",
       title = "Original PCP w/ LOD/sqrt(2) Solution Values <LOD + Original Values for POP V1") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, hjust = 1))
```




## PCA

```{r}
pca_0  <- prcomp(mix)
pca_10 <- prcomp(mix_data_lod_10_sqrt2)
pca_20 <- prcomp(mix_data_lod_20_sqrt2)
pca_30 <- prcomp(mix_data_lod_30_sqrt2)
pca_40 <- prcomp(mix_data_lod_40_sqrt2)
pca_50 <- prcomp(mix_data_lod_50_sqrt2)
```

```{r, pca, echo=TRUE}
pca_50$sdev
plot(pca_50)
```

```{r}
# cor(pca_0$rotation[,1:7], pca_10$rotation[,1:7])
# cor(pca_0$rotation[,1:7], pca_20$rotation[,1:7])
# cor(pca_0$rotation[,1:7], pca_30$rotation[,1:7])
# cor(pca_0$rotation[,1:7], pca_40$rotation[,1:7])
# cor(pca_0$rotation[,1:7], pca_50$rotation[,1:7])

pca_10$rotation[,4] <- -pca_10$rotation[,4]
pca_50$rotation[,5] <- -pca_50$rotation[,5]

rotation_norm <- as_tibble(cbind(`0%` = norm((pca_0$rotation[,1:2] - pca_0$rotation[,1:2]), type = "F")/norm((pca_0$rotation[,1:2]), type = "F"),
      `10%` = norm((pca_0$rotation[,1:2] - pca_10$rotation[,1:2]), type = "F")/norm((pca_0$rotation[,1:2]), type = "F"),
      `20%` = norm((pca_0$rotation[,1:2] - pca_20$rotation[,1:2]), type = "F")/norm((pca_0$rotation[,1:2]), type = "F"),
      `30%` = norm((pca_0$rotation[,1:2] - pca_30$rotation[,1:2]), type = "F")/norm((pca_0$rotation[,1:2]), type = "F"),
      `40%` = norm((pca_0$rotation[,1:2] - pca_40$rotation[,1:2]), type = "F")/norm((pca_0$rotation[,1:2]), type = "F"),
      `50%` = norm((pca_0$rotation[,1:2] - pca_50$rotation[,1:2]), type = "F")/norm((pca_0$rotation[,1:2]), type = "F"))) %>%
  gather(Percent, norm) %>% 
  mutate(Method = "PCA")
```

```{r}
# cor(pca_0$x[,1:7], pca_10$x[,1:7])
# cor(pca_0$x[,1:7], pca_20$x[,1:7])
# cor(pca_0$x[,1:7], pca_30$x[,1:7])
# cor(pca_0$x[,1:7], pca_40$x[,1:7])
# cor(pca_0$x[,1:7], pca_50$x[,1:7])

pca_10$x[,4] <- -pca_10$x[,4]
pca_50$x[,5] <- -pca_50$x[,5]

score_norm <- as_tibble(cbind(`0%` = norm((pca_0$x[,1:2] - pca_0$x[,1:2]), type = "F")/norm((pca_0$x[,1:2]), type = "F"),
      `10%` = norm((pca_0$x[,1:2] - pca_10$x[,1:2]), type = "F")/norm((pca_0$x[,1:2]), type = "F"),
      `20%` = norm((pca_0$x[,1:2] - pca_20$x[,1:2]), type = "F")/norm((pca_0$x[,1:2]), type = "F"),
      `30%` = norm((pca_0$x[,1:2] - pca_30$x[,1:2]), type = "F")/norm((pca_0$x[,1:2]), type = "F"),
      `40%` = norm((pca_0$x[,1:2] - pca_40$x[,1:2]), type = "F")/norm((pca_0$x[,1:2]), type = "F"),
      `50%` = norm((pca_0$x[,1:2] - pca_50$x[,1:2]), type = "F")/norm((pca_0$x[,1:2]), type = "F"))) %>% 
  gather(Percent, norm) %>% 
  mutate(Method = "PCA")
```

```{r}
sdev_norm <- as_tibble(cbind(`0%` = norm_vec(pca_0$sdev[1:2] - pca_0$sdev[1:2])/norm_vec(pca_0$sdev[1:2]),
      `10%` = norm_vec(pca_0$sdev[1:2] - pca_10$sdev[1:2])/norm_vec(pca_0$sdev[1:2]),
      `20%` = norm_vec(pca_0$sdev[1:2] - pca_20$sdev[1:2])/norm_vec(pca_0$sdev[1:2]),
      `30%` = norm_vec(pca_0$sdev[1:2] - pca_30$sdev[1:2])/norm_vec(pca_0$sdev[1:2]),
      `40%` = norm_vec(pca_0$sdev[1:2] - pca_40$sdev[1:2])/norm_vec(pca_0$sdev[1:2]),
      `50%` = norm_vec(pca_0$sdev[1:2] - pca_50$sdev[1:2])/norm_vec(pca_0$sdev[1:2]))) %>% 
  gather(Percent, norm) %>% 
  mutate(Method = "PCA")
```

```{r}
pcp_pca_0  <- prcomp(L_lod0)
pcp_pca_10 <- prcomp(L_lod10)
pcp_pca_20 <- prcomp(L_lod20)
pcp_pca_30 <- prcomp(L_lod30)
pcp_pca_40 <- prcomp(L_lod40)
pcp_pca_50 <- prcomp(L_lod50)
```

```{r, pcp_pca, echo = TRUE}
pcp_pca_50$sdev
plot(pcp_pca_50)
```

```{r}
# cor(pcp_pca_0$rotation[,1:7], pcp_pca_10$rotation[,1:7])
# cor(pcp_pca_0$rotation[,1:7], pcp_pca_20$rotation[,1:7])
# cor(pcp_pca_0$rotation[,1:7], pcp_pca_30$rotation[,1:7])
# cor(pcp_pca_0$rotation[,1:7], pcp_pca_40$rotation[,1:7])
# cor(pcp_pca_0$rotation[,1:7], pcp_pca_50$rotation[,1:7])

pcp_pca_20$rotation[,5:7] <- -pcp_pca_20$rotation[,5:7]
pcp_pca_30$rotation[,4] <- -pcp_pca_30$rotation[,4]
pcp_pca_30$rotation[,7] <- -pcp_pca_30$rotation[,7]
pcp_pca_40$rotation[,3] <- -pcp_pca_40$rotation[,3]
pcp_pca_40$rotation[,5:7] <- -pcp_pca_40$rotation[,5:7]
pcp_pca_50$rotation[,3:6] <- -pcp_pca_50$rotation[,3:6]

pcp_rotation_norm <- as_tibble(cbind(`0%` = norm((pcp_pca_0$rotation[,1:2] - pcp_pca_0$rotation[,1:2]), type = "F")/norm((pcp_pca_0$rotation[,1:2]), type = "F"),
      `10%` = norm((pcp_pca_0$rotation[,1:2] - pcp_pca_10$rotation[,1:2]), type = "F")/norm((pcp_pca_0$rotation[,1:2]), type = "F"),
      `20%` = norm((pcp_pca_0$rotation[,1:2] - pcp_pca_20$rotation[,1:2]), type = "F")/norm((pcp_pca_0$rotation[,1:2]), type = "F"),
      `30%` = norm((pcp_pca_0$rotation[,1:2] - pcp_pca_30$rotation[,1:2]), type = "F")/norm((pcp_pca_0$rotation[,1:2]), type = "F"),
      `40%` = norm((pcp_pca_0$rotation[,1:2] - pcp_pca_40$rotation[,1:2]), type = "F")/norm((pcp_pca_0$rotation[,1:2]), type = "F"),
      `50%` = norm((pcp_pca_0$rotation[,1:2] - pcp_pca_50$rotation[,1:2]), type = "F")/norm((pcp_pca_0$rotation[,1:2]), type = "F"))) %>% 
  gather(Percent, norm) %>% 
  mutate(Method = "PCP")
```

```{r}
# cor(pcp_pca_0$x[,1:7], pcp_pca_10$x[,1:7])
# cor(pcp_pca_0$x[,1:7], pcp_pca_20$x[,1:7])
# cor(pcp_pca_0$x[,1:7], pcp_pca_30$x[,1:7])
# cor(pcp_pca_0$x[,1:7], pcp_pca_40$x[,1:7])
# cor(pcp_pca_0$x[,1:7], pcp_pca_50$x[,1:7])

pcp_pca_20$x[,5:7] <- -pcp_pca_20$x[,5:7]
pcp_pca_30$x[,4] <- -pcp_pca_30$x[,4]
pcp_pca_30$x[,7] <- -pcp_pca_30$x[,7]
pcp_pca_40$x[,3] <- -pcp_pca_40$x[,3]
pcp_pca_40$x[,5:7] <- -pcp_pca_40$x[,5:7]
pcp_pca_50$x[,3:6] <- -pcp_pca_50$x[,3:6]

pcp_score_norm <- as_tibble(cbind(`0%` = norm((pcp_pca_0$x[,1:2] - pcp_pca_0$x[,1:2]), type = "F")/norm((pcp_pca_0$x[,1:2]), type = "F"),
      `10%` = norm((pcp_pca_0$x[,1:2] - pcp_pca_10$x[,1:2]), type = "F")/norm((pcp_pca_0$x[,1:2]), type = "F"),
      `20%` = norm((pcp_pca_0$x[,1:2] - pcp_pca_20$x[,1:2]), type = "F")/norm((pcp_pca_0$x[,1:2]), type = "F"),
      `30%` = norm((pcp_pca_0$x[,1:2] - pcp_pca_30$x[,1:2]), type = "F")/norm((pcp_pca_0$x[,1:2]), type = "F"),
      `40%` = norm((pcp_pca_0$x[,1:2] - pcp_pca_40$x[,1:2]), type = "F")/norm((pcp_pca_0$x[,1:2]), type = "F"),
      `50%` = norm((pcp_pca_0$x[,1:2] - pcp_pca_50$x[,1:2]), type = "F")/norm((pcp_pca_0$x[,1:2]), type = "F"))) %>% 
  gather(Percent, norm) %>% 
  mutate(Method = "PCP")
```

```{r}
pcp_sdev_norm <- as_tibble(cbind(`0%` = norm_vec(pcp_pca_0$sdev[1:2] - pcp_pca_0$sdev[1:2])/norm_vec(pcp_pca_0$sdev[1:2]),
      `10%` = norm_vec(pcp_pca_0$sdev[1:2] - pcp_pca_10$sdev[1:2])/norm_vec(pcp_pca_0$sdev[1:2]),
      `20%` = norm_vec(pcp_pca_0$sdev[1:2] - pcp_pca_20$sdev[1:2])/norm_vec(pcp_pca_0$sdev[1:2]),
      `30%` = norm_vec(pcp_pca_0$sdev[1:2] - pcp_pca_30$sdev[1:2])/norm_vec(pcp_pca_0$sdev[1:2]),
      `40%` = norm_vec(pcp_pca_0$sdev[1:2] - pcp_pca_40$sdev[1:2])/norm_vec(pcp_pca_0$sdev[1:2]),
      `50%` = norm_vec(pcp_pca_0$sdev[1:2] - pcp_pca_50$sdev[1:2])/norm_vec(pcp_pca_0$sdev[1:2]))) %>% 
  gather(Percent, norm) %>% 
  mutate(Method = "PCP")
```

### Viz

```{r, fig.height = 5, fig.width = 4, fig.align = "center"}
rbind(rotation_norm, pcp_rotation_norm) %>% ggplot(aes(x = Percent, y = norm)) + 
  geom_point(aes(color = Method)) + geom_path(aes(group = Method, color = Method)) + theme_bw() +
  labs(x = "Percent Below LOD", y = "norm(difference) / norm(lod0)",
       title = "Relative Error in Rotations")
```

```{r, fig.height = 5, fig.width = 4, fig.align = "center"}
rbind(score_norm, pcp_score_norm) %>% ggplot(aes(x = Percent, y = norm)) + 
  geom_point(aes(color = Method)) + geom_path(aes(group = Method, color = Method)) + theme_bw() +
  labs(x = "Percent Below LOD", y = "norm(difference) / norm(lod0)",
       title = "Relative Error in Scores")
```

```{r, fig.height = 5, fig.width = 4, fig.align = "center"}
rbind(sdev_norm, pcp_sdev_norm) %>% ggplot(aes(x = Percent, y = norm)) + 
  geom_point(aes(color = Method)) + geom_path(aes(group = Method, color = Method)) + theme_bw() +
  labs(x = "Percent Below LOD", y = "norm(difference) / norm(lod0)",
       title = "Relative Error in Singular Values")
```

### Variance Explained

```{r}
PCP_0 <- pcp_pca_0$sdev^2/sum(pcp_pca_0$sdev^2) *100
PCA_0 <- pca_0$sdev^2/sum(pca_0$sdev^2) *100

PCP_50 <- pcp_pca_50$sdev^2/sum(pcp_pca_50$sdev^2) *100
PCA_50 <- pca_50$sdev^2/sum(pca_50$sdev^2) *100

round(cbind(Component = 1:10, PCP_0, PCA_0, PCP_50, PCA_50), 4) %>% kable()
```


### PCA <LOD Pred Values

```{r}
# Create mean vector for un-centering
sim_means_sqrt2 <- apply(sim_all, 2, mean)
mix_10_means_sqrt2 <- apply(mix_data_lod_10_sqrt2, 2, mean)
mix_20_means_sqrt2 <- apply(mix_data_lod_20_sqrt2, 2, mean)
mix_30_means_sqrt2 <- apply(mix_data_lod_30_sqrt2, 2, mean)
mix_40_means_sqrt2 <- apply(mix_data_lod_40_sqrt2, 2, mean)
mix_50_means_sqrt2 <- apply(mix_data_lod_50_sqrt2, 2, mean)
```

```{r}
# prcomp centers, does not scale
# need to UNCENTER predictions to compare
# REMOVE SV

rep.row<-function(x,n){
  matrix(rep(x,each=n),nrow=n)
}

pca_pred_0  <- pca_0$x[,1:3] %*% t(pca_0$rotation)[1:3,]   + rep.row(sim_means_sqrt2, 100)
pca_pred_10 <- pca_10$x[,1:3] %*% t(pca_10$rotation)[1:3,] + rep.row(mix_10_means_sqrt2, 100)
pca_pred_20 <- pca_20$x[,1:3] %*% t(pca_20$rotation)[1:3,] + rep.row(mix_20_means_sqrt2, 100)
pca_pred_30 <- pca_30$x[,1:3] %*% t(pca_30$rotation)[1:3,] + rep.row(mix_30_means_sqrt2, 100)
pca_pred_40 <- pca_40$x[,1:3] %*% t(pca_40$rotation)[1:3,] + rep.row(mix_40_means_sqrt2, 100)
pca_pred_50 <- pca_50$x[,1:3] %*% t(pca_50$rotation)[1:3,] + rep.row(mix_50_means_sqrt2, 100)
```

```{r, tp_lod, include=FALSE}
pred_pca <- as_tibble(cbind(Simulated = mix[,1],
                          `0%` = pca_pred_0[,1],
                          `10%` = pca_pred_10[,1],
                          `20%` = pca_pred_20[,1],
                          `30%` = pca_pred_30[,1],
                          `40%` = pca_pred_40[,1],
                          `50%` = pca_pred_50[,1],
          id = 1:100)) %>% gather(key = Percent, value = Predicted, -Simulated, -id) %>% 
  mutate(LOD = c(rep(0, 100), rep(quantile(mix[,1], .10), 100),
                 rep(quantile(mix[,1], .20), 100),
                 rep(quantile(mix[,1], .30), 100),
                 rep(quantile(mix[,1], .40), 100),
                 rep(quantile(mix[,1], .50), 100)))
```

```{r}
F_norm_pca <- as_tibble(cbind(`0%` = norm((mix - pca_pred_0), type = "F")/norm((mix), type = "F"),
      `10%` = norm((mix - pca_pred_10), type = "F")/norm((mix), type = "F"),
      `20%` = norm((mix - pca_pred_20), type = "F")/norm((mix), type = "F"),
      `30%` = norm((mix - pca_pred_30), type = "F")/norm((mix), type = "F"),
      `40%` = norm((mix - pca_pred_40), type = "F")/norm((mix), type = "F"),
      `50%` = norm((mix - pca_pred_50), type = "F")/norm((mix), type = "F"))) %>% 
  gather(Percent, norm) %>% 
  mutate(Method = "PCA")

# F_norm_pca
```

```{r, fig.align="center"}
pred_pca %>% 
  ggplot(aes(x = Simulated, y = Predicted)) + 
  geom_hline(yintercept = 0, color = 'grey', linetype = 'dashed') +
  geom_rect(aes(xmin = 0, xmax = LOD, ymin = 0, ymax = LOD),
                   fill = "pink", alpha = 0.03) +
  geom_abline(intercept = 0, slope = 1, color = 'grey', linetype = 'dashed') +
  geom_point(aes(color = Percent)) +
  facet_wrap(~Percent) +
  theme_bw() + theme(legend.position = "none") +
  labs(title= "PCA Simulated v. Predicted Values for POP V1")
```

```{r, fig.align="center"}
pred_pca %>% 
  filter(Simulated <= LOD) %>% 
  ggplot(aes(x = Simulated, y = Predicted)) + 
  geom_hline(yintercept = 0, color = 'grey', linetype = 'dashed') +
  geom_rect(aes(xmin = 0, xmax = LOD, ymin = 0, ymax = LOD),
                   fill = "pink", alpha = 0.03) +
  geom_abline(intercept = 0, slope = 1, color = 'grey', linetype = 'dashed') +
  geom_point(aes(color = Percent)) +
  facet_wrap(~Percent) +
  theme_bw() + theme(legend.position = "none") +
  labs(title= "PCA Simulated v. Predicted Values for POP V1 <LOD")
```


