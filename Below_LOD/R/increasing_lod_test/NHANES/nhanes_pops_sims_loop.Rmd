---
title: "LOD PCP, Original PCP, & nnS LOD PCP"
author: "Lizzy Gibson"
date: "5/7/2020"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 5
---

```{r setup, include=FALSE}
require("knitr")
opts_chunk$set(echo = FALSE, messages = FALSE)
options(scipen = 999)
library(R.matlab)
library(tidyverse)
library(gridExtra)
library(Matrix)
library(matconv)
library(patchwork)
library(janitor)
library(ggcorrplot)
library(ggfortify)  
library(factoextra)
library(knitr)
library(haven)
library(rlist)
library(mvtnorm)
library(reshape2)
library(GGally)
library(grDevices)
library(plotly)
library(Cairo)
```

```{r, nhanes, include=FALSE, cache = TRUE}
nhanes <- read_sas(here::here("./Data/studypop_lod.sas7bdat")) %>% 
  clean_names()

prop <- function (x) {1 - (sum(x, na.rm = TRUE)/nrow(nhanes))}

names <- nhanes %>% select(names(.)[grep("lc", names(.))]) %>% 
  summarize_all(prop) %>% select_if(~. > 0.6) %>% names() %>% str_sub(., 4, 6) %>% str_c("lbx", ., "la") %>% as.vector()

pops <- nhanes %>% 
  select(!!names) %>% na.omit(.)

names(pops) <- str_sub(names(pops), 1, 6)
names(pops) <- str_replace(names(pops), "lbxd", "D")
names(pops) <- str_replace(names(pops), "lbxf", "F")
names(pops) <- str_replace(names(pops), "lbx", "PCB")
pops

# Vector of NHANES means
# log to approx normal dist
means <- as_vector(map(log(pops), function(x) mean(x, na.rm = TRUE)))

# Covariance matrix from NHANES
# log to approx normal dist
covs <- cov(log(pops))

# Simulate with multivariate normal function
sim_logn <- function (seed){
  set.seed(seed)
  sim_all <- exp(rmvnorm(1000, mean = means, sigma = covs)) %>% as_tibble()
  sim_all
}

# exp multi-normal to get multi-log normal
sim_all <- as_tibble(1:100) %>%
  rename(seed = value) %>% 
  mutate(sims = map(seed, sim_logn),
         sims = map(sims, scale, center = FALSE),
         sims = map(sims, as_tibble))

create_sim_version <- function (sim_all, prob, fillin) {
  version <- sim_all %>% 
  mutate_all(~ifelse(. < quantile(., probs = prob), fillin, .)) %>% as.matrix()
  version
}

create_sim_version_ratio <- function (sim_all, prob, denom) {
  version <- sim_all %>% 
  mutate_all(~ifelse(. < quantile(., probs = prob), (quantile(., probs = prob)/denom), .)) %>% as.matrix()
  version
}

sim_all <- sim_all %>% 
  mutate(mix_data_lod_10 = pmap(list(sims, 0.10, -1), function(x,y,z) create_sim_version(x,y,z)),
         mix_data_lod_20 = pmap(list(sims, 0.20, -1), function(x,y,z) create_sim_version(x,y,z)),
         mix_data_lod_30 = pmap(list(sims, 0.30, -1), function(x,y,z) create_sim_version(x,y,z)),
         mix_data_lod_40 = pmap(list(sims, 0.40, -1), function(x,y,z) create_sim_version(x,y,z)),
         mix_data_lod_50 = pmap(list(sims, 0.50, -1), function(x,y,z) create_sim_version(x,y,z)),
         mix_data_lod_10_0 = pmap(list(sims, 0.10, 0), function(x,y,z) create_sim_version(x,y,z)),
         mix_data_lod_20_0 = pmap(list(sims, 0.20, 0), function(x,y,z) create_sim_version(x,y,z)),
         mix_data_lod_30_0 = pmap(list(sims, 0.30, 0), function(x,y,z) create_sim_version(x,y,z)),
         mix_data_lod_40_0 = pmap(list(sims, 0.40, 0), function(x,y,z) create_sim_version(x,y,z)),
         mix_data_lod_50_0 = pmap(list(sims, 0.50, 0), function(x,y,z) create_sim_version(x,y,z)),
         mix_data_lod_10_sqrt2 = pmap(list(sims, 0.10, sqrt(2)), 
                                      function(x,y,z) create_sim_version_ratio(x,y,z)),
         mix_data_lod_20_sqrt2 = pmap(list(sims, 0.20, sqrt(2)), 
                                      function(x,y,z) create_sim_version_ratio(x,y,z)),
         mix_data_lod_30_sqrt2 = pmap(list(sims, 0.30, sqrt(2)), 
                                      function(x,y,z) create_sim_version_ratio(x,y,z)),
         mix_data_lod_40_sqrt2 = pmap(list(sims, 0.40, sqrt(2)), 
                                      function(x,y,z) create_sim_version_ratio(x,y,z)),
         mix_data_lod_50_sqrt2 = pmap(list(sims, 0.50, sqrt(2)), 
                                      function(x,y,z) create_sim_version_ratio(x,y,z)),
         mix_data_lod_10_2 = pmap(list(sims, 0.10, 2), 
                                      function(x,y,z) create_sim_version_ratio(x,y,z)),
         mix_data_lod_20_2 = pmap(list(sims, 0.20, 2), 
                                      function(x,y,z) create_sim_version_ratio(x,y,z)),
         mix_data_lod_30_2 = pmap(list(sims, 0.30, 2), 
                                      function(x,y,z) create_sim_version_ratio(x,y,z)),
         mix_data_lod_40_2 = pmap(list(sims, 0.40, 2), 
                                      function(x,y,z) create_sim_version_ratio(x,y,z)),
         mix_data_lod_50_2 = pmap(list(sims, 0.50, 2), 
                                      function(x,y,z) create_sim_version_ratio(x,y,z)))
         
make_delta <- function(sim_all, quant) {
  delta <- sim_all %>% 
  summarise_all(quantile, probs = quant) %>% as_vector()
  delta
}

sim_all <- sim_all %>% 
  mutate(delta10 = pmap(list(sims, .10), function(x,y) make_delta(x,y)),
         delta20 = pmap(list(sims, .20), function(x,y) make_delta(x,y)),
         delta30 = pmap(list(sims, .30), function(x,y) make_delta(x,y)),
         delta40 = pmap(list(sims, .40), function(x,y) make_delta(x,y)),
         delta50 = pmap(list(sims, .50), function(x,y) make_delta(x,y)))
```

```{r, nn_function, include=FALSE, cache = TRUE}
prox_l1 <- function(Y, c) {
  
  myzero <- matrix(data = 0, ncol = ncol(Y), nrow = nrow(Y))
  X <- sign(Y) * pmax(abs(Y) - c, myzero, na.rm = TRUE)
  X
} 

############################################################

prox_nuclear <- function(Y, c) {
  
  USV <- svd(Y)
  U <- USV$u
  S <- USV$d
  V <- USV$v
  
  myzero <- vector("numeric", length = length(S))
  S_new <- sign(S) * pmax(abs(S) - c, myzero, na.rm = TRUE)
  X <- U %*% diag(S_new) %*% t(V)
  nuclearX  <- sum(abs(S_new))

    list(X = X, nuclearX = nuclearX)
}

############################################################

is_same <- function(SAME_THRESH, ...) {
  flag <- TRUE
  varargin <- list(...)
  if (length(varargin) == 2) {
    if (max(abs(varargin[[1]] - varargin[[2]])) > SAME_THRESH) {
      flag <- FALSE
    }
  }
  else if (length(varargin) == 3) {
    if ((max(abs(varargin[[1]] - varargin[[2]])) > SAME_THRESH) |
        (max(abs(varargin[[1]] - varargin[[3]])) > SAME_THRESH) |
        (max(abs(varargin[[2]] - varargin[[3]])) > SAME_THRESH)) {
      flag <- FALSE
    }
  }
  flag
}

############################################################

loss_lod <- function(X, D, LOD) {

    X_lod <- ((X - D)     * (D >= 0)) +
             ((X - LOD)   * (D < 0 & (X > LOD))) +
              (X          * (D < 0 & X < 0))
  
  l <- sum(X_lod^2) / 2
  l
}

############################################################

pcp_lod <- function(D, lambda, mu, LOD) {
  
  m <- nrow(D)
  n <- ncol(D)
  rho <- 1 # Augmented Lagrangian coefficient (rate)
  
  L1 <- matrix(0, m, n)
  L2 <- matrix(0, m, n)
  L3 <- matrix(0, m, n)
  
  S1 <- matrix(0, m, n)
  S2 <- matrix(0, m, n)
  
  Z1 <- matrix(0, m, n)
  Z2 <- matrix(0, m, n)
  Z3 <- matrix(0, m, n)
  
  # Max iteration
  MAX_ITER <- 5000
  
  # Convergence Thresholds
  LOSS_THRESH <- 1e-5
  SAME_THRESH <- 1e-4
  
  if (is.vector(LOD)) {
    empty = matrix(1, nrow = nrow(D), ncol = ncol(D))
    LOD = t(t(empty) * LOD)
  }
  
  loss <- vector("numeric", MAX_ITER)
  
  for (i in 1:MAX_ITER) {
    
    nuc <- prox_nuclear( ((L2 + L3 - (Z1 + Z2)/rho)/2), 1/2/rho)
    L1 <- nuc[[1]]
    nuclearL1 <- nuc[[2]] #nuclearX
    
    S1 <- prox_l1((S2 - Z3/rho), lambda/rho)
    
      L2_opt1 <- (mu*rho*D     + (mu + rho)*Z1 - mu*Z3 + (mu + rho)*rho*L1 - mu*rho*S1) / (2*mu*rho + rho^2)
      L2_opt2 <- L1 + Z1/rho
      L2_opt3 <- ((mu*rho*LOD + (((mu + rho)*Z1) - (mu*Z3) + ((mu + rho)*rho*L1) - (mu*rho*S1)))) / ((2*mu*rho) + (rho^2))
      L2_opt4 <- (               (mu + rho)*Z1 - mu*Z3 + (mu + rho)*rho*L1 - mu*rho*S1) / (2*mu*rho + rho^2)

      L2_new <- (L2_opt1 * (D >= 0)) +
        (L2_opt2 * ((D < 0) & (((L2 + S2) >= 0) & ((L2 + S2) <= LOD)))) +
        (L2_opt3 * ((D < 0) & (((L2 + S2) > LOD)))) +
        (L2_opt4 * ((D < 0) & (((L2 + S2) < 0))))

      S2_opt1 <- (mu*rho*D     + (mu + rho)*Z3 - (mu*Z1) + (mu + rho)*rho*S1 - mu*rho*L1) / (2*mu*rho + rho^2)
      S2_opt2 <- S1 + (Z3/rho)
      S2_opt3 <- (((mu*rho*LOD) + (((mu + rho)*Z3) - (mu*Z1) + ((mu + rho)*rho*S1) - (mu*rho*L1)))) / ((2*mu*rho) + (rho^2))
      S2_opt4 <- (               (mu + rho)*Z3 - (mu*Z1) + (mu + rho)*rho*S1 - mu*rho*L1) / (2*mu*rho + rho^2)

      S2 <- (S2_opt1 * (D >= 0)) +
        (S2_opt2 * (((D < 0) & ((L2 + S2) >= 0) & ((L2 + S2) <= LOD)))) +
        (S2_opt3 * (((D < 0) & ((L2 + S2) > LOD)))) +
        (S2_opt4 * (((D < 0) & ((L2 + S2) < 0))))
   
    L2 <- L2_new
    
    L3 <- pmax(L1 + Z2/rho, 0, na.rm = TRUE)
    # % Non-Negativity constraint!
    
    Z1 <- Z1 + rho*(L1 - L2)
    Z2 <- Z2 + rho*(L1 - L3)
    Z3 <- Z3 + rho*(S1 - S2)
    # % Z accumulate differnces between L and L and between S and S
    
    loss[i] <- nuclearL1 + 
      (lambda*sum(abs(S1))) +
      (mu*loss_lod((L2 + S2), D, LOD)) +
      sum(Z1*(L1 - L2)) +
      sum(Z2*(L1 - L3)) +
      sum(Z3*(S1 - S2)) +
      (rho/2 * (sum((L1-L2)^2) + sum((L1 - L3)^2) + sum((S1 - S2)^2)))
    # % The code block above takes LOD into account.
    
    print(str_c(i, " Obj: ", loss[i]))
        
    if ((i != 1) && 
        (abs(loss[i-1] - loss[i]) < LOSS_THRESH) && 
        is_same(SAME_THRESH, L1, L2, L3) &&
        is_same(SAME_THRESH, S1, S2)) {
      break} # % Convergence criteria!
  }
  
  L <- L3 # (L1 + L2 + L3) / 3
  S <- S1 #(S1 + S2) / 2
  list(L = L, S = S, loss = loss)
}

soft_thresholding <- function(v, lambda) {
  myzero <- matrix(data = 0, ncol = ncol(v), nrow = nrow(v))
  w <- sign(v) * pmax(abs(v) - lambda, myzero)
  w
} 

soft_thresholding_diag <- function(v, lambda) {
  myzero <- vector("numeric", length = length(v))
  w <- sign(v) * pmax(abs(v) - lambda, myzero)
  w
} 

singular_value_threshold <- function(M, lambda) {
  
  USV <- svd(M)
  U <- USV$u
  S <- USV$d
  V <- USV$v
    
  N <- U %*% diag(soft_thresholding_diag(S, lambda)) %*% t(V)
  
  v  <- sum(soft_thresholding_diag(S, lambda))
  
  svt <- list(N = N, v = v) 
  svt
}

original_pcp <- function(D, lambda, mu) {
  
  m <- nrow(D)
  n <- ncol(D)
  
  S <- matrix(0, nrow = m, ncol = n)
  L <- matrix(0, nrow = m, ncol = n)
  
  iter <- 0
  MAX_ITER <- 5000
  done <- FALSE
  
  # Convergence Thresholds
  LOSS_THRESH <- 1e-4
  loss <- vector("numeric", MAX_ITER)
  
  while (!done) {
    
    iter <- iter + 1
    
    svt <- singular_value_threshold((D - S), 1/mu)
    L <- svt[[1]] #svt$N
    v <- svt[[2]]
    
    S <- soft_thresholding((D - L), lambda/mu)
    
    obj <- v + lambda * sum(abs(S)) + (mu/2) * norm((D - L - S), type = "F")^2
    loss[iter] <- obj
    
    print(str_c(iter, " Obj: ", obj))
    
    if (iter >= MAX_ITER | 
        (iter != 1) && (abs(loss[iter-1] - loss[iter]) < LOSS_THRESH)) {done <- TRUE}
    
  }
  list(L = L, S = S, Lambda = lambda, Mu = mu, obj_value = obj)
}

pcp_lod_nnS <- function(D, lambda, mu, LOD) {
  
  m <- nrow(D)
  n <- ncol(D)
  rho <- 1 # Augmented Lagrangian coefficient (rate)
  
  L1 <- matrix(0, m, n)
  L2 <- matrix(0, m, n)
  L3 <- matrix(0, m, n)
  
  S1 <- matrix(0, m, n)
  S2 <- matrix(0, m, n)
  S3 <- matrix(0, m, n) # ADDED
  
  Z1 <- matrix(0, m, n)
  Z2 <- matrix(0, m, n)
  Z3 <- matrix(0, m, n)
  Z4 <- matrix(0, m, n) # ADDED
  
  # Max iteration
  MAX_ITER <- 5000
  
  # Convergence Thresholds
  LOSS_THRESH <- 1e-5
  SAME_THRESH <- 1e-4
  
  if (is.vector(LOD)) {
  #tf = ifelse(D < 0, TRUE, FALSE)
  #LOD = t(t(tf) * LOD)
    empty = matrix(1, nrow = nrow(D), ncol = ncol(D))
    LOD = t(t(empty) * LOD)
    }
  
  loss <- vector("numeric", MAX_ITER)
  
  for (i in 1:MAX_ITER) {
    
    nuc <- prox_nuclear(((L2 + L3 - (Z1 + Z2)/rho)/2), 1/2/rho)
    L1 <- nuc[[1]]
    nuclearL1 <- nuc[[2]] #nuclearX
    
    S1 <- prox_l1(((S2 + S3 - (Z3 + Z4)/rho)/2), lambda/rho) # ADDED
      #prox_l1(S2 - Z3/rho, lambda/rho)
      #prox_l1(((S2 + S3 - (Z3 + Z4)/rho)), lambda/rho) # ADDED
    
    L2_opt1 <- (mu*rho*D     + (mu + rho)*Z1 - mu*Z3 + (mu + rho)*rho*L1 - mu*rho*S1) / (2*mu*rho + rho^2)
    L2_opt2 <- L1 + Z1/rho
    L2_opt3 <- ((mu*rho*LOD + (((mu + rho)*Z1) - (mu*Z3) + ((mu + rho)*rho*L1) - (mu*rho*S1)))) / ((2*mu*rho) + (rho^2))
    L2_opt4 <- (               (mu + rho)*Z1 - mu*Z3 + (mu + rho)*rho*L1 - mu*rho*S1) / (2*mu*rho + rho^2)

    L2 <- (L2_opt1 * (D >= 0)) +
        (L2_opt2 * ((D < 0) & (((L2 + S2) >= 0) & ((L2 + S2) <= LOD)))) +
        (L2_opt3 * ((D < 0) & (((L2 + S2) > LOD)))) +
        (L2_opt4 * ((D < 0) & (((L2 + S2) < 0))))

    S2_opt1 <- (mu*rho*D     + (mu + rho)*Z3 - (mu*Z1) + (mu + rho)*rho*S1 - mu*rho*L1) / (2*mu*rho + rho^2)
    S2_opt2 <- S1 + (Z3/rho)
    S2_opt3 <- (((mu*rho*LOD) + (((mu + rho)*Z3) - (mu*Z1) + ((mu + rho)*rho*S1) - (mu*rho*L1)))) / ((2*mu*rho) + (rho^2))
    S2_opt4 <- (               (mu + rho)*Z3 - (mu*Z1) + (mu + rho)*rho*S1 - mu*rho*L1) / (2*mu*rho + rho^2)

    S2 <- (S2_opt1 * (D >= 0)) +
        (S2_opt2 * (((D < 0) & ((L2 + S2) >= 0) & ((L2 + S2) <= LOD)))) +
        (S2_opt3 * (((D < 0) & ((L2 + S2) > LOD)))) +
        (S2_opt4 * (((D < 0) & ((L2 + S2) < 0))))
      
    L3 <- pmax(L1 + Z2/rho, 0, na.rm = TRUE)
    # % Non-Negativity constraint!
    
    ## ADDED
    S3 <- pmax(S1 + Z4/rho, 0, na.rm = TRUE)
    
    Z1 <- Z1 + rho*(L1 - L2)
    Z2 <- Z2 + rho*(L1 - L3)
    Z3 <- Z3 + rho*(S1 - S2)
    Z4 <- Z4 + rho*(S1 - S3) # ADDED
    # % Z accumulate differnces between L and L and between S and S
    
    loss[i] <- nuclearL1 + 
      (lambda*sum(abs(S1))) +
      (mu*loss_lod((L2 + S2), D, LOD)) +
      sum(Z1*(L1 - L2)) +
      sum(Z2*(L1 - L3)) +
      sum(Z3*(S1 - S2)) +
      sum(Z4*(S1 - S3)) + # ADDED
      (rho/2 * (sum((L1-L2)^2) + sum((L1 - L3)^2) + sum((S1 - S2)^2)) + sum((S1 - S3)^2)) # ADDED
    # % The code block above takes LOD into account.
    
    print(str_c(i, " Obj: ", loss[i]))
        
    if ((i != 1) && 
        (abs(loss[i-1] - loss[i]) < LOSS_THRESH) && 
        is_same(SAME_THRESH, L1, L2, L3) &&
        is_same(SAME_THRESH, S1, S2, S3)) { # ADDED
      break} # % Convergence criteria!
  }
  
  L <- L3 # (L1 + L2 + L3) / 3
  S <- S3 # (S1 + S2 + S3) / 2
  list(L = L, S = S, loss = loss)
}
```

```{r, code_0, include = FALSE, cache = TRUE}
m <- nrow(sim_all$sims[[1]])
p <- ncol(sim_all$sims[[1]])

lambda_mix <- 1/sqrt(m)
mu_mix <- sqrt(p/(2*log(m*p)))

sim_all <- sim_all %>% mutate(sims = map(sims, as.matrix))
#original_pcp(as.matrix(sim_all$sims[[1]]), lambda_mix, mu_mix)

sim_all <- sim_all %>% 
  mutate(results_0_0  = pmap(list(sims, lambda_mix, mu_mix), function(x,y,z) original_pcp(x,y,z)),
         results_10_0 = pmap(list(mix_data_lod_10_0, lambda_mix, mu_mix), 
                           function(x,y,z) original_pcp(x,y,z)),
         results_20_0 = pmap(list(mix_data_lod_20_0, lambda_mix, mu_mix), 
                           function(x,y,z) original_pcp(x,y,z)),
         results_30_0 = pmap(list(mix_data_lod_30_0, lambda_mix, mu_mix), 
                           function(x,y,z) original_pcp(x,y,z)),
         results_40_0 = pmap(list(mix_data_lod_40_0, lambda_mix, mu_mix), 
                           function(x,y,z) original_pcp(x,y,z)),
         results_50_0 = pmap(list(mix_data_lod_50_0, lambda_mix, mu_mix), 
                           function(x,y,z) original_pcp(x,y,z)))
```

```{r, code_2, include = FALSE, cache = TRUE}
sim_all <- sim_all %>% 
  mutate(results_0_2  = pmap(list(sims, lambda_mix, mu_mix), function(x,y,z) original_pcp(x,y,z)),
         results_10_2 = pmap(list(mix_data_lod_10_2, lambda_mix, mu_mix), 
                           function(x,y,z) original_pcp(x,y,z)),
         results_20_2 = pmap(list(mix_data_lod_20_2, lambda_mix, mu_mix), 
                           function(x,y,z) original_pcp(x,y,z)),
         results_30_2 = pmap(list(mix_data_lod_30_2, lambda_mix, mu_mix), 
                           function(x,y,z) original_pcp(x,y,z)),
         results_40_2 = pmap(list(mix_data_lod_40_2, lambda_mix, mu_mix), 
                           function(x,y,z) original_pcp(x,y,z)),
         results_50_2 = pmap(list(mix_data_lod_50_2, lambda_mix, mu_mix), 
                           function(x,y,z) original_pcp(x,y,z)))
```

```{r, code_sqrt2, include = FALSE, cache = TRUE}
sim_all <- sim_all %>% 
  mutate(results_0_sqrt2  = pmap(list(sims, lambda_mix, mu_mix), function(x,y,z) original_pcp(x,y,z)),
         results_10_sqrt2 = pmap(list(mix_data_lod_10_sqrt2, lambda_mix, mu_mix), 
                           function(x,y,z) original_pcp(x,y,z)),
         results_20_sqrt2 = pmap(list(mix_data_lod_20_sqrt2, lambda_mix, mu_mix), 
                           function(x,y,z) original_pcp(x,y,z)),
         results_30_sqrt2 = pmap(list(mix_data_lod_30_sqrt2, lambda_mix, mu_mix), 
                           function(x,y,z) original_pcp(x,y,z)),
         results_40_sqrt2 = pmap(list(mix_data_lod_40_sqrt2, lambda_mix, mu_mix), 
                           function(x,y,z) original_pcp(x,y,z)),
         results_50_sqrt2 = pmap(list(mix_data_lod_50_sqrt2, lambda_mix, mu_mix), 
                           function(x,y,z) original_pcp(x,y,z)))
```

```{r, jingkai_leave, include = FALSE, cache = TRUE}
sim_all <- sim_all %>% 
  mutate(sims = map(sims, as.matrix),
         results_0  = pmap(list(sims, lambda_mix, mu_mix, 0), function(x,y,z,a) pcp_lod(x,y,z,a)),
         results_10 = pmap(list(mix_data_lod_10, lambda_mix, mu_mix, delta10), 
                           function(x,y,z,a) pcp_lod(x,y,z,a)),
         results_20 = pmap(list(mix_data_lod_20, lambda_mix, mu_mix, delta20), 
                           function(x,y,z,a) pcp_lod(x,y,z,a)),
         results_30 = pmap(list(mix_data_lod_30, lambda_mix, mu_mix, delta30), 
                           function(x,y,z,a) pcp_lod(x,y,z,a)),
         results_40 = pmap(list(mix_data_lod_40, lambda_mix, mu_mix, delta40), 
                           function(x,y,z,a) pcp_lod(x,y,z,a)),
         results_50 = pmap(list(mix_data_lod_50, lambda_mix, mu_mix, delta50), 
                           function(x,y,z,a) pcp_lod(x,y,z,a)))

# norm((sim_all$sims[[1]] - sim_all$results_50[[2]]$L - sim_all$results_50[[1]]$S), type = "F")/
#  norm((sim_all$sims[[1]]), type = "F")
```

```{r, code_nns, include = FALSE, cache = TRUE}
sim_all <- sim_all %>% 
  mutate(results_0_nnS = pmap(list(sims, lambda_mix, mu_mix, 0), function(x,y,z,a) pcp_lod_nnS(x,y,z,a)),
         results_10_nnS = pmap(list(mix_data_lod_10, lambda_mix, mu_mix, delta10), 
                           function(x,y,z,a) pcp_lod_nnS(x,y,z,a)),
         results_20_nnS = pmap(list(mix_data_lod_20, lambda_mix, mu_mix, delta20), 
                           function(x,y,z,a) pcp_lod_nnS(x,y,z,a)),
         results_30_nnS = pmap(list(mix_data_lod_30, lambda_mix, mu_mix, delta30), 
                           function(x,y,z,a) pcp_lod_nnS(x,y,z,a)),
         results_40_nnS = pmap(list(mix_data_lod_40, lambda_mix, mu_mix, delta40), 
                           function(x,y,z,a) pcp_lod_nnS(x,y,z,a)),
         results_50_nnS = pmap(list(mix_data_lod_50, lambda_mix, mu_mix, delta50), 
                           function(x,y,z,a) pcp_lod_nnS(x,y,z,a)))
```

```{r, extract, include = FALSE, cache = TRUE}
extract_l <- function (results) {
  L <- as.matrix(results$L)
  L
}

extract_s <- function (results) {
  S <- as.matrix(results$S)
  S
}

sim_all <- sim_all %>% 
  mutate(L_lod0  = map(results_0, extract_l),
         S_lod0  = map(results_0, extract_s),
         L_lod10 = map(results_10, extract_l),
         S_lod10 = map(results_10, extract_s),
         L_lod20 = map(results_20, extract_l),
         S_lod20 = map(results_20, extract_s),
         L_lod30 = map(results_30, extract_l),
         S_lod30 = map(results_30, extract_s),
         L_lod40 = map(results_40, extract_l),
         S_lod40 = map(results_40, extract_s),
         L_lod50 = map(results_50, extract_l),
         S_lod50 = map(results_50, extract_s))

#extract_l(sim_all$results_0[[1]])

# head(sim_all[1,]$results_0[[1]]$L)[,1:5]
# sim_all %>% mutate(L_lod0  = map(results_0[[1]], as_tibble)) %>% select(L_lod0) %>% .[1,1] %>% unnest(cols = c(L_lod0))
# sim_all %>% mutate(L_lod0  = map(results_0[[1]][1], as_tibble)) %>% select(L_lod0) %>% unnest(cols = c(L_lod0))
# sim_all %>% select(L_lod0) %>% mutate_all(as_tibble) %>% unnest(cols = c(L_lod0))
# 
# sim_all %>%
#   select(seed, results_0) %>% 
#   mutate(L_lod0 = map(results_0, extract_l)) %>% select(L_lod0)
# 
#   mutate(L_lod0  = map(results_0[[1]][[1]][1], as_tibble))
#          
# # EQUAL
# head(sim_all$results_0[[1]]$L)[,1:5]
# head(sim_all$L_lod0[[1]])[,1:5]
# 
# # NOT EQUAL
# norm((sim_all$sims[[3]] - sim_all$results_50[[3]]$L - sim_all$results_50[[3]]$S), type = "F")/
#   norm((sim_all$sims[[3]]), type = "F")
# norm((sim_all$sims[[3]] - as.matrix(sim_all$L_lod50[[3]]) - as.matrix(sim_all$S_lod50[[3]])), type = "F")/
#  norm((sim_all$sims[[3]]), type = "F")

sim_all <- sim_all %>% 
  mutate(L_lod0_0  = map(results_0_0, extract_l),
         S_lod0_0  = map(results_0_0, extract_s),
         L_lod10_0 = map(results_10_0, extract_l),
         S_lod10_0 = map(results_10_0, extract_s),
         L_lod20_0 = map(results_20_0, extract_l),
         S_lod20_0 = map(results_20_0, extract_s),
         L_lod30_0 = map(results_30_0, extract_l),
         S_lod30_0 = map(results_30_0, extract_s),
         L_lod40_0 = map(results_40_0, extract_l),
         S_lod40_0 = map(results_40_0, extract_s),
         L_lod50_0 = map(results_50_0, extract_l),
         S_lod50_0 = map(results_50_0, extract_s))

sim_all <- sim_all %>% 
  mutate(L_lod0_sqrt2  = map(results_0_sqrt2, extract_l),
         S_lod0_sqrt2  = map(results_0_sqrt2, extract_s),
         L_lod10_sqrt2 = map(results_10_sqrt2, extract_l),
         S_lod10_sqrt2 = map(results_10_sqrt2, extract_s),
         L_lod20_sqrt2 = map(results_20_sqrt2, extract_l),
         S_lod20_sqrt2 = map(results_20_sqrt2, extract_s),
         L_lod30_sqrt2 = map(results_30_sqrt2, extract_l),
         S_lod30_sqrt2 = map(results_30_sqrt2, extract_s),
         L_lod40_sqrt2 = map(results_40_sqrt2, extract_l),
         S_lod40_sqrt2 = map(results_40_sqrt2, extract_s),
         L_lod50_sqrt2 = map(results_50_sqrt2, extract_l),
         S_lod50_sqrt2 = map(results_50_sqrt2, extract_s))

sim_all <- sim_all %>% 
  mutate(L_lod0_2  = map(results_0_2, extract_l),
         S_lod0_2  = map(results_0_2, extract_s),
         L_lod10_2 = map(results_10_2, extract_l),
         S_lod10_2 = map(results_10_2, extract_s),
         L_lod20_2 = map(results_20_2, extract_l),
         S_lod20_2 = map(results_20_2, extract_s),
         L_lod30_2 = map(results_30_2, extract_l),
         S_lod30_2 = map(results_30_2, extract_s),
         L_lod40_2 = map(results_40_2, extract_l),
         S_lod40_2 = map(results_40_2, extract_s),
         L_lod50_2 = map(results_50_2, extract_l),
         S_lod50_2 = map(results_50_2, extract_s))

sim_all <- sim_all %>% 
  mutate(L_lod0_nnS  = map(results_0_nnS, extract_l),
         S_lod0_nnS  = map(results_0_nnS, extract_s),
         L_lod10_nnS = map(results_10_nnS, extract_l),
         S_lod10_nnS = map(results_10_nnS, extract_s),
         L_lod20_nnS = map(results_20_nnS, extract_l),
         S_lod20_nnS = map(results_20_nnS, extract_s),
         L_lod30_nnS = map(results_30_nnS, extract_l),
         S_lod30_nnS = map(results_30_nnS, extract_s),
         L_lod40_nnS = map(results_40_nnS, extract_l),
         S_lod40_nnS = map(results_40_nnS, extract_s),
         L_lod50_nnS = map(results_50_nnS, extract_l),
         S_lod50_nnS = map(results_50_nnS, extract_s))

# sim_all <- sim_all %>% 
#   select(-grep("results", colnames(.))) %>% 
#   modify_depth(2, as.matrix)
```

## X - L - S

```{r, xls, include=FALSE, cache=TRUE}
make_fnorm <- function (mix, L0, S0, L10, S10, L20, S20, L30, S30, L40, S40, L50, S50, Name) {
  F_norm <- as_tibble(cbind(`0%` = norm((mix - L0 - S0), type = "F")/norm((mix), type = "F"),
      `10%` = norm((mix - L10 - S10), type = "F")/norm((mix), type = "F"),
      `20%` = norm((mix - L20 - S20), type = "F")/norm((mix), type = "F"),
      `30%` = norm((mix - L30 - S30), type = "F")/norm((mix), type = "F"),
      `40%` = norm((mix - L40 - S40), type = "F")/norm((mix), type = "F"),
      `50%` = norm((mix - L50 - S50), type = "F")/norm((mix), type = "F"))) %>% 
    gather(percent_blod, norm) %>% 
    mutate(Method = Name)
  F_norm
}

#norm((sim_all$sims[[3]] - sim_all$L_lod0[[3]] - sim_all$S_lod0[[3]]), type = "F")/norm((sim_all$sims[[3]]), type = "F")

sim_f <- sim_all %>% 
  mutate(F_norm = pmap(list(sims, L_lod0, S_lod0, L_lod10, S_lod10, L_lod20, S_lod20, 
                            L_lod30, S_lod30, L_lod40, S_lod40, L_lod50, S_lod50, "LOD PCP"), make_fnorm),
         F_norm_2 = pmap(list(sims, L_lod0_2, S_lod0_2, L_lod10_2, S_lod10_2, L_lod20_2, S_lod20_2, 
                            L_lod30_2, S_lod30_2, L_lod40_2, S_lod40_2, L_lod50_2, S_lod50_2, 
                            "PCP w/ LOD/2"), make_fnorm),
         F_norm_sqrt2 = pmap(list(sims, L_lod0_sqrt2, S_lod0_sqrt2, L_lod10_sqrt2, S_lod10_sqrt2, L_lod20_sqrt2, 
                                  S_lod20_sqrt2, L_lod30_sqrt2, S_lod30_sqrt2, L_lod40_sqrt2, S_lod40_sqrt2, 
                                  L_lod50_sqrt2, S_lod50_sqrt2, paste0("PCP w/ LOD/", intToUtf8(8730),2)), make_fnorm),
         F_norm_nnS = pmap(list(sims, L_lod0_nnS, S_lod0_nnS, L_lod10_nnS, S_lod10_nnS, L_lod20_nnS, S_lod20_nnS, 
                            L_lod30_nnS, S_lod30_nnS, L_lod40_nnS, S_lod40_nnS, L_lod50_nnS, 
                            S_lod50_nnS, "LOD PCP nnS"), make_fnorm),
         F_norm_0 = pmap(list(sims, L_lod0_0, S_lod0_0, L_lod10_0, S_lod10_0, L_lod20_0, S_lod20_0, 
                            L_lod30_0, S_lod30_0, L_lod40_0, S_lod40_0, L_lod50_0, S_lod50_0, "PCP w/ 0"), make_fnorm))
```

* X = simulated dataset
* L = low rank solution matrix
* S = sparse solution matrix

```{r, fig.align = "center"}
out_f <- sim_f %>% 
  select(seed, F_norm) %>% 
  unnest(cols = c(F_norm)) %>% 
  rbind(., sim_f %>% 
  select(seed, F_norm_0) %>% 
  unnest(cols = c(F_norm_0))) %>% 
  rbind(., sim_f %>% 
  select(seed, F_norm_sqrt2) %>% 
  unnest(cols = c(F_norm_sqrt2))) %>% 
  rbind(., sim_f %>% 
  select(seed, F_norm_2) %>% 
  unnest(cols = c(F_norm_2))) %>% 
  rbind(., sim_f %>% 
  select(seed, F_norm_nnS) %>% 
  unnest(cols = c(F_norm_nnS)))
  
out_f %>% ggplot(aes(x = percent_blod, y = norm, group = interaction(seed, Method))) + 
  geom_point(aes(color = Method)) + geom_path(aes(color = Method)) + theme_bw() +
  labs(x = "Percent Below LOD", y = "norm(X-L-S) / norm(X)",
       title = "Relative Prediction Error")
```

## Individual Solution Matrices

```{r, ind, include=FALSE, cache= TRUE}
make_Ldiff <- function (L0, L10, L20, L30, L40, L50, Name) {
  L_norm <- as_tibble(cbind(`0%` = norm((L0 - L0), type = "F")/norm((L0), type = "F"),
      `10%` = norm((L0 - L10), type = "F")/norm((L0), type = "F"),
      `20%` = norm((L0 - L20), type = "F")/norm((L0), type = "F"),
      `30%` = norm((L0 - L30), type = "F")/norm((L0), type = "F"),
      `40%` = norm((L0 - L40), type = "F")/norm((L0), type = "F"),
      `50%` = norm((L0 - L50), type = "F")/norm((L0), type = "F"))) %>% 
    gather(percent_blod, norm) %>% 
    mutate(Matrix = "Low-Rank",
           Method = Name)
  L_norm
}

make_Sdiff <- function (S0, S10, S20, S30, S40, S50, Name) {
  S_norm <- as_tibble(cbind(`0%` = norm((S0 - S0), type = "F")/norm((S0), type = "F"),
      `10%` = norm((S0 - S10), type = "F")/norm((S0), type = "F"),
      `20%` = norm((S0 - S20), type = "F")/norm((S0), type = "F"),
      `30%` = norm((S0 - S30), type = "F")/norm((S0), type = "F"),
      `40%` = norm((S0 - S40), type = "F")/norm((S0), type = "F"),
      `50%` = norm((S0 - S50), type = "F")/norm((S0), type = "F"))) %>% 
    gather(percent_blod, norm) %>% 
    mutate(Matrix = "Sparse",
           Method = Name)
  S_norm
}

sim_ls <- sim_all %>% 
  mutate(L_diff = pmap(list(L_lod0, L_lod10, L_lod20, 
                            L_lod30, L_lod40, L_lod50, "LOD PCP"), make_Ldiff),
         L_diff_2 = pmap(list(L_lod0_2, L_lod10_2, L_lod20_2, 
                            L_lod30_2, L_lod40_2, L_lod50_2, 
                            "PCP w/ LOD/2"), make_Ldiff),
         L_diff_sqrt2 = pmap(list(L_lod0_sqrt2, L_lod10_sqrt2, L_lod20_sqrt2, 
                                L_lod30_sqrt2, L_lod40_sqrt2, 
                                  L_lod50_sqrt2, paste0("PCP w/ LOD/", intToUtf8(8730),2)), make_Ldiff),
         L_diff_nnS = pmap(list(L_lod0_nnS, L_lod10_nnS, L_lod20_nnS, 
                            L_lod30_nnS, L_lod40_nnS, L_lod50_nnS, "LOD PCP nnS"), make_Ldiff),
         L_diff_0 = pmap(list(L_lod0_0, L_lod10_0, L_lod20_0, 
                            L_lod30_0, L_lod40_0, L_lod50_0, "PCP w/ 0"), make_Ldiff)) %>% 
  mutate(S_diff = pmap(list(S_lod0, S_lod10, S_lod20, 
                          S_lod30, S_lod40, S_lod50, "LOD PCP"), make_Sdiff),
       S_diff_2 = pmap(list(S_lod0_2, S_lod10_2, S_lod20_2, 
                            S_lod30_2, S_lod40_2, S_lod50_2, 
                            "PCP w/ LOD/2"), make_Sdiff),
       S_diff_sqrt2 = pmap(list(S_lod0_sqrt2, S_lod10_sqrt2, S_lod20_sqrt2, 
                                S_lod30_sqrt2, S_lod40_sqrt2, 
                                S_lod50_sqrt2, paste0("PCP w/ LOD/", intToUtf8(8730),2)), make_Sdiff),
       S_diff_nnS = pmap(list(S_lod0_nnS, S_lod10_nnS, S_lod20_nnS, 
                              S_lod30_nnS, S_lod40_nnS, S_lod50_nnS, "LOD PCP nnS"), make_Sdiff),
       S_diff_0 = pmap(list(S_lod0_0, S_lod10_0, S_lod20_0, 
                            S_lod30_0, S_lod40_0, S_lod50_0, "PCP w/ 0"), make_Sdiff))

```

* Reference is solution matix with 0\% \<LOD  
* Low rank solution matrices compared with low rank solution with 0\% \<LOD
* Sparse solution matrices compared with sparse solution with 0\% \<LOD

```{r, fig.align = "center"}
out_ls <- sim_ls %>% 
  select(seed, L_diff) %>% 
  unnest(cols = c(L_diff)) %>% 
  rbind(., sim_ls %>% 
          select(seed, L_diff_0) %>% 
          unnest(cols = c(L_diff_0))) %>% 
  rbind(., sim_ls %>% 
          select(seed, L_diff_sqrt2) %>% 
          unnest(cols = c(L_diff_sqrt2))) %>% 
  rbind(., sim_ls %>% 
          select(seed, L_diff_2) %>% 
          unnest(cols = c(L_diff_2))) %>% 
  rbind(., sim_ls %>% 
          select(seed, L_diff_nnS) %>% 
          unnest(cols = c(L_diff_nnS))) %>% 
  rbind(., sim_ls %>% 
          select(seed, S_diff_0) %>% 
          unnest(cols = c(S_diff_0))) %>% 
  rbind(., sim_ls %>% 
          select(seed, S_diff_sqrt2) %>% 
          unnest(cols = c(S_diff_sqrt2))) %>% 
  rbind(., sim_ls %>% 
          select(seed, S_diff_2) %>% 
          unnest(cols = c(S_diff_2))) %>% 
  rbind(., sim_ls %>% 
          select(seed, S_diff_nnS) %>% 
          unnest(cols = c(S_diff_nnS))) %>% 
  rbind(., sim_ls %>% 
          select(seed, S_diff) %>% 
          unnest(cols = c(S_diff))) 

out_ls %>% 
  ggplot(aes(x = percent_blod, y = norm, group = interaction(Matrix,Method,seed), color = Method)) + 
  geom_point() + geom_path(aes(linetype = Matrix)) + theme_bw() +
  labs(x = "Percent Below LOD", y = "norm(difference) / norm(lod0))",
       title = "Relative Error in Solution Matrices")
```

## Values \<LOD vs \>LOD

```{r, above_below, include=FALSE, cache = TRUE, cache.lazy=FALSE}
create_lsbelow <- function (sim_neg1, solution) {
  tf_lod <- sim_neg1 %>% 
  as_tibble() %>% 
  mutate_all(function(x) ifelse(x == -1, TRUE, FALSE))
  
  above_below <- as.matrix(solution*tf_lod)
  above_below
}

create_lsabove <- function (sim_neg1, solution) {
  tf_lod <- sim_neg1 %>% 
  as_tibble() %>% 
  mutate_all(function(x) ifelse(x == -1, FALSE, TRUE))
  
  ls_above <- as.matrix(tf_lod*solution)
  ls_above
}

sim_all <- sim_all %>%
  select(-grep("results", colnames(.))) %>%
  modify_depth(2, as.matrix)

sim_all <- sim_all %>% 
  mutate(blod_0 = map2(sims, sims, create_lsbelow),
         blod_10 = map2(mix_data_lod_10, sims, create_lsbelow),
         blod_20 = map2(mix_data_lod_20, sims, create_lsbelow),
         blod_30 = map2(mix_data_lod_30, sims, create_lsbelow),
         blod_40 = map2(mix_data_lod_40, sims, create_lsbelow),
         blod_50 = map2(mix_data_lod_50, sims, create_lsbelow))
```

```{r, above_below2, include=FALSE, cache = TRUE, cache.lazy=FALSE}
sim_all <- sim_all %>% 
  mutate(l_blod_0 = map2(as.matrix(sims), L_lod0, create_lsbelow),
         s_blod_0 = map2(sims, S_lod0, create_lsbelow),
         l_blod_10 = map2(mix_data_lod_10, L_lod10, create_lsbelow),
         s_blod_10 = map2(mix_data_lod_10, S_lod10, create_lsbelow),
         l_blod_20 = map2(mix_data_lod_20, L_lod20, create_lsbelow),
         s_blod_20 = map2(mix_data_lod_20, S_lod20, create_lsbelow),
         l_blod_30 = map2(mix_data_lod_30, L_lod30, create_lsbelow),
         s_blod_30 = map2(mix_data_lod_30, S_lod30, create_lsbelow),
         l_blod_40 = map2(mix_data_lod_40, L_lod40, create_lsbelow),
         s_blod_40 = map2(mix_data_lod_40, S_lod40, create_lsbelow),
         l_blod_50 = map2(mix_data_lod_50, L_lod50, create_lsbelow),
         s_blod_50 = map2(mix_data_lod_50, S_lod50, create_lsbelow),
         l_blod_0_0 = map2(sims, L_lod0_0, create_lsbelow),
       s_blod_0_0 = map2(sims, S_lod0_0, create_lsbelow),
       l_blod_10_0 = map2(mix_data_lod_10, L_lod10_0, create_lsbelow),
       s_blod_10_0 = map2(mix_data_lod_10, S_lod10_0, create_lsbelow),
       l_blod_20_0 = map2(mix_data_lod_20, L_lod20_0, create_lsbelow),
       s_blod_20_0 = map2(mix_data_lod_20, S_lod20_0, create_lsbelow),
       l_blod_30_0 = map2(mix_data_lod_30, L_lod30_0, create_lsbelow),
       s_blod_30_0 = map2(mix_data_lod_30, S_lod30_0, create_lsbelow),
       l_blod_40_0 = map2(mix_data_lod_40, L_lod40_0, create_lsbelow),
       s_blod_40_0 = map2(mix_data_lod_40, S_lod40_0, create_lsbelow),
       l_blod_50_0 = map2(mix_data_lod_50, L_lod50_0, create_lsbelow),
       s_blod_50_0 = map2(mix_data_lod_50, S_lod50_0, create_lsbelow),
       l_blod_0_sqrt2 = map2(sims, L_lod0_sqrt2, create_lsbelow),
       s_blod_0_sqrt2 = map2(sims, S_lod0_sqrt2, create_lsbelow),
       l_blod_10_sqrt2 = map2(mix_data_lod_10, L_lod10_sqrt2, create_lsbelow),
       s_blod_10_sqrt2 = map2(mix_data_lod_10, S_lod10_sqrt2, create_lsbelow),
       l_blod_20_sqrt2 = map2(mix_data_lod_20, L_lod20_sqrt2, create_lsbelow),
       s_blod_20_sqrt2 = map2(mix_data_lod_20, S_lod20_sqrt2, create_lsbelow),
       l_blod_30_sqrt2 = map2(mix_data_lod_30, L_lod30_sqrt2, create_lsbelow),
       s_blod_30_sqrt2 = map2(mix_data_lod_30, S_lod30_sqrt2, create_lsbelow),
       l_blod_40_sqrt2 = map2(mix_data_lod_40, L_lod40_sqrt2, create_lsbelow),
       s_blod_40_sqrt2 = map2(mix_data_lod_40, S_lod40_sqrt2, create_lsbelow),
       l_blod_50_sqrt2 = map2(mix_data_lod_50, L_lod50_sqrt2, create_lsbelow),
       s_blod_50_sqrt2 = map2(mix_data_lod_50, S_lod50_sqrt2, create_lsbelow),
       l_blod_0_2 = map2(sims, L_lod0_2, create_lsbelow),
       s_blod_0_2 = map2(sims, S_lod0_2, create_lsbelow),
       l_blod_10_2 = map2(mix_data_lod_10, L_lod10_2, create_lsbelow),
       s_blod_10_2 = map2(mix_data_lod_10, S_lod10_2, create_lsbelow),
       l_blod_20_2 = map2(mix_data_lod_20, L_lod20_2, create_lsbelow),
       s_blod_20_2 = map2(mix_data_lod_20, S_lod20_2, create_lsbelow),
       l_blod_30_2 = map2(mix_data_lod_30, L_lod30_2, create_lsbelow),
       s_blod_30_2 = map2(mix_data_lod_30, S_lod30_2, create_lsbelow),
       l_blod_40_2 = map2(mix_data_lod_40, L_lod40_2, create_lsbelow),
       s_blod_40_2 = map2(mix_data_lod_40, S_lod40_2, create_lsbelow),
       l_blod_50_2 = map2(mix_data_lod_50, L_lod50_2, create_lsbelow),
       s_blod_50_2 = map2(mix_data_lod_50, S_lod50_2, create_lsbelow),
       l_blod_0_nnS = map2(sims, L_lod0_nnS, create_lsbelow),
       s_blod_0_nnS = map2(sims, S_lod0_nnS, create_lsbelow),
       l_blod_10_nnS = map2(mix_data_lod_10, L_lod10_nnS, create_lsbelow),
       s_blod_10_nnS = map2(mix_data_lod_10, S_lod10_nnS, create_lsbelow),
       l_blod_20_nnS = map2(mix_data_lod_20, L_lod20_nnS, create_lsbelow),
       s_blod_20_nnS = map2(mix_data_lod_20, S_lod20_nnS, create_lsbelow),
       l_blod_30_nnS = map2(mix_data_lod_30, L_lod30_nnS, create_lsbelow),
       s_blod_30_nnS = map2(mix_data_lod_30, S_lod30_nnS, create_lsbelow),
       l_blod_40_nnS = map2(mix_data_lod_40, L_lod40_nnS, create_lsbelow),
       s_blod_40_nnS = map2(mix_data_lod_40, S_lod40_nnS, create_lsbelow),
       l_blod_50_nnS = map2(mix_data_lod_50, L_lod50_nnS, create_lsbelow),
       s_blod_50_nnS = map2(mix_data_lod_50, S_lod50_nnS, create_lsbelow))
```

```{r, above_below3, include=FALSE, cache = TRUE, cache.lazy=FALSE}
sim_all <- sim_all %>% 
  mutate(l_above_blod_0 = map2(sims, L_lod0, create_lsabove),
         s_above_blod_0 = map2(sims, S_lod0, create_lsabove),
         l_above_blod_10 = map2(mix_data_lod_10, L_lod10, create_lsabove),
         s_above_blod_10 = map2(mix_data_lod_10, S_lod10, create_lsabove),
         l_above_blod_20 = map2(mix_data_lod_20, L_lod20, create_lsabove),
         s_above_blod_20 = map2(mix_data_lod_20, S_lod20, create_lsabove),
         l_above_blod_30 = map2(mix_data_lod_30, L_lod30, create_lsabove),
         s_above_blod_30 = map2(mix_data_lod_30, S_lod30, create_lsabove),
         l_above_blod_40 = map2(mix_data_lod_40, L_lod40, create_lsabove),
         s_above_blod_40 = map2(mix_data_lod_40, S_lod40, create_lsabove),
         l_above_blod_50 = map2(mix_data_lod_50, L_lod50, create_lsabove),
         s_above_blod_50 = map2(mix_data_lod_50, S_lod50, create_lsabove),
         l_above_blod_0_0 = map2(sims, L_lod0_0, create_lsabove),
         s_above_blod_0_0 = map2(sims, S_lod0_0, create_lsabove),
         l_above_blod_10_0 = map2(mix_data_lod_10, L_lod10_0, create_lsabove),
          s_above_blod_10_0 = map2(mix_data_lod_10, S_lod10_0, create_lsabove),
          l_above_blod_20_0 = map2(mix_data_lod_20, L_lod20_0, create_lsabove),
          s_above_blod_20_0 = map2(mix_data_lod_20, S_lod20_0, create_lsabove),
          l_above_blod_30_0 = map2(mix_data_lod_30, L_lod30_0, create_lsabove),
          s_above_blod_30_0 = map2(mix_data_lod_30, S_lod30_0, create_lsabove),
          l_above_blod_40_0 = map2(mix_data_lod_40, L_lod40_0, create_lsabove),
          s_above_blod_40_0 = map2(mix_data_lod_40, S_lod40_0, create_lsabove),
          l_above_blod_50_0 = map2(mix_data_lod_50, L_lod50_0, create_lsabove),
          s_above_blod_50_0 = map2(mix_data_lod_50, S_lod50_0, create_lsabove),
          l_above_blod_0_sqrt2 = map2(sims, L_lod0_sqrt2, create_lsabove),
          s_above_blod_0_sqrt2 = map2(sims, S_lod0_sqrt2, create_lsabove),
          l_above_blod_10_sqrt2 = map2(mix_data_lod_10, L_lod10_sqrt2, create_lsabove),
          s_above_blod_10_sqrt2 = map2(mix_data_lod_10, S_lod10_sqrt2, create_lsabove),
          l_above_blod_20_sqrt2 = map2(mix_data_lod_20, L_lod20_sqrt2, create_lsabove),
          s_above_blod_20_sqrt2 = map2(mix_data_lod_20, S_lod20_sqrt2, create_lsabove),
          l_above_blod_30_sqrt2 = map2(mix_data_lod_30, L_lod30_sqrt2, create_lsabove),
          s_above_blod_30_sqrt2 = map2(mix_data_lod_30, S_lod30_sqrt2, create_lsabove),
          l_above_blod_40_sqrt2 = map2(mix_data_lod_40, L_lod40_sqrt2, create_lsabove),
          s_above_blod_40_sqrt2 = map2(mix_data_lod_40, S_lod40_sqrt2, create_lsabove),
          l_above_blod_50_sqrt2 = map2(mix_data_lod_50, L_lod50_sqrt2, create_lsabove),
          s_above_blod_50_sqrt2 = map2(mix_data_lod_50, S_lod50_sqrt2, create_lsabove),
          l_above_blod_0_2 = map2(sims, L_lod0_2, create_lsabove),
          s_above_blod_0_2 = map2(sims, S_lod0_2, create_lsabove),
          l_above_blod_10_2 = map2(mix_data_lod_10, L_lod10_2, create_lsabove),
          s_above_blod_10_2 = map2(mix_data_lod_10, S_lod10_2, create_lsabove),
          l_above_blod_20_2 = map2(mix_data_lod_20, L_lod20_2, create_lsabove),
          s_above_blod_20_2 = map2(mix_data_lod_20, S_lod20_2, create_lsabove),
          l_above_blod_30_2 = map2(mix_data_lod_30, L_lod30_2, create_lsabove),
          s_above_blod_30_2 = map2(mix_data_lod_30, S_lod30_2, create_lsabove),
          l_above_blod_40_2 = map2(mix_data_lod_40, L_lod40_2, create_lsabove),
          s_above_blod_40_2 = map2(mix_data_lod_40, S_lod40_2, create_lsabove),
          l_above_blod_50_2 = map2(mix_data_lod_50, L_lod50_2, create_lsabove),
          s_above_blod_50_2 = map2(mix_data_lod_50, S_lod50_2, create_lsabove),
          l_above_blod_0_nnS = map2(sims, L_lod0_nnS, create_lsabove),
          s_above_blod_0_nnS = map2(sims, S_lod0_nnS, create_lsabove),
          l_above_blod_10_nnS = map2(mix_data_lod_10, L_lod10_nnS, create_lsabove),
          s_above_blod_10_nnS = map2(mix_data_lod_10, S_lod10_nnS, create_lsabove),
          l_above_blod_20_nnS = map2(mix_data_lod_20, L_lod20_nnS, create_lsabove),
          s_above_blod_20_nnS = map2(mix_data_lod_20, S_lod20_nnS, create_lsabove),
          l_above_blod_30_nnS = map2(mix_data_lod_30, L_lod30_nnS, create_lsabove),
          s_above_blod_30_nnS = map2(mix_data_lod_30, S_lod30_nnS, create_lsabove),
          l_above_blod_40_nnS = map2(mix_data_lod_40, L_lod40_nnS, create_lsabove),
          s_above_blod_40_nnS = map2(mix_data_lod_40, S_lod40_nnS, create_lsabove),
          l_above_blod_50_nnS = map2(mix_data_lod_50, L_lod50_nnS, create_lsabove),
          s_above_blod_50_nnS = map2(mix_data_lod_50, S_lod50_nnS, create_lsabove))

#Subtract true values and divide by norm of true
make_above_diff <- function (ref0, L0, S0, 
                          ref10, L10, S10, 
                          ref20, L20, S20, 
                          ref30, L30, S30, 
                          ref40, L40, S40, 
                          ref50, L50, S50, 
                          Name) {
  as_tibble(cbind(`0%` = norm((ref0 - L0 - S0), type = "F")/norm((ref0), type = "F"),
                  `10%` = norm((ref10 - L10 - S10), type = "F")/norm((ref10), type = "F"),
                  `20%` = norm((ref20 - L20 - S20), type = "F")/norm((ref20), type = "F"),
                  `30%` = norm((ref30 - L30 - S30), type = "F")/norm((ref30), type = "F"),
                  `40%` = norm((ref40 - L40 - S40), type = "F")/norm((ref40), type = "F"),
                  `50%` = norm((ref50 - L50 - S50), type = "F")/norm((ref50), type = "F"))) %>% 
  gather(percent_blod, norm) %>% 
  mutate(Values = "> LOD",
         Method = Name)}

make_below_diff <- function (ref0, L0, S0, 
                          ref10, L10, S10, 
                          ref20, L20, S20, 
                          ref30, L30, S30, 
                          ref40, L40, S40, 
                          ref50, L50, S50, 
                          Name) {
  as_tibble(cbind(`0%` = norm((ref0 - L0 - S0), type = "F"),
                  `10%` = norm((ref10 - L10 - S10), type = "F")/norm((ref10), type = "F"),
                  `20%` = norm((ref20 - L20 - S20), type = "F")/norm((ref20), type = "F"),
                  `30%` = norm((ref30 - L30 - S30), type = "F")/norm((ref30), type = "F"),
                  `40%` = norm((ref40 - L40 - S40), type = "F")/norm((ref40), type = "F"),
                  `50%` = norm((ref50 - L50 - S50), type = "F")/norm((ref50), type = "F"))) %>% 
  gather(percent_blod, norm) %>% 
  mutate(Values = "< LOD",
         Method = Name)}

sim_ab <- sim_all %>% 
  mutate(above_diff = pmap(list(sims, l_above_blod_0, s_above_blod_0, 
                                mix_data_lod_10_0, l_above_blod_10, s_above_blod_10, 
                                mix_data_lod_20_0, l_above_blod_20, s_above_blod_20, 
                                mix_data_lod_30_0, l_above_blod_30, s_above_blod_30, 
                                mix_data_lod_40_0, l_above_blod_40, s_above_blod_40, 
                                mix_data_lod_50_0, l_above_blod_50, s_above_blod_50, 
                                "LOD PCP"), 
                           function (a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s)
                             make_above_diff(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s)),
         above_diff_2 = pmap(list(sims, l_above_blod_0_2, s_above_blod_0_2, 
                                  mix_data_lod_10_0, l_above_blod_10_2, s_above_blod_10_2, 
                                  mix_data_lod_20_0, l_above_blod_20_2, s_above_blod_20_2, 
                                  mix_data_lod_30_0, l_above_blod_30_2, s_above_blod_30_2, 
                                  mix_data_lod_40_0, l_above_blod_40_2, s_above_blod_40_2, 
                                  mix_data_lod_50_0, l_above_blod_50_2, s_above_blod_50_2, 
                                  "PCP w/ LOD/2"), 
                             function (a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s)
                             make_above_diff(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s)),
          above_diff_sqrt2 = pmap(list(sims, l_above_blod_0_sqrt2, s_above_blod_0_sqrt2, 
                                       mix_data_lod_10_0, l_above_blod_10_sqrt2, s_above_blod_10_sqrt2, 
                                       mix_data_lod_20_0, l_above_blod_20_sqrt2, s_above_blod_20_sqrt2, 
                                       mix_data_lod_30_0, l_above_blod_30_sqrt2, s_above_blod_30_sqrt2, 
                                       mix_data_lod_40_0, l_above_blod_40_sqrt2, s_above_blod_40_sqrt2, 
                                       mix_data_lod_50_0, l_above_blod_50_sqrt2, s_above_blod_50_sqrt2, 
                                       "PCP w/ LOD/sqrt2"), 
                                  function (a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s)
                             make_above_diff(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s)),
         above_diff_nnS = pmap(list(sims, l_above_blod_0_nnS, s_above_blod_0_nnS, 
                                    mix_data_lod_10_0, l_above_blod_10_nnS, s_above_blod_10_nnS, 
                                    mix_data_lod_20_0, l_above_blod_20_nnS, s_above_blod_20_nnS, 
                                    mix_data_lod_30_0, l_above_blod_30_nnS, s_above_blod_30_nnS, 
                                    mix_data_lod_40_0, l_above_blod_40_nnS, s_above_blod_40_nnS, 
                                    mix_data_lod_50_0, l_above_blod_50_nnS, s_above_blod_50_nnS, 
                                    "LOD PCP nnS"), 
                               function (a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s)
                             make_above_diff(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s)),
         above_diff_0 = pmap(list(sims, l_above_blod_0_0, s_above_blod_0_0, 
                                  mix_data_lod_10_0, l_above_blod_10_0, s_above_blod_10_0, 
                                  mix_data_lod_20_0, l_above_blod_20_0, s_above_blod_20_0,
                                  mix_data_lod_30_0, l_above_blod_30_0, s_above_blod_30_0, 
                                  mix_data_lod_40_0, l_above_blod_40_0, s_above_blod_40_0, 
                                  mix_data_lod_50_0, l_above_blod_50_0, s_above_blod_50_0, 
                                  "PCP w/ 0"), 
                             function (a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s)
                             make_above_diff(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s)))

sim_ab <- sim_ab %>% 
  mutate(less_diff = pmap(list(blod_0, l_blod_0, s_blod_0, 
                               blod_10, l_blod_10, s_blod_10, 
                               blod_20, l_blod_20, s_blod_20, 
                                blod_30, l_blod_30, s_blod_30, 
                               blod_40, l_blod_40, s_blod_40, 
                               blod_50, l_blod_50, s_blod_50, 
                                "LOD PCP"), make_below_diff),
         less_diff_2 = pmap(list(blod_0, l_blod_0_2, s_blod_0_2, 
                                 blod_10, l_blod_10_2, s_blod_10_2, 
                                 blod_20, l_blod_20_2, s_blod_20_2, 
                                  blod_30, l_blod_30_2, s_blod_30_2,
                                 blod_40, l_blod_40_2, s_blod_40_2, 
                                 blod_50, l_blod_50_2, s_blod_50_2, 
                                 "PCP w/ LOD/2"), make_below_diff),
         less_diff_sqrt2 = pmap(list(blod_0, l_blod_0_sqrt2, s_blod_0_sqrt2, 
                                     blod_10, l_blod_10_sqrt2, s_blod_10_sqrt2,
                                     blod_20, l_blod_20_sqrt2, s_blod_20_sqrt2,
                                     blod_30,l_blod_30_sqrt2, s_blod_30_sqrt2, 
                                     blod_40, l_blod_40_sqrt2, s_blod_40_sqrt2,
                                     blod_50, l_blod_50_sqrt2, s_blod_50_sqrt2, 
                                      "PCP w/ LOD/sqrt2"), make_below_diff),
         less_diff_nnS = pmap(list(blod_0, l_blod_0_nnS, s_blod_0_nnS, 
                                   blod_10, l_blod_10_nnS, s_blod_10_nnS, 
                                   blod_20,l_blod_20_nnS, s_blod_20_nnS, 
                                   blod_30,l_blod_30_nnS, s_blod_30_nnS, 
                                   blod_40,l_blod_40_nnS, s_blod_40_nnS, 
                                   blod_50,l_blod_50_nnS, s_blod_50_nnS, 
                                    "LOD PCP nnS"), make_below_diff),
         less_diff_0 = pmap(list(blod_0, l_blod_0_0, s_blod_0_0, 
                                 blod_10, l_blod_10_0, s_blod_10_0, 
                                 blod_20, l_blod_20_0, s_blod_20_0,
                                  blod_30, l_blod_30_0, s_blod_30_0, 
                                 blod_40,l_blod_40_0, s_blod_40_0, 
                                 blod_50, l_blod_50_0,s_blod_50_0, 
                                 "PCP w/ 0"), make_below_diff))
 
sim_ab <- sim_ab %>% select(seed, grep("diff", colnames(.)))
```

* Values \> and \< LOD stratified
* Sum of low rank and sparse solution matrices (L \+ S) compared to simulated data (X)

```{r, fig.align = "center"}
out_ab <- sim_ab %>% 
  select(seed, above_diff) %>% 
  unnest(cols = c(above_diff)) %>% 
  rbind(., sim_ab %>% 
          select(seed, above_diff_0) %>% 
          unnest(cols = c(above_diff_0))) %>% 
  rbind(., sim_ab %>% 
          select(seed, above_diff_sqrt2) %>% 
          unnest(cols = c(above_diff_sqrt2))) %>% 
  rbind(., sim_ab %>% 
          select(seed, above_diff_2) %>% 
          unnest(cols = c(above_diff_2))) %>% 
  rbind(., sim_ab %>% 
          select(seed, above_diff_nnS) %>% 
          unnest(cols = c(above_diff_nnS))) %>% 
  rbind(., sim_ab %>% 
          select(seed, less_diff_0) %>% 
          unnest(cols = c(less_diff_0))) %>% 
  rbind(., sim_ab %>% 
          select(seed, less_diff_sqrt2) %>% 
          unnest(cols = c(less_diff_sqrt2))) %>% 
  rbind(., sim_ab %>% 
          select(seed, less_diff_2) %>% 
          unnest(cols = c(less_diff_2))) %>% 
  rbind(., sim_ab %>% 
          select(seed, less_diff_nnS) %>% 
          unnest(cols = c(less_diff_nnS))) %>% 
  rbind(., sim_ab %>% 
          select(seed, less_diff) %>% 
          unnest(cols = c(less_diff))) 

out_ab %>% 
  mutate(norm = ifelse(Values == "> LOD" & Method == "LOD PCP", norm + 0.005, norm),
         norm = ifelse(Values == "> LOD" & Method == "PCP w/ 0", norm - 0.005, norm)) %>% 
  ggplot(aes(x = percent_blod, y = norm, group = interaction(Values, Method, seed), color = Method)) + 
  geom_point(aes()) + geom_path(aes(linetype = Values)) + theme_bw() +
  labs(x = "Percent Below LOD", 
       y = "(norm(X-L-S) / norm(X)",
       title = "Relative Error in Values < LOD & > LOD")
```

## SVD

### Right singular vectors

```{r, svdv, include=FALSE, cache= TRUE, cache.lazy=FALSE}
# Extract right singular vectors from each low rank solution matrix
extract_SVD <- function (L_lod0, L_lod10, L_lod20, L_lod30, L_lod40, L_lod50) {
        v_lod0  <- svd(L_lod0)$v[,1:7]
        v_lod10 <- svd(L_lod10)$v[,1:7]
        v_lod20 <- svd(L_lod20)$v[,1:7]
        v_lod30 <- svd(L_lod30)$v[,1:7]
        v_lod40 <- svd(L_lod40)$v[,1:7]
        v_lod50 <- svd(L_lod50)$v[,1:7]
        
        u_lod0  <- svd(L_lod0)$u[,1:7]
        u_lod10 <- svd(L_lod10)$u[,1:7]
        u_lod20 <- svd(L_lod20)$u[,1:7]
        u_lod30 <- svd(L_lod30)$u[,1:7]
        u_lod40 <- svd(L_lod40)$u[,1:7]
        u_lod50 <- svd(L_lod50)$u[,1:7]
        
        d_lod0  <- svd(L_lod0)$d[1:7]
        d_lod10 <- svd(L_lod10)$d[1:7]
        d_lod20 <- svd(L_lod20)$d[1:7]
        d_lod30 <- svd(L_lod30)$d[1:7]
        d_lod40 <- svd(L_lod40)$d[1:7]
        d_lod50 <- svd(L_lod50)$d[1:7]
        out <- list(v_lod0 = v_lod0, v_lod10 = v_lod10, v_lod20 = v_lod20, v_lod30 = v_lod30, 
             v_lod40 = v_lod40, v_lod50 = v_lod50,
             u_lod0 = u_lod0, u_lod10 = u_lod10, u_lod20 = u_lod20, u_lod30 = u_lod30, 
             u_lod40 = u_lod40, u_lod50 = u_lod50,
             d_lod0 = d_lod0, d_lod10 = d_lod10, d_lod20 = d_lod20, d_lod30 = d_lod30, 
             d_lod40 = d_lod40, d_lod50 = d_lod50)
        out <- out %>% set_names(~str_replace_all(., "0", "0_replace"))
        out
        }

sim_svd <- sim_all %>% 
  mutate(lod_pcp_svd_sqrt2 = pmap(list(L_lod0_sqrt2, L_lod10_sqrt2, L_lod20_sqrt2, 
                                 L_lod30_sqrt2, L_lod40_sqrt2, L_lod50_sqrt2),
                          function (a,b,c,d,e,f) extract_SVD(a,b,c,d,e,f))) %>% 
  unnest_wider(lod_pcp_svd_sqrt2) %>%
  rename_at(vars(ends_with("replace")), 
            list(~ str_replace(., "replace", "sqrt2_old"))) %>%
  mutate(lod_pcp_svd_2 = pmap(list(L_lod0_2, L_lod10_2, L_lod20_2, L_lod30_2, L_lod40_2, L_lod50_2), 
                          function (a,b,c,d,e,f) extract_SVD(a,b,c,d,e,f))) %>% 
  unnest_wider(lod_pcp_svd_2) %>% 
  rename_at(vars(ends_with("replace")), 
            list(~ str_replace(., "replace", "2_old"))) %>%
  mutate(lod_pcp_svd_nnS = pmap(list(L_lod0_nnS, L_lod10_nnS, L_lod20_nnS, L_lod30_nnS, L_lod40_nnS, L_lod50_nnS), 
                          function (a,b,c,d,e,f) extract_SVD(a,b,c,d,e,f))) %>% 
  unnest_wider(lod_pcp_svd_nnS) %>% 
  rename_at(vars(ends_with("replace")), 
            list(~ str_replace(., "replace", "nnS_old"))) %>% 
  mutate(lod_pcp_svd_0 = pmap(list(L_lod0_0, L_lod10_0, L_lod20_0, L_lod30_0, L_lod40_0, L_lod50_0), 
                      function (a,b,c,d,e,f) extract_SVD(a,b,c,d,e,f))) %>% 
  unnest_wider(lod_pcp_svd_0) %>% 
  rename_at(vars(ends_with("replace")), 
            list(~ str_replace(., "replace", "0_old"))) %>%
  mutate(lod_pcp_svd = pmap(list(L_lod0, L_lod10, L_lod20, L_lod30, L_lod40, L_lod50), 
                          function (a,b,c,d,e,f) extract_SVD(a,b,c,d,e,f))) %>% 
  unnest_wider(lod_pcp_svd) %>% 
  rename_at(vars(ends_with("replace")), 
            list(~ str_replace(., "replace", "old")))

match_loading <- function (truth, v) {
  truth <- as.matrix(truth)
  loading <- as.matrix(v)
  corr <- diag(cor(truth, v))
  reordered <- matrix(nrow = nrow(v), ncol = ncol(v))

  for (i in 1:nrow(loading)) {  
    reordered[i,1] <- ifelse(corr[1] < 0, -loading[i,1], loading[i,1])
    reordered[i,2] <- ifelse(corr[2] < 0, -loading[i,2], loading[i,2])
    reordered[i,3] <- ifelse(corr[3] < 0, -loading[i,3], loading[i,3])
    reordered[i,4] <- ifelse(corr[4] < 0, -loading[i,4], loading[i,4])
    reordered[i,5] <- ifelse(corr[5] < 0, -loading[i,5], loading[i,5])
    reordered[i,6] <- ifelse(corr[6] < 0, -loading[i,6], loading[i,6])
    reordered[i,7] <- ifelse(corr[7] < 0, -loading[i,7], loading[i,7])
  }
  reordered
}
  
sim_svd <- sim_svd %>% 
  mutate(v_lod0 = map2(v_lod0_old, v_lod0_old, match_loading),
         v_lod10 = map2(v_lod0_old, v_lod10_old, match_loading),
         v_lod20 = map2(v_lod0_old, v_lod20_old, match_loading),
         v_lod30 = map2(v_lod0_old, v_lod30_old, match_loading),
         v_lod40 = map2(v_lod0_old, v_lod40_old, match_loading),
         v_lod50 = map2(v_lod0_old, v_lod50_old, match_loading),
         v_lod0_sqrt2 = map2(v_lod0_sqrt2_old, v_lod0_sqrt2_old, match_loading),
       v_lod10_sqrt2 = map2(v_lod0_sqrt2_old, v_lod10_sqrt2_old, match_loading),
       v_lod20_sqrt2 = map2(v_lod0_sqrt2_old, v_lod20_sqrt2_old, match_loading),
       v_lod30_sqrt2 = map2(v_lod0_sqrt2_old, v_lod30_sqrt2_old, match_loading),
       v_lod40_sqrt2 = map2(v_lod0_sqrt2_old, v_lod40_sqrt2_old, match_loading),
       v_lod50_sqrt2 = map2(v_lod0_sqrt2_old, v_lod50_sqrt2_old, match_loading),
       v_lod0_2 = map2(v_lod0_2_old, v_lod0_2_old, match_loading),
       v_lod10_2 = map2(v_lod0_2_old, v_lod10_2_old, match_loading),
       v_lod20_2 = map2(v_lod0_2_old, v_lod20_2_old, match_loading),
       v_lod30_2 = map2(v_lod0_2_old, v_lod30_2_old, match_loading),
       v_lod40_2 = map2(v_lod0_2_old, v_lod40_2_old, match_loading),
       v_lod50_2 = map2(v_lod0_2_old, v_lod50_2_old, match_loading),
       v_lod0_nnS = map2(v_lod0_nnS_old, v_lod0_nnS_old, match_loading),
       v_lod10_nnS = map2(v_lod0_nnS_old, v_lod10_nnS_old, match_loading),
       v_lod20_nnS = map2(v_lod0_nnS_old, v_lod20_nnS_old, match_loading),
       v_lod30_nnS = map2(v_lod0_nnS_old, v_lod30_nnS_old, match_loading),
       v_lod40_nnS = map2(v_lod0_nnS_old, v_lod40_nnS_old, match_loading),
       v_lod50_nnS = map2(v_lod0_nnS_old, v_lod50_nnS_old, match_loading),
       v_lod0_0 = map2(v_lod0_0_old, v_lod0_0_old, match_loading),
       v_lod10_0 = map2(v_lod0_0_old, v_lod10_0_old, match_loading),
       v_lod20_0 = map2(v_lod0_0_old, v_lod20_0_old, match_loading),
       v_lod30_0 = map2(v_lod0_0_old, v_lod30_0_old, match_loading),
       v_lod40_0 = map2(v_lod0_0_old, v_lod40_0_old, match_loading),
       v_lod50_0 = map2(v_lod0_0_old, v_lod50_0_old, match_loading))
```

```{r, svdvnorm, include=FALSE, cache= TRUE, cache.lazy=FALSE}
make_Vnorm <- function (mix, L10, L20, L30, L40, L50, Name) {
  V_norm <- as_tibble(cbind(`0%` = norm((mix - mix), type = "F")/norm((mix), type = "F"),
      `10%` = norm((mix - L10), type = "F")/norm((mix), type = "F"),
      `20%` = norm((mix - L20), type = "F")/norm((mix), type = "F"),
      `30%` = norm((mix - L30), type = "F")/norm((mix), type = "F"),
      `40%` = norm((mix - L40), type = "F")/norm((mix), type = "F"),
      `50%` = norm((mix - L50), type = "F")/norm((mix), type = "F"))) %>% 
    gather(percent_blod, norm) %>% 
    mutate(Method = Name)
  V_norm
}

sim_svd <- sim_svd %>% 
        mutate(v_norm = pmap(list(v_lod0, v_lod10, v_lod20, v_lod30, v_lod40, v_lod50, "LOD PCP"), 
               function (mix, L10, L20, L30, L40, L50, Name) make_Vnorm(mix, L10, L20, L30, L40, L50, Name)),
               v_norm_2 = pmap(list(v_lod0_2, v_lod10_2, v_lod20_2, v_lod30_2, 
                                    v_lod40_2, v_lod50_2, "PCP w/ LOD/2"),
              function (mix, L10, L20, L30, L40, L50, Name) make_Vnorm(mix, L10, L20, L30, L40, L50, Name)),
         v_norm_sqrt2 = pmap(list(v_lod0_sqrt2, v_lod10_sqrt2, v_lod20_sqrt2, v_lod30_sqrt2, v_lod40_sqrt2,
                                  v_lod50_sqrt2, "PCP w/ LOD/sqrt2"), 
            function (mix, L10, L20, L30, L40, L50, Name) make_Vnorm(mix, L10, L20, L30, L40, L50, Name)),
         v_norm_nnS = pmap(list(v_lod0_nnS, v_lod10_nnS, v_lod20_nnS, v_lod30_nnS, v_lod40_nnS, 
                                v_lod50_nnS, "LOD PCP nnS"), 
            function (mix, L10, L20, L30, L40, L50, Name) make_Vnorm(mix, L10, L20, L30, L40, L50, Name)),
         v_norm_0 = pmap(list(v_lod0_0, v_lod10_0, v_lod20_0, v_lod30_0, v_lod40_0, v_lod50_0, "PCP w/ 0"), 
            function (mix, L10, L20, L30, L40, L50, Name) make_Vnorm(mix, L10, L20, L30, L40, L50, Name)))
```

* Reference is right singular vector matrix of SVD of low rank solution matix with 0\% \<LOD

```{r, fig.align = "center"}
out_v <- sim_svd %>% 
  select(seed, v_norm) %>% 
  unnest(cols = c(v_norm)) %>% 
  rbind(., sim_svd %>% 
  select(seed, v_norm_0) %>% 
  unnest(cols = c(v_norm_0))) %>% 
  rbind(., sim_svd %>% 
  select(seed, v_norm_sqrt2) %>% 
  unnest(cols = c(v_norm_sqrt2))) %>% 
  rbind(., sim_svd %>% 
  select(seed, v_norm_2) %>% 
  unnest(cols = c(v_norm_2))) %>% 
  rbind(., sim_svd %>% 
  select(seed, v_norm_nnS) %>% 
  unnest(cols = c(v_norm_nnS)))
  
out_v %>% ggplot(aes(x = percent_blod, y = norm, group = interaction(seed, Method))) + 
  geom_point(aes(color = Method)) + geom_path(aes(color = Method)) + theme_bw() +
  labs(x = "Percent Below LOD", y = "norm(X-L-S) / norm(X)",
       title = "Relative Error in Low-Rank Solution Left Singular Vectors")
```

### Left singular vectors

```{r, matchleft, include=FALSE, cache= TRUE, cache.lazy=FALSE}
match_scores <- function (v, reordered, u) {
  u <- as.matrix(u)
  v <- as.matrix(v)
  u_re <- as_tibble(matrix(nrow = nrow(u), ncol = ncol(u)))
   for (k in 1:ncol(v)) {
      for (chem in 1:nrow(v)) {
        for (i in 1:nrow(u)) {
        if (v[chem, k] == reordered[chem, k]) {
          u_re[i, k] = u[i, k]
        } else {u_re[i, k] = -(u[i, k])}
        }}}
  u_re
}

sim_svd <- sim_svd %>% 
  mutate(u_lod0  = pmap(list(v_lod0_old,  v_lod0,  u_lod0_old), match_scores),
         u_lod10 = pmap(list(v_lod10_old, v_lod10, u_lod10_old), match_scores),
         u_lod20 = pmap(list(v_lod20_old, v_lod20, u_lod20_old),  match_scores),
         u_lod30 = pmap(list(v_lod30_old, v_lod30, u_lod30_old),  match_scores),
         u_lod40 = pmap(list(v_lod40_old, v_lod40, u_lod40_old), match_scores),
         u_lod50 = pmap(list(v_lod50_old, v_lod50, u_lod50_old), match_scores),
         u_lod0_sqrt2  = pmap(list(v_lod0_sqrt2_old,  v_lod0_sqrt2,   u_lod0_sqrt2_old), match_scores),
         u_lod10_sqrt2 = pmap(list(v_lod10_sqrt2_old, v_lod10_sqrt2,  u_lod10_sqrt2_old), match_scores),
         u_lod20_sqrt2 = pmap(list(v_lod20_sqrt2_old, v_lod20_sqrt2,  u_lod20_sqrt2_old),  match_scores),
         u_lod30_sqrt2 = pmap(list(v_lod30_sqrt2_old, v_lod30_sqrt2,  u_lod30_sqrt2_old),  match_scores),
         u_lod40_sqrt2 = pmap(list(v_lod40_sqrt2_old, v_lod40_sqrt2,  u_lod40_sqrt2_old), match_scores),
         u_lod50_sqrt2 = pmap(list(v_lod50_sqrt2_old, v_lod50_sqrt2,  u_lod50_sqrt2_old), match_scores),
         u_lod0_2  = pmap(list(v_lod0_2_old,  v_lod0_2,   u_lod0_2_old), match_scores),
         u_lod10_2 = pmap(list(v_lod10_2_old, v_lod10_2,  u_lod10_2_old), match_scores),
         u_lod20_2 = pmap(list(v_lod20_2_old, v_lod20_2,  u_lod20_2_old),  match_scores),
         u_lod30_2 = pmap(list(v_lod30_2_old, v_lod30_2,  u_lod30_2_old),  match_scores),
         u_lod40_2 = pmap(list(v_lod40_2_old, v_lod40_2,  u_lod40_2_old), match_scores),
         u_lod50_2 = pmap(list(v_lod50_2_old, v_lod50_2,  u_lod50_2_old), match_scores),
         u_lod0_nnS  = pmap(list(v_lod0_nnS_old,  v_lod0_nnS,   u_lod0_nnS_old), match_scores),
         u_lod10_nnS = pmap(list(v_lod10_nnS_old, v_lod10_nnS,  u_lod10_nnS_old), match_scores),
         u_lod20_nnS = pmap(list(v_lod20_nnS_old, v_lod20_nnS,  u_lod20_nnS_old),  match_scores),
         u_lod30_nnS = pmap(list(v_lod30_nnS_old, v_lod30_nnS,  u_lod30_nnS_old),  match_scores),
         u_lod40_nnS = pmap(list(v_lod40_nnS_old, v_lod40_nnS,  u_lod40_nnS_old), match_scores),
         u_lod50_nnS = pmap(list(v_lod50_nnS_old, v_lod50_nnS,  u_lod50_nnS_old), match_scores),
         u_lod0_0  = pmap(list(v_lod0_0_old,  v_lod0_0,   u_lod0_0_old), match_scores),
         u_lod10_0 = pmap(list(v_lod10_0_old, v_lod10_0,  u_lod10_0_old), match_scores),
         u_lod20_0 = pmap(list(v_lod20_0_old, v_lod20_0,  u_lod20_0_old),  match_scores),
         u_lod30_0 = pmap(list(v_lod30_0_old, v_lod30_0,  u_lod30_0_old),  match_scores),
         u_lod40_0 = pmap(list(v_lod40_0_old, v_lod40_0,  u_lod40_0_old), match_scores),
         u_lod50_0 = pmap(list(v_lod50_0_old, v_lod50_0,  u_lod50_0_old), match_scores))
```

```{r, svdu, include=FALSE, cache = TRUE, cache.lazy=FALSE}
make_unorm <- function (mix, L10, L20, L30, L40, L50, Name) {
  u_norm <- as_tibble(cbind(`0%` = norm((mix - mix), type = "F")/norm((mix), type = "F"),
                            `10%` = norm((mix - L10), type = "F")/norm((mix), type = "F"),
                            `20%` = norm((mix - L20), type = "F")/norm((mix), type = "F"),
                            `30%` = norm((mix - L30), type = "F")/norm((mix), type = "F"),
                            `40%` = norm((mix - L40), type = "F")/norm((mix), type = "F"),
                            `50%` = norm((mix - L50), type = "F")/norm((mix), type = "F"))) %>% 
    gather(percent_blod, norm) %>% 
    mutate(Method = Name)
  u_norm
}

sim_svd <- sim_svd %>% 
  mutate(u_norm = pmap(list(u_lod0, u_lod10, u_lod20, u_lod30, u_lod40, u_lod50, "LOD PCP"), make_unorm),
         u_norm_2 = pmap(list(u_lod0_2, u_lod10_2, u_lod20_2, u_lod30_2, u_lod40_2, 
                              u_lod50_2, "PCP w/ LOD/2"), make_unorm),
         u_norm_sqrt2 = pmap(list(u_lod0_sqrt2, u_lod10_sqrt2, u_lod20_sqrt2, u_lod30_sqrt2, u_lod40_sqrt2,
                                  u_lod50_sqrt2, "PCP w/ LOD/sqrt2"), make_unorm),
         u_norm_nnS = pmap(list(u_lod0_nnS, u_lod10_nnS, u_lod20_nnS, u_lod30_nnS, u_lod40_nnS, 
                                u_lod50_nnS, "LOD PCP nnS"), make_unorm),
         u_norm_0 = pmap(list(u_lod0_0, u_lod10_0, u_lod20_0, u_lod30_0, 
                              u_lod40_0, u_lod50_0, "PCP w/ 0"), make_unorm))
```

* Reference is left singular vector matrix of SVD of low rank solution matix with 0\% \<LOD

```{r, fig.align = "center"}
out_u <- sim_svd %>% 
  select(seed, u_norm) %>% 
  unnest(cols = c(u_norm)) %>% 
  rbind(., sim_svd %>% 
  select(seed, u_norm_0) %>% 
  unnest(cols = c(u_norm_0))) %>% 
  rbind(., sim_svd %>% 
  select(seed, u_norm_sqrt2) %>% 
  unnest(cols = c(u_norm_sqrt2))) %>% 
  rbind(., sim_svd %>% 
  select(seed, u_norm_2) %>% 
  unnest(cols = c(u_norm_2))) %>% 
  rbind(., sim_svd %>% 
  select(seed, u_norm_nnS) %>% 
  unnest(cols = c(u_norm_nnS)))
  
out_u %>% ggplot(aes(x = percent_blod, y = norm, group = interaction(seed, Method))) + 
  geom_point(aes(color = Method)) + geom_path(aes(color = Method)) + theme_bw() +
  labs(x = "Percent Below LOD", y = "norm(X-L-S) / norm(X)",
       title = "Relative Error in Low-Rank Solution Left Singular Vectors")
```

### Singular Values

```{r, sv, include=FALSE, cache=TRUE, cache.lazy=FALSE}
norm_vec <- function(x) sqrt(sum(x^2))

make_dnorm <- function (mix, L10, L20, L30, L40, L50, Name) {
  d_norm <- as_tibble(cbind(`0%` = norm_vec((mix - mix))/norm_vec((mix)),
                            `10%` = norm_vec((mix - L10))/norm_vec((mix)),
                            `20%` = norm_vec((mix - L20))/norm_vec((mix)),
                            `30%` = norm_vec((mix - L30))/norm_vec((mix)),
                            `40%` = norm_vec((mix - L40))/norm_vec((mix)),
                            `50%` = norm_vec((mix - L50))/norm_vec((mix)))) %>% 
    gather(percent_blod, norm) %>% 
    mutate(Method = Name)
  d_norm
}

sim_svd <- sim_svd %>% 
  mutate(d_norm = pmap(list(d_lod0, d_lod10, d_lod20, d_lod30, d_lod40, d_lod50, "LOD PCP"), make_dnorm),
         d_norm_2 = pmap(list(d_lod0_2, d_lod10_2, d_lod20_2, d_lod30_2, 
                              d_lod40_2, d_lod50_2, "PCP w/ LOD/2"), make_dnorm),
         d_norm_sqrt2 = pmap(list(d_lod0_sqrt2, d_lod10_sqrt2, d_lod20_sqrt2, d_lod30_sqrt2, d_lod40_sqrt2,
                                  d_lod50_sqrt2, "PCP w/ LOD/sqrt2"), make_dnorm),
         d_norm_nnS = pmap(list(d_lod0_nnS, d_lod10_nnS, d_lod20_nnS, d_lod30_nnS, d_lod40_nnS, 
                                d_lod50_nnS, "LOD PCP nnS"), make_dnorm),
         d_norm_0 = pmap(list(d_lod0_0, d_lod10_0, d_lod20_0, d_lod30_0, d_lod40_0, 
                              d_lod50_0, "PCP w/ 0"), make_dnorm))
```

* Reference is singular value vector of SVD of low rank solution matix with 0\% \<LOD

```{r, fig.align = "center"}
out_d <- sim_svd %>% 
  select(seed, d_norm) %>% 
  unnest(cols = c(d_norm)) %>% 
  rbind(., sim_svd %>% 
  select(seed, d_norm_0) %>% 
  unnest(cols = c(d_norm_0))) %>% 
  rbind(., sim_svd %>% 
  select(seed, d_norm_sqrt2) %>% 
  unnest(cols = c(d_norm_sqrt2))) %>% 
  rbind(., sim_svd %>% 
  select(seed, d_norm_2) %>% 
  unnest(cols = c(d_norm_2))) %>% 
  rbind(., sim_svd %>% 
  select(seed, d_norm_nnS) %>% 
  unnest(cols = c(d_norm_nnS)))
  
out_d %>% ggplot(aes(x = percent_blod, y = norm, group = interaction(seed, Method))) + 
  geom_point(aes(color = Method)) + geom_path(aes(color = Method)) + theme_bw() +
  labs(x = "Percent Below LOD", y = "norm(X-L-S) / norm(X)",
       title = "Relative Error in Low-Rank Solution Left Singular Vectors")


rbind(d_diff_sqrt2,
      d_diff,
      d_diff_0,
      d_diff_2,
      d_diff_nnS) %>% ggplot(aes(x = percent_blod, y = norm, group = Method, color = Method)) + 
  geom_point() + geom_path() + theme_bw() +
  labs(x = "Percent Below LOD", 
       y = "norm(SV - SV_lod0) / norm(SV_lod0)",
       title = "Relative Error in Low-Rank Solution Singular Values")
```

## Values \<LOD

```{r, l22s, include=FALSE, cache = TRUE}
t_na_lod_0 <- sim_all %>% 
  as_tibble() %>% 
  mutate_all(function(x) ifelse(x == -1, TRUE, NA))
l_blod_0_na <- as_tibble(t_na_lod_0*L_lod0)
s_blod_0_na <- as_tibble(t_na_lod_0*S_lod0)
blod_0_na <- as_tibble(sim_all*t_na_lod_0)

t_na_lod_10 <- mix_data_lod_10 %>% 
  as_tibble() %>%
  mutate_all(function(x) ifelse(x == -1, TRUE, NA))
l_blod_10_na <- as_tibble(t_na_lod_10*L_lod10)
s_blod_10_na <- as_tibble(t_na_lod_10*S_lod10)
blod_10_na <- as_tibble(sim_all*t_na_lod_10)

t_na_lod_20 <- mix_data_lod_20 %>% 
  as_tibble() %>% 
  mutate_all(function(x) ifelse(x == -1, TRUE, NA))
l_blod_20_na <- as_tibble(t_na_lod_20*L_lod20)
s_blod_20_na <- as_tibble(t_na_lod_20*S_lod20)
blod_20_na <- as_tibble(sim_all*t_na_lod_20)

t_na_lod_30 <- mix_data_lod_30 %>% 
  as_tibble() %>% 
  mutate_all(function(x) ifelse(x == -1, TRUE, NA))
l_blod_30_na <- as_tibble(t_na_lod_30*L_lod30)
s_blod_30_na <- as_tibble(t_na_lod_30*S_lod30)
blod_30_na <- as_tibble(sim_all*t_na_lod_30)

t_na_lod_40 <- mix_data_lod_40 %>% 
  as_tibble() %>% 
  mutate_all(function(x) ifelse(x == -1, TRUE, NA))
l_blod_40_na <- as_tibble(t_na_lod_40*L_lod40)
s_blod_40_na <- as_tibble(t_na_lod_40*S_lod40)
blod_40_na <- as_tibble(sim_all*t_na_lod_40)

t_na_lod_50 <- mix_data_lod_50 %>% 
  as_tibble() %>% 
  mutate_all(function(x) ifelse(x == -1, TRUE, NA))
l_blod_50_na <- as_tibble(t_na_lod_50*L_lod50)
s_blod_50_na <- as_tibble(t_na_lod_50*S_lod50)
blod_50_na <- as_tibble(sim_all*t_na_lod_50) 

L_blod_0_sqrt2_na <- as_tibble(t_na_lod_0*L_lod0_sqrt2)
S_blod_0_sqrt2_na <- as_tibble(t_na_lod_0*S_lod0_sqrt2)

L_blod_10_sqrt2_na <- as_tibble(t_na_lod_10*L_lod10_sqrt2)
S_blod_10_sqrt2_na <- as_tibble(t_na_lod_10*S_lod10_sqrt2)

L_blod_20_sqrt2_na <- as_tibble(t_na_lod_20*L_lod20_sqrt2)
S_blod_20_sqrt2_na <- as_tibble(t_na_lod_20*S_lod20_sqrt2)

L_blod_30_sqrt2_na <- as_tibble(t_na_lod_30*L_lod30_sqrt2)
S_blod_30_sqrt2_na <- as_tibble(t_na_lod_30*S_lod30_sqrt2)

L_blod_40_sqrt2_na <- as_tibble(t_na_lod_40*L_lod40_sqrt2)
S_blod_40_sqrt2_na <- as_tibble(t_na_lod_40*S_lod40_sqrt2)

L_blod_50_sqrt2_na <- as_tibble(t_na_lod_50*L_lod50_sqrt2)
S_blod_50_sqrt2_na <- as_tibble(t_na_lod_50*S_lod50_sqrt2)

LOD10 <- delta10 %>% as.matrix() %>% t() %>% as_tibble() %>% rename_all(., list(~str_sub(., start = 1, end = -5))) %>% gather(POP, LOD) %>% mutate(Percent = "10%")
LOD20 <- delta20 %>% as.matrix() %>% t() %>% as_tibble() %>% rename_all(., list(~str_sub(., start = 1, end = -5))) %>% gather(POP, LOD) %>% mutate(Percent = "20%")
LOD30 <- delta30 %>% as.matrix() %>% t() %>% as_tibble() %>% rename_all(., list(~str_sub(., start = 1, end = -5))) %>% gather(POP, LOD) %>% mutate(Percent = "30%")
LOD40 <- delta40 %>% as.matrix() %>% t() %>% as_tibble() %>% rename_all(., list(~str_sub(., start = 1, end = -5))) %>% gather(POP, LOD) %>% mutate(Percent = "40%")
LOD50 <- delta50 %>% as.matrix() %>% t() %>% as_tibble() %>% rename_all(., list(~str_sub(., start = 1, end = -5))) %>% gather(POP, LOD) %>% mutate(Percent = "50%")
LODall <- rbind(LOD10, LOD20, LOD30, LOD40, LOD50)
  
plot_10 <- blod_10_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Original, -rowid) %>% mutate(Percent = "10%")
plotl_10 <- l_blod_10_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Low Rank Solution", Percent = "10%") %>% left_join(., plot_10, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD10, by = c("POP", "Percent"))
plots_10 <- s_blod_10_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Sparse Solution", Percent = "10%") %>% left_join(., plot_10, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD10, by = c("POP", "Percent"))
plotall_10 <- (l_blod_10_na + s_blod_10_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Model Prediction", Percent = "10%") %>% left_join(., plot_10, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD10, by = c("POP", "Percent"))

plot_20 <- blod_20_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Original, -rowid) %>% mutate(Percent = "20%") 
plotl_20 <- l_blod_20_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Low Rank Solution", Percent = "20%") %>% left_join(., plot_20, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD20, by = c("POP", "Percent"))
plots_20 <- s_blod_20_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Sparse Solution", Percent = "20%") %>% left_join(., plot_20, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD20, by = c("POP", "Percent"))
plotall_20 <- (l_blod_20_na + s_blod_20_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Model Prediction", Percent = "20%") %>% left_join(., plot_20, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD20, by = c("POP", "Percent")) 

plot_30 <- blod_30_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Original, -rowid) %>% mutate(Percent = "30%")
plotl_30 <- l_blod_30_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Low Rank Solution", Percent = "30%") %>% left_join(., plot_30, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD30, by = c("POP", "Percent"))
plots_30 <- s_blod_30_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Sparse Solution", Percent = "30%") %>% left_join(., plot_30, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD30, by = c("POP", "Percent")) 
plotall_30 <- (l_blod_30_na + s_blod_30_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Model Prediction", Percent = "30%") %>% left_join(., plot_30, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD30, by = c("POP", "Percent")) 

plot_40 <- blod_40_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Original, -rowid) %>% mutate(Percent = "40%") 
plotl_40 <- l_blod_40_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Low Rank Solution", Percent = "40%") %>% left_join(., plot_40, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD40, by = c("POP", "Percent"))
plots_40 <- s_blod_40_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Sparse Solution", Percent = "40%") %>% left_join(., plot_40, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD40, by = c("POP", "Percent"))
plotall_40 <- (l_blod_40_na + s_blod_40_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Model Prediction", Percent = "40%") %>% left_join(., plot_40, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD40, by = c("POP", "Percent"))

plot_50 <- blod_50_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Original, -rowid) %>% mutate(Percent = "50%") 
plotl_50 <- l_blod_50_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Low Rank Solution", Percent = "50%") %>% left_join(., plot_50, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD50, by = c("POP", "Percent"))
plots_50 <- s_blod_50_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Sparse Solution", Percent = "50%") %>% left_join(., plot_50, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD50, by = c("POP", "Percent")) 
plotall_50 <- (l_blod_50_na + s_blod_50_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Model Prediction", Percent = "50%") %>% left_join(., plot_50, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD50, by = c("POP", "Percent"))

org <- rbind(plot_10,
        plot_20,
        plot_30,
        plot_40,
        plot_50) %>% rename(Value = Original) %>% 
  mutate(Compare = "Original") %>% 
  left_join(., LODall, by = c("POP", "Percent"))

plotall <- rbind(plotl_10,
      plots_10,
      plotall_10,
      plotl_20,
      plots_20,
      plotall_20,
      plotl_30,
      plots_30,
      plotall_30, 
      plotl_40,
      plots_40,
      plotall_40,
      plotl_50,
      plots_50,
      plotall_50)

l_blod_0_nnS_na <- as_tibble(t_na_lod_0*L_lod0_nnS)
s_blod_0_nnS_na <- as_tibble(t_na_lod_0*S_lod0_nnS)

l_blod_10_nnS_na <- as_tibble(t_na_lod_10*L_lod10_nnS)
s_blod_10_nnS_na <- as_tibble(t_na_lod_10*S_lod10_nnS)

l_blod_20_nnS_na <- as_tibble(t_na_lod_20*L_lod20_nnS)
s_blod_20_nnS_na <- as_tibble(t_na_lod_20*S_lod20_nnS)

l_blod_30_nnS_na <- as_tibble(t_na_lod_30*L_lod30_nnS)
s_blod_30_nnS_na <- as_tibble(t_na_lod_30*S_lod30_nnS)

l_blod_40_nnS_na <- as_tibble(t_na_lod_40*L_lod40_nnS)
s_blod_40_nnS_na <- as_tibble(t_na_lod_40*S_lod40_nnS)

l_blod_50_nnS_na <- as_tibble(t_na_lod_50*L_lod50_nnS)
s_blod_50_nnS_na <- as_tibble(t_na_lod_50*S_lod50_nnS)

plotl_10_nnS <- l_blod_10_nnS_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Low Rank Solution", Percent = "10%") %>% left_join(., plot_10, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD10, by = c("POP", "Percent"))
plots_10_nnS <- s_blod_10_nnS_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Sparse Solution", Percent = "10%") %>% left_join(., plot_10, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD10, by = c("POP", "Percent"))
plotall_10_nnS <- (l_blod_10_nnS_na + s_blod_10_nnS_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Model Prediction", Percent = "10%") %>% left_join(., plot_10, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD10, by = c("POP", "Percent"))

plotl_20_nnS <- l_blod_20_nnS_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Low Rank Solution", Percent = "20%") %>% left_join(., plot_20, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD20, by = c("POP", "Percent"))
plots_20_nnS <- s_blod_20_nnS_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Sparse Solution", Percent = "20%") %>% left_join(., plot_20, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD20, by = c("POP", "Percent"))
plotall_20_nnS <- (l_blod_20_nnS_na + s_blod_20_nnS_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Model Prediction", Percent = "20%") %>% left_join(., plot_20, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD20, by = c("POP", "Percent")) 

plotl_30_nnS <- l_blod_30_nnS_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Low Rank Solution", Percent = "30%") %>% left_join(., plot_30, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD30, by = c("POP", "Percent"))
plots_30_nnS <- s_blod_30_nnS_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Sparse Solution", Percent = "30%") %>% left_join(., plot_30, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD30, by = c("POP", "Percent")) 
plotall_30_nnS <- (l_blod_30_nnS_na + s_blod_30_nnS_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Model Prediction", Percent = "30%") %>% left_join(., plot_30, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD30, by = c("POP", "Percent")) 

plotl_40_nnS <- l_blod_40_nnS_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Low Rank Solution", Percent = "40%") %>% left_join(., plot_40, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD40, by = c("POP", "Percent"))
plots_40_nnS <- s_blod_40_nnS_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Sparse Solution", Percent = "40%") %>% left_join(., plot_40, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD40, by = c("POP", "Percent"))
plotall_40_nnS <- (l_blod_40_nnS_na + s_blod_40_nnS_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Model Prediction", Percent = "40%") %>% left_join(., plot_40, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD40, by = c("POP", "Percent"))

plotl_50_nnS <- l_blod_50_nnS_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Low Rank Solution", Percent = "50%") %>% left_join(., plot_50, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD50, by = c("POP", "Percent"))
plots_50_nnS <- s_blod_50_nnS_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Sparse Solution", Percent = "50%") %>% left_join(., plot_50, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD50, by = c("POP", "Percent")) 
plotall_50_nnS <- (l_blod_50_nnS_na + s_blod_50_nnS_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Model Prediction", Percent = "50%") %>% left_join(., plot_50, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD50, by = c("POP", "Percent"))

plotall_nns <- rbind(plotl_10_nnS,
      plots_10_nnS,
      plotall_10_nnS,
      plotl_20_nnS,
      plots_20_nnS,
      plotall_20_nnS,
      plotl_30_nnS,
      plots_30_nnS,
      plotall_30_nnS, 
      plotl_40_nnS,
      plots_40_nnS,
      plotall_40_nnS,
      plotl_50_nnS,
      plots_50_nnS,
      plotall_50_nnS)

plotl_10_sqrt2 <- L_blod_10_sqrt2_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Low Rank Solution", Percent = "10%") %>% left_join(., plot_10, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD10, by = c("POP", "Percent"))
plots_10_sqrt2 <- S_blod_10_sqrt2_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Sparse Solution", Percent = "10%") %>% left_join(., plot_10, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD10, by = c("POP", "Percent"))
plotall_10_sqrt2 <- (L_blod_10_sqrt2_na + S_blod_10_sqrt2_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Model Prediction", Percent = "10%") %>% left_join(., plot_10, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD10, by = c("POP", "Percent"))

plotl_20_sqrt2 <- L_blod_20_sqrt2_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Low Rank Solution", Percent = "20%") %>% left_join(., plot_20, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD20, by = c("POP", "Percent"))
plots_20_sqrt2 <- S_blod_20_sqrt2_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Sparse Solution", Percent = "20%") %>% left_join(., plot_20, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD20, by = c("POP", "Percent"))
plotall_20_sqrt2 <- (L_blod_20_sqrt2_na + S_blod_20_sqrt2_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Model Prediction", Percent = "20%") %>% left_join(., plot_20, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD20, by = c("POP", "Percent")) 

plotl_30_sqrt2 <- L_blod_30_sqrt2_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Low Rank Solution", Percent = "30%") %>% left_join(., plot_30, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD30, by = c("POP", "Percent"))
plots_30_sqrt2 <- S_blod_30_sqrt2_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Sparse Solution", Percent = "30%") %>% left_join(., plot_30, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD30, by = c("POP", "Percent")) 
plotall_30_sqrt2 <- (L_blod_30_sqrt2_na + S_blod_30_sqrt2_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Model Prediction", Percent = "30%") %>% left_join(., plot_30, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD30, by = c("POP", "Percent")) 

plotl_40_sqrt2 <- L_blod_40_sqrt2_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Low Rank Solution", Percent = "40%") %>% left_join(., plot_40, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD40, by = c("POP", "Percent"))
plots_40_sqrt2 <- S_blod_40_sqrt2_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Sparse Solution", Percent = "40%") %>% left_join(., plot_40, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD40, by = c("POP", "Percent"))
plotall_40_sqrt2 <- (L_blod_40_sqrt2_na + S_blod_40_sqrt2_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Model Prediction", Percent = "40%") %>% left_join(., plot_40, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD40, by = c("POP", "Percent"))

plotl_50_sqrt2 <- L_blod_50_sqrt2_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Low Rank Solution", Percent = "50%") %>% left_join(., plot_50, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD50, by = c("POP", "Percent"))
plots_50_sqrt2 <- S_blod_50_sqrt2_na %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Sparse Solution", Percent = "50%") %>% left_join(., plot_50, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD50, by = c("POP", "Percent")) 
plotall_50_sqrt2 <- (L_blod_50_sqrt2_na + S_blod_50_sqrt2_na) %>% as_tibble(.) %>% rowid_to_column(.) %>% gather(key = POP, value = Value, -rowid) %>% mutate(Compare = "Model Prediction", Percent = "50%") %>% left_join(., plot_50, by = c("rowid", "POP", "Percent")) %>% left_join(., LOD50, by = c("POP", "Percent"))

plotall_sqrt2 <- rbind(plotl_10_sqrt2,
      plots_10_sqrt2,
      plotall_10_sqrt2,
      plotl_20_sqrt2,
      plots_20_sqrt2,
      plotall_20_sqrt2,
      plotl_30_sqrt2,
      plots_30_sqrt2,
      plotall_30_sqrt2, 
      plotl_40_sqrt2,
      plots_40_sqrt2,
      plotall_40_sqrt2,
      plotl_50_sqrt2,
      plots_50_sqrt2,
      plotall_50_sqrt2)
```

```{r}
plotall %>% 
  filter(Compare == "Low Rank Solution") %>% 
  drop_na(.) %>% 
  mutate(above_lod = ifelse(Value > LOD, 1, 0)) %>%
  group_by(Compare, Percent) %>% 
  summarise(above = sum(above_lod),
            total = n()) %>% 
  mutate(Proportion = round(above/total, 2)) %>% 
  ungroup(.) %>% 
  select(Percent, Proportion) %>% 
  kable(., caption = "LOD PCP Low Rank Solution Values >LOD")

plotall_nns %>% 
  filter(Compare == "Low Rank Solution") %>% 
  drop_na(.) %>% 
  mutate(above_lod = ifelse(Value > LOD, 1, 0)) %>%
  group_by(Compare, Percent) %>% 
  summarise(above = sum(above_lod),
            total = n()) %>% 
  mutate(Proportion = round(above/total, 2)) %>% 
  ungroup(.) %>% 
  select(Percent, Proportion) %>% 
  kable(., caption = "nnS LOD PCP Low Rank Solution Values >LOD")

plotall_sqrt2 %>% 
  filter(Compare == "Low Rank Solution") %>% 
  drop_na(.) %>% 
  mutate(above_lod = ifelse(Value > LOD, 1, 0)) %>%
  group_by(Compare, Percent) %>% 
  summarise(above = sum(above_lod),
            total = n()) %>% 
  mutate(Proportion = round(above/total, 2)) %>% 
  ungroup(.) %>% 
  select(Percent, Proportion) %>% 
  kable(., caption = "Original PCP w/ LOD/sqrt(2) Low Rank Solution Values >LOD")

rbind(plots_10,
      plots_20,
      plots_30,
      plots_40,
      plots_50) %>% 
  drop_na(.) %>% 
  group_by(Compare, Percent) %>% 
  summarise(Min = min(Value),
            Ave = mean(Value),
            Max = max(Value)) %>% 
  ungroup(.) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  select(-Compare) %>% kable(., caption = "LOD PCP Sparse Solutions")

rbind(plots_10_nnS,
      plots_20_nnS,
      plots_30_nnS,
      plots_40_nnS,
      plots_50_nnS) %>% 
  drop_na(.) %>% 
  group_by(Compare, Percent) %>%
  summarise(Min = min (Value),
            Mean = mean(Value),
            Max = max(Value)) %>% 
  ungroup(.) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  select(-Compare) %>% kable(., caption = "nnS LOD PCP Sparse Solutions")

rbind(plots_10_sqrt2,
      plots_20_sqrt2,
      plots_30_sqrt2,
      plots_40_sqrt2,
      plots_50_sqrt2) %>% 
  drop_na(.) %>% 
  group_by(Compare, Percent) %>%
  summarise(Min = min (Value),
            Mean = mean(Value),
            Max = max(Value)) %>% 
  ungroup(.) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  select(-Compare) %>% kable(., caption = "Original PCP w/ LOD/sqrt(2) Sparse Solutions")
```

* Plus sign (\+) indicates LOD for each chemical

```{r, fig.align = "center"}
plotall %>% 
  select(-Original) %>% 
  rbind(., org) %>% 
  drop_na(.) %>% 
  #filter(Compare != "Original") %>% 
  # with and without Original
  mutate(Compare = fct_relevel(Compare, "Low Rank Solution",
                            "Sparse Solution",
                            "Model Prediction",
                            "Original")) %>% 
  ggplot(aes(x = POP, y = Value)) + 
  geom_jitter(aes(color = Compare), alpha = 0.1, width = 0.3, height = 0) + 
  theme_bw() +
  geom_point(aes(y = LOD), shape = 3, size = 0.5) +
  facet_wrap(.~Percent) +
  labs(x = "POP", 
       y = "Solution Value",
       title = "LOD PCP Solution Values <LOD + Original Values") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, hjust = 1))
```

* Plus sign (\+) indicates LOD for each chemical

```{r, fig.align = "center"}
plotall %>% 
  select(-Original) %>% 
  rbind(., org) %>% 
  drop_na(.) %>% 
  filter(Compare != "Original") %>% 
  # with and without Original
  mutate(Compare = fct_relevel(Compare, "Low Rank Solution",
                            "Sparse Solution",
                            "Model Prediction")) %>% 
  ggplot(aes(x = POP, y = Value)) + 
  geom_jitter(aes(color = Compare), alpha = 0.1, width = 0.3, height = 0) + 
  theme_bw() +
  geom_point(aes(y = LOD), shape = 3, size = 0.5) +
  facet_wrap(.~Percent) +
  labs(x = "POP", 
       y = "Solution Value",
       title = "LOD PCP Solution Values <LOD") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, hjust = 1))
```

* Plus sign (\+) indicates LOD for each chemical

```{r, fig.align = "center"}
plotall_nns %>% 
  select(-Original) %>% 
  rbind(., org) %>% 
  drop_na(.) %>% 
  #filter(Compare != "Original") %>% 
  # with and without Original
  mutate(Compare = fct_relevel(Compare, "Low Rank Solution",
                            "Sparse Solution",
                            "Model Prediction",
                            "Original")) %>% 
  ggplot(aes(x = POP, y = Value)) + 
  geom_jitter(aes(color = Compare), alpha = 0.1, width = 0.3, height = 0) + 
  theme_bw() +
  geom_point(aes(y = LOD), shape = 3, size = 0.5) +
  facet_wrap(.~Percent) +
  labs(x = "POP", 
       y = "Solution Value",
       title = "nnS LOD PCP Solution Values <LOD + Original Values") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, hjust = 1))
```

* Plus sign (\+) indicates LOD for each chemical

```{r, fig.align = "center"}
plotall_nns %>% 
  select(-Original) %>% 
  rbind(., org) %>% 
  drop_na(.) %>% 
  filter(Compare != "Original") %>% 
  # with and without Original
  mutate(Compare = fct_relevel(Compare, "Low Rank Solution",
                            "Sparse Solution",
                            "Model Prediction")) %>% 
  ggplot(aes(x = POP, y = Value)) + 
  geom_jitter(aes(color = Compare), alpha = 0.1, width = 0.3, height = 0) + 
  theme_bw() +
  geom_point(aes(y = LOD), shape = 3, size = 0.5) +
  facet_wrap(.~Percent) +
  labs(x = "POP", 
       y = "Solution Value",
       title = "nnS LOD PCP Solution Values <LOD") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, hjust = 1))
```

* Plus sign (\+) indicates LOD for each chemical

```{r, fig.align = "center"}
plotall_sqrt2 %>% 
  select(-Original) %>% 
  rbind(., org) %>% 
  drop_na(.) %>% 
  #filter(Compare != "Original") %>% 
  # with and without Original
  mutate(Compare = fct_relevel(Compare, "Low Rank Solution",
                            "Sparse Solution",
                            "Model Prediction",
                            "Original")) %>% 
  ggplot(aes(x = POP, y = Value)) + 
  geom_jitter(aes(color = Compare), alpha = 0.1, width = 0.3, height = 0) + 
  theme_bw() +
  geom_point(aes(y = LOD), shape = 3, size = 0.5) +
  facet_wrap(.~Percent) +
  labs(x = "POP", 
       y = "Solution Value",
       title = "Original PCP w/ LOD/sqrt(2) Solution Values <LOD + Original Values") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, hjust = 1))
```

* Plus sign (\+) indicates LOD for each chemical

```{r, fig.align = "center"}
plotall_sqrt2 %>% 
  select(-Original) %>% 
  rbind(., org) %>% 
  drop_na(.) %>% 
  filter(Compare != "Original") %>% 
  # with and without Original
  mutate(Compare = fct_relevel(Compare, "Low Rank Solution",
                            "Sparse Solution",
                            "Model Prediction")) %>% 
  ggplot(aes(x = POP, y = Value)) + 
  geom_jitter(aes(color = Compare), alpha = 0.1, width = 0.3, height = 0) + 
  theme_bw() +
  geom_point(aes(y = LOD), shape = 3, size = 0.5) +
  facet_wrap(.~Percent) +
  labs(x = "POP", 
       y = "Solution Value",
       title = "Original PCP w/ LOD/sqrt(2) Solution Values <LOD") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r, message=FALSE, fig.align = "center"}
plotall %>% 
  select(-Original) %>% 
  rbind(., org) %>% 
  drop_na(.) %>% 
  mutate(Value_SD = Value - LOD) %>%
  #filter(Compare != "Sparse Solution") %>% 
  ggplot(aes(x = Value)) + 
  geom_histogram(aes(fill = Compare, color = Compare), alpha = 0.25) + 
  theme_bw() +
  facet_wrap(.~Percent, scales = "free") +
  labs(x = "Solution Value", 
       y = "Count",
       title = "LOD PCP Solution Values <LOD + Original Values") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, hjust = 1))

plotall_nns %>% 
  select(-Original) %>% 
  rbind(., org) %>% 
  drop_na(.) %>% 
  #filter(Compare != "Sparse Solution") %>% 
  ggplot(aes(x = Value)) + 
  geom_histogram(aes(fill = Compare, color = Compare), alpha = 0.25) + 
  theme_bw() +
  facet_wrap(.~Percent, scales = "free") +
  labs(x = "Solution Value", 
       y = "Count",
       title = "nnS LOD PCP Solution Values <LOD + Original Values") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, hjust = 1))

plotall_sqrt2 %>% 
  select(-Original) %>% 
  rbind(., org) %>% 
  drop_na(.) %>% 
  #filter(Compare != "Sparse Solution") %>% 
  ggplot(aes(x = Value)) + 
  geom_histogram(aes(fill = Compare, color = Compare), alpha = 0.25) + 
  theme_bw() +
  facet_wrap(.~Percent, scales = "free") +
  labs(x = "Solution Value", 
       y = "Count",
       title = "Original PCP w/ LOD/sqrt(2) Solution Values <LOD + Original Values") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90, hjust = 1))
```

