---
title: "Principal Component Pursuit w/ <LOD Penalty"
author: "Lizzy Gibson"
date: "7/16/2019"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE}
require("knitr")
opts_knit$set(root.dir = "../../")
opts_chunk$set(echo = TRUE)
options(scipen = 999)
library(R.matlab)
library(tidyverse)
```

## Data

* 20 air pollution species
* 2,478 days (~6.7 years)

```{r}
# Read air pollution data
mixture <- readMat("./Data/mixtures_data.mat")

mixture_data <- as.data.frame(mixture) %>% as_tibble() %>% 
  select(Al, As, Ba, bc, Br, Ca, Cl,
         Cr, Cu, Fe, K,  Mn,  Ni,  Pb,  S,  Se,  Si,
         Ti,  V, Zn) %>% 
  drop_na()

mixture_data
```

## Steps

1. Run Jingkai's PCP version on original air pollution data (MATLAB).
2. Artificially assign increasing LOD's (10%, 20%, 30%, 40%, and 50% <LOD) to separate test datasets (R).
3. Run Jingkai's PCP version on all 5 <LOD datasets, save L and S matrices from each (MATLAB).
4. Compare results from <LOD datasets with original (R).

## Create \<LOD Datasets

```{r}
# Create version with 10% lowest values for each variable as below the LOD
mix_data_lod_10 <- mixture_data %>% 
  mutate_all(~ifelse(. <= quantile(., probs = .10), -1, .))

#write_csv(as_tibble(mix_data_lod_10), "./Below_LOD/R/BLOD_airpol_data/mix_data_lod_10.csv")

# Create version with 20% lowest values for each variable as below the LOD
mix_data_lod_20 <- mixture_data %>% 
  mutate_all(~ifelse(. <= quantile(., probs = .20), -1, .))

#write_csv(as_tibble(mix_data_lod_20), "./Below_LOD/R/BLOD_airpol_data/mix_data_lod_20.csv")

# Create version with 30% lowest values for each variable as below the LOD
mix_data_lod_30 <- mixture_data %>% 
  mutate_all(~ifelse(. <= quantile(., probs = .30), -1, .))

#write_csv(as_tibble(mix_data_lod_30), "./Below_LOD/R/BLOD_airpol_data/mix_data_lod_30.csv")

# Create version with 40% lowest values for each variable as below the LOD
mix_data_lod_40 <- mixture_data %>% 
  mutate_all(~ifelse(. <= quantile(., probs = .40), -1, .))

#write_csv(as_tibble(mix_data_lod_40), "./Below_LOD/R/BLOD_airpol_data/mix_data_lod_40.csv")

# Create version with 50% lowest values for each variable as below the LOD
mix_data_lod_50 <- mixture_data %>% 
  mutate_all(~ifelse(. <= quantile(., probs = .50), -1, .))

#write_csv(as_tibble(mix_data_lod_50), "./Below_LOD/R/BLOD_airpol_data/mix_data_lod_50.csv")
```

### Quantiles

```{r}
mixture_data %>% 
  summarise_all(quantile, probs = .10) %>% as.matrix()

mixture_data %>% 
  summarise_all(quantile, probs = .20) %>% as.matrix()

mixture_data %>% 
  summarise_all(quantile, probs = .30) %>% as.matrix()

mixture_data %>% 
  summarise_all(quantile, probs = .40) %>% as.matrix()

mixture_data %>% 
  summarise_all(quantile, probs = .50) %>% as.matrix()
```

## Read MATLAB Output

Run PCP on separate datasets in MATLAB, load results L and S matrices from file.

*Low Rank Matrices*
```{r}
L_lod0 <- readMat("./Below_LOD/MATLAB/LOD_demo_output/lowrank_lod0.mat") %>% as.data.frame() %>% as_tibble() %>% as.matrix()
L_lod10 <- readMat("./Below_LOD/MATLAB/LOD_demo_output/lowrank_lod10.mat") %>% as.data.frame() %>% as_tibble() %>% as.matrix()
L_lod20 <- readMat("./Below_LOD/MATLAB/LOD_demo_output/lowrank_lod20.mat") %>% as.data.frame() %>% as_tibble() %>% as.matrix()
L_lod30 <- readMat("./Below_LOD/MATLAB/LOD_demo_output/lowrank_lod30.mat") %>% as.data.frame() %>% as_tibble() %>% as.matrix()
L_lod40 <- readMat("./Below_LOD/MATLAB/LOD_demo_output/lowrank_lod40.mat") %>% as.data.frame() %>% as_tibble() %>% as.matrix()
L_lod50 <- readMat("./Below_LOD/MATLAB/LOD_demo_output/lowrank_lod50.mat") %>% as.data.frame() %>% as_tibble() %>% as.matrix()
```

*Sparse Matrices*
```{r}
S_lod0 <- readMat("./Below_LOD/MATLAB/LOD_demo_output/sparse_lod0.mat") %>% as.data.frame() %>% as_tibble() %>% as.matrix()
S_lod10 <- readMat("./Below_LOD/MATLAB/LOD_demo_output/sparse_lod10.mat") %>% as.data.frame() %>% as_tibble() %>% as.matrix()
S_lod20 <- readMat("./Below_LOD/MATLAB/LOD_demo_output/sparse_lod20.mat") %>% as.data.frame() %>% as_tibble() %>% as.matrix()
S_lod30 <- readMat("./Below_LOD/MATLAB/LOD_demo_output/sparse_lod30.mat") %>% as.data.frame() %>% as_tibble() %>% as.matrix()
S_lod40 <- readMat("./Below_LOD/MATLAB/LOD_demo_output/sparse_lod40.mat") %>% as.data.frame() %>% as_tibble() %>% as.matrix()
S_lod50 <- readMat("./Below_LOD/MATLAB/LOD_demo_output/sparse_lod50.mat") %>% as.data.frame() %>% as_tibble() %>% as.matrix()
```

## Compare Results

### Visualize

#### Original Data

```{r}
V_original <- svd(mixture_data)$v[,1:5]

as_tibble(V_original) %>% 
  mutate(id = c("Al", "As", "Ba", "bc", "Br", "Ca", "Cl",
                "Cr", "Cu", "Fe", "K",  "Mn",  "Ni",  "Pb",  "S",  "Se",  "Si",
                "Ti",  "V", "Zn")) %>% 
  select(id, everything()) %>% 
  gather(key = singular_vector, value = magnitude, V1:V5) %>%
  filter(singular_vector %in% c("V1", "V2", "V3", "V4", "V5")) %>% 
  ggplot(aes(x = id, y = magnitude)) + geom_point(color = "blue") + 
  geom_segment(aes(xend = id, yend = 0), color = "blue") +
  facet_grid(. ~ singular_vector) +
  geom_hline(yintercept = 0, linetype = "dashed", 
             color = "red") +
  theme_bw() + labs(x = "", y = "Magnitude", title = "First 5 right singular vectors of V from SVD(original)")

```

**No values \<LOD**

<p float="left">
  <img src="../IMAGES/fig1_lod_0.png" width="350" />
  <img src="../IMAGES/fig2_lod_0.png" width="350" /> 
</p>

**10\% values \<LOD**

<p float="left">
  <img src="../IMAGES/fig1_lod_10.png" width="350" />
  <img src="../IMAGES/fig2_lod_10.png" width="350" /> 
</p>

**20\% values \<LOD**

<p float="left">
  <img src="../IMAGES/fig1_lod_20.png" width="350" />
  <img src="../IMAGES/fig2_lod_20.png" width="350" /> 
</p>

**30\% values \<LOD**

<p float="left">
  <img src="../IMAGES/fig1_lod_30.png" width="350" />
  <img src="../IMAGES/fig2_lod_30.png" width="350" /> 
</p>

**40\% values \<LOD**

<p float="left">
  <img src="../IMAGES/fig1_lod_40.png" width="350" />
  <img src="../IMAGES/fig2_lod_40.png" width="350" /> 
</p>

**50\% values \<LOD**

<p float="left">
  <img src="../IMAGES/fig1_lod_50.png" width="350" />
  <img src="../IMAGES/fig2_lod_50.png" width="350" /> 
</p>

### X - L - S

```{r}
X <- as.matrix(mixture_data)
F_norm <- as_tibble(cbind(lod0 = norm((X - L_lod0 - S_lod0), type = "F")^2,
      lod10 = norm((X - L_lod10 - S_lod10), type = "F")^2,
      lod20 = norm((X - L_lod20 - S_lod20), type = "F")^2,
      lod30 = norm((X - L_lod30 - S_lod30), type = "F")^2,
      lod40 = norm((X - L_lod40 - S_lod40), type = "F")^2,
      lod50 = norm((X - L_lod50 - S_lod50), type = "F")^2)) %>% 
  gather(percent_blod, norm)

F_norm %>% ggplot(aes(x = percent_blod, y = norm)) + geom_point() + geom_path(aes(group = 1)) + theme_bw()
```

### \% L - 0\% L

```{r}
L_diff <- as_tibble(cbind(lod0 = norm((L_lod0 - L_lod0), type = "F")^2,
      lod10 = norm((L_lod10 - L_lod0), type = "F")^2,
      lod20 = norm((L_lod20 - L_lod0), type = "F")^2,
      lod30 = norm((L_lod30 - L_lod0), type = "F")^2,
      lod40 = norm((L_lod40 - L_lod0), type = "F")^2,
      lod50 = norm((L_lod50 - L_lod0), type = "F")^2)) %>% 
  gather(percent_blod, norm)

L_diff %>% ggplot(aes(x = percent_blod, y = norm)) + geom_point() + geom_path(aes(group = 1)) + theme_bw()
```

### \% S - 0\% S

```{r}
S_diff <- as_tibble(cbind(lod0 = norm((S_lod0 - S_lod0), type = "F")^2,
      lod10 = norm((S_lod10 - S_lod0), type = "F")^2,
      lod20 = norm((S_lod20 - S_lod0), type = "F")^2,
      lod30 = norm((S_lod30 - S_lod0), type = "F")^2,
      lod40 = norm((S_lod40 - S_lod0), type = "F")^2,
      lod50 = norm((S_lod50 - S_lod0), type = "F")^2)) %>% 
  gather(percent_blod, norm)

S_diff %>% ggplot(aes(x = percent_blod, y = norm)) + geom_point() + geom_path(aes(group = 1)) + theme_bw()
```

### SVD results of L matrix

```{r}
# Extract singular vectors from each low rank solution matrix
V_lod0 <- svd(L_lod0)$v[,1:5]
V_lod10 <- svd(L_lod10)$v[,1:5]
V_lod20 <- svd(L_lod20)$v[,1:5]
V_lod30 <- svd(L_lod30)$v[,1:5]
V_lod40 <- svd(L_lod40)$v[,1:5]
V_lod50 <- svd(L_lod50)$v[,1:5]

V_diff_orig <- as_tibble(cbind(lod_orig =norm((V_original - V_lod0), type = "F")^2,
      lod0 =norm((V_lod0 - V_lod0), type = "F")^2,
      lod10 =norm((V_lod10 - V_lod0), type = "F")^2,
      lod20 =norm((V_lod20 - V_lod0), type = "F")^2,
      lod30 =norm((V_lod30 - V_lod0), type = "F")^2,
      lod40 =norm((V_lod40 - V_lod0), type = "F")^2,
      lod50 =norm((V_lod50 - V_lod0), type = "F")^2)) %>% 
  gather(percent_blod, norm)

V_diff <- as_tibble(cbind(lod0 =norm((V_lod0 - V_lod0), type = "F")^2,
      lod10 =norm((V_lod10 - V_lod0), type = "F")^2,
      lod20 =norm((V_lod20 - V_lod0), type = "F")^2,
      lod30 =norm((V_lod30 - V_lod0), type = "F")^2,
      lod40 =norm((V_lod40 - V_lod0), type = "F")^2,
      lod50 =norm((V_lod50 - V_lod0), type = "F")^2)) %>% 
  gather(percent_blod, norm)

V_diff_orig %>% ggplot(aes(x = percent_blod, y = norm)) + geom_point() + geom_path(aes(group = 1)) + theme_bw()

V_diff %>% ggplot(aes(x = percent_blod, y = norm)) + geom_point() + geom_path(aes(group = 1)) + theme_bw()
```

### Values <LOD vs >LOD

* Are values <LOD estimated more poorly than those >LOD? Are <LOD driving the increased error?
* Rescale by range/variance of values <LOD.
    * Wider range --> more error.

### <LOD

```{r}
tf_lod_10 <- mix_data_lod_10 %>% 
  mutate_all(~ifelse(. == -1, TRUE, FALSE))
# T/F dataset, T = <LOD
blod_10 <- as.matrix(tf_lod_10*L_lod10)
# keep <LOD predictions, >LOD predictions are zero
true_10 <- as.matrix(mixture_data*tf_lod_10)
# keep 10% lowest true values, push >LOD values to zero

tf_lod_20 <- mix_data_lod_20 %>% 
  mutate_all(~ifelse(. == -1, TRUE, FALSE))
blod_20 <- as.matrix(tf_lod_20*L_lod20)
true_20 <- as.matrix(mixture_data*tf_lod_20)

tf_lod_30 <- mix_data_lod_30 %>% 
  mutate_all(~ifelse(. == -1, TRUE, FALSE))
blod_30 <- as.matrix(tf_lod_30*L_lod30)
true_30 <- as.matrix(mixture_data*tf_lod_30)

tf_lod_40 <- mix_data_lod_40 %>% 
  mutate_all(~ifelse(. == -1, TRUE, FALSE))
blod_40 <- as.matrix(tf_lod_40*L_lod40)
true_40 <- as.matrix(mixture_data*tf_lod_40)

tf_lod_50 <- mix_data_lod_50 %>% 
  mutate_all(~ifelse(. == -1, TRUE, FALSE))
blod_50 <- as.matrix(tf_lod_50*L_lod50)
true_50 <- as.matrix(mixture_data*tf_lod_50) 
```

```{r}
#divide by range
less_diff <- as_tibble(cbind(lod10 = norm((blod_10 - true_10)/(range(blod_10)[1] - range(blod_10)[2]), type = "F")^2,
      lod20 = norm((blod_20 - true_20)/(range(blod_20)[1] - range(blod_20)[2]), type = "F")^2,
      lod30 = norm((blod_30 - true_30)/(range(blod_30)[1] - range(blod_30)[2]), type = "F")^2,
      lod40 = norm((blod_40 - true_40)/(range(blod_40)[1] - range(blod_40)[2]), type = "F")^2,
      lod50 = norm((blod_50 - true_50)/(range(blod_50)[1] - range(blod_50)[2]), type = "F")^2)) %>% 
  gather(percent_blod, norm)

less_diff %>% ggplot(aes(x = percent_blod, y = norm)) + geom_point() + geom_path(aes(group = 1)) + theme_bw()

#divide by variance
less_diff2 <- as_tibble(cbind(lod10 = norm((blod_10 - true_10)/var(as.vector(blod_10)), type = "F")^2,
      lod20 = norm((blod_20 - true_20)/var(as.vector(blod_20)), type = "F")^2,
      lod30 = norm((blod_30 - true_30)/var(as.vector(blod_30)), type = "F")^2,
      lod40 = norm((blod_40 - true_40)/var(as.vector(blod_40)), type = "F")^2,
      lod50 = norm((blod_50 - true_50)/var(as.vector(blod_50)), type = "F")^2)) %>% 
  gather(percent_blod, norm)

less_diff2 %>% ggplot(aes(x = percent_blod, y = norm)) + geom_point() + geom_path(aes(group = 1)) + theme_bw()
```

### ABOVE LOD

```{r}
above_lod_10 <- mix_data_lod_10 %>% 
  mutate_all(~ifelse(. == -1, FALSE, TRUE))
# T/F dataset, T = >LOD
above_blod_10 <- as.matrix(above_lod_10*L_lod10)
# keep >LOD predictions, BLOD predictions are zero
above_true_10 <- as.matrix(mixture_data*above_lod_10)
# keep 10% lowest true values, push >LOD values to zero

above_lod_20 <- mix_data_lod_20 %>% 
  mutate_all(~ifelse(. == -1, FALSE, TRUE))
above_blod_20 <- as.matrix(above_lod_20*L_lod20)
above_true_20 <- as.matrix(mixture_data*above_lod_20)

above_lod_30 <- mix_data_lod_30 %>% 
  mutate_all(~ifelse(. == -1, FALSE, TRUE))
above_blod_30 <- as.matrix(above_lod_30*L_lod30)
above_true_30 <- as.matrix(mixture_data*above_lod_30)

above_lod_40 <- mix_data_lod_40 %>% 
  mutate_all(~ifelse(. == -1, FALSE, TRUE))
above_blod_40 <- as.matrix(above_lod_40*L_lod40)
above_true_40 <- as.matrix(mixture_data*above_lod_40)

above_lod_50 <- mix_data_lod_50 %>% 
  mutate_all(~ifelse(. == -1, FALSE, TRUE))
above_blod_50 <- as.matrix(above_lod_50*L_lod50)
above_true_50 <- as.matrix(mixture_data*above_lod_50) 
```

```{r}
#divide by range
above_diff <- as_tibble(cbind(
  lod10 = norm((above_blod_10 - above_true_10)/(range(above_blod_10)[1] - range(above_blod_10)[2]), type = "F")^2,
  lod20 = norm((above_blod_20 - above_true_20)/(range(above_blod_20)[1] - range(above_blod_20)[2]), type = "F")^2,
  lod30 = norm((above_blod_30 - above_true_30)/(range(above_blod_30)[1] - range(above_blod_30)[2]), type = "F")^2,
  lod40 = norm((above_blod_40 - above_true_40)/(range(above_blod_40)[1] - range(above_blod_40)[2]), type = "F")^2,
  lod50 = norm((above_blod_50 - above_true_50)/(range(above_blod_50)[1] - range(above_blod_50)[2]), type = "F")^2)) %>% 
  gather(percent_blod, norm)

above_diff %>% ggplot(aes(x = percent_blod, y = norm)) + geom_point() + geom_path(aes(group = 1)) + theme_bw()

#divide by variance
above_diff2 <- as_tibble(cbind(
  lod10 = norm((above_blod_10 - above_true_10)/var(as.vector(above_blod_10)), type = "F")^2,
  lod20 = norm((above_blod_20 - above_true_20)/var(as.vector(above_blod_20)), type = "F")^2,
  lod30 = norm((above_blod_30 - above_true_30)/var(as.vector(above_blod_30)), type = "F")^2,
  lod40 = norm((above_blod_40 - above_true_40)/var(as.vector(above_blod_40)), type = "F")^2,
  lod50 = norm((above_blod_50 - above_true_50)/var(as.vector(above_blod_50)), type = "F")^2)) %>% 
  gather(percent_blod, norm)

above_diff2 %>% ggplot(aes(x = percent_blod, y = norm)) + geom_point() + geom_path(aes(group = 1)) + theme_bw()

var(as.vector(above_blod_50))
```























