---
title: "<LOD PCP, Best Mu, Scaled"
subtitle: "Boston air pollution example"
author: "Lizzy Gibson"
date: "3/27/2020"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    code_folding: 'hide'
---

```{r setup, include=FALSE}
require("knitr")
opts_chunk$set(echo = TRUE)
options(scipen = 999)
library(R.matlab)
library(tidyverse)
library(gridExtra)
library(Matrix)
library(matconv)
library(patchwork)
library(pcpr)
```

## Data

* 20 air pollution species
* 2,478 days (~6.7 years)

```{r, read}
# Read air pollution data
mixture <- readMat(here::here("./Data/mixtures_data.mat"))

mixture_data <- as.data.frame(mixture) %>% as_tibble() %>% 
  select(Al, As, Ba, bc, Br, Ca, Cl,
         Cr, Cu, Fe, K,  Mn,  Ni,  Pb,  S,  Se,  Si,
         Ti,  V, Zn) %>% 
  drop_na() %>% mutate_all(scale, center = FALSE)

mix <- as.matrix(mixture_data)
```

### Create \<LOD Datasets

```{r, neg}
# Create version with 10% lowest values for each variable as below the LOD
mix_data_lod_10 <- mixture_data %>% 
  mutate_all(~ifelse(. < quantile(., probs = .10), -1, .)) %>% as.matrix()

# Create version with 20% lowest values for each variable as below the LOD
mix_data_lod_20 <- mixture_data %>% 
  mutate_all(~ifelse(. < quantile(., probs = .20), -1, .)) %>% as.matrix()

# Create version with 30% lowest values for each variable as below the LOD
mix_data_lod_30 <- mixture_data %>% 
  mutate_all(~ifelse(. < quantile(., probs = .30), -1, .)) %>% as.matrix()

# Create version with 40% lowest values for each variable as below the LOD
mix_data_lod_40 <- mixture_data %>% 
  mutate_all(~ifelse(. < quantile(., probs = .40), -1, .)) %>% as.matrix()

# Create version with 50% lowest values for each variable as below the LOD
mix_data_lod_50 <- mixture_data %>% 
  mutate_all(~ifelse(. < quantile(., probs = .50), -1, .)) %>% as.matrix()

# Create version with 10% lowest values for each variable as below the LOD
mix_data_lod_10_0 <- mixture_data %>% 
  mutate_all(~ifelse(. < quantile(., probs = .10), 0, .)) %>% as.matrix()

# Create version with 20% lowest values for each variable as below the LOD
mix_data_lod_20_0 <- mixture_data %>% 
  mutate_all(~ifelse(. < quantile(., probs = .20), 0, .)) %>% as.matrix()

# Create version with 30% lowest values for each variable as below the LOD
mix_data_lod_30_0 <- mixture_data %>% 
  mutate_all(~ifelse(. < quantile(., probs = .30), 0, .)) %>% as.matrix()

# Create version with 40% lowest values for each variable as below the LOD
mix_data_lod_40_0 <- mixture_data %>% 
  mutate_all(~ifelse(. < quantile(., probs = .40), 0, .)) %>% as.matrix()

# Create version with 50% lowest values for each variable as below the LOD
mix_data_lod_50_0 <- mixture_data %>% 
  mutate_all(~ifelse(. < quantile(., probs = .50), 0, .)) %>% as.matrix()

# Create version with 10% lowest values for each variable as below the LOD
mix_data_lod_10_sqrt2 <- mixture_data %>% 
  mutate_all(~ifelse(. <= quantile(., probs = .10), (quantile(., probs = .10)/sqrt(2)), .)) %>% as.matrix()

# Create version with 20% lowest values for each variable as below the LOD
mix_data_lod_20_sqrt2 <- mixture_data %>% 
  mutate_all(~ifelse(. <= quantile(., probs = .20), (quantile(., probs = .20)/sqrt(2)), .)) %>% as.matrix()

# Create version with 30% lowest values for each variable as below the LOD
mix_data_lod_30_sqrt2 <- mixture_data %>% 
  mutate_all(~ifelse(. <= quantile(., probs = .30), (quantile(., probs = .30)/sqrt(2)), .)) %>% as.matrix()

# Create version with 40% lowest values for each variable as below the LOD
mix_data_lod_40_sqrt2 <- mixture_data %>% 
  mutate_all(~ifelse(. <= quantile(., probs = .40), (quantile(., probs = .40)/sqrt(2)), .)) %>% as.matrix()

# Create version with 50% lowest values for each variable as below the LOD
mix_data_lod_50_sqrt2 <- mixture_data %>% 
  mutate_all(~ifelse(. <= quantile(., probs = .50), (quantile(., probs = .50)/sqrt(2)), .)) %>% as.matrix()
```

### Quantiles = LOD

```{r}
delta10 <- mixture_data %>% 
  summarise_all(quantile, probs = .10) %>% as_vector()

delta20 <- mixture_data %>% 
  summarise_all(quantile, probs = .20) %>% as_vector()

delta30 <- mixture_data %>% 
  summarise_all(quantile, probs = .30) %>% as_vector()

delta40 <- mixture_data %>% 
  summarise_all(quantile, probs = .40) %>% as_vector()

delta50 <- mixture_data %>% 
  summarise_all(quantile, probs = .50) %>% as_vector()
```

## PCP

```{r, jingkai_leave, cache = TRUE, include=FALSE, echo=FALSE}
m <- nrow(mixture_data)
p <- ncol(mixture_data)

lambda_mix <- 1/sqrt(m)
mu_mix <- sqrt(p/(2*log(m*p)))
  
results_0  <- pcp_lod(mix,             lambda_mix, mu_mix, 0)
results_10 <- pcp_lod(mix_data_lod_10, lambda_mix, mu_mix, delta10)
results_20 <- pcp_lod(mix_data_lod_20, lambda_mix, mu_mix, delta20)
results_30 <- pcp_lod(mix_data_lod_30, lambda_mix, mu_mix, delta30)
results_40 <- pcp_lod(mix_data_lod_40, lambda_mix, mu_mix, delta40)
results_50 <- pcp_lod(mix_data_lod_50, lambda_mix, mu_mix, delta50)

nn_results_0  <- pcp_lod_NN(mix, lambda_mix, mu_mix, 0)
nn_results_10 <- pcp_lod_NN(mix, lambda_mix, mu_mix, delta10)
nn_results_20 <- pcp_lod_NN(mix, lambda_mix, mu_mix, delta20)
nn_results_30 <- pcp_lod_NN(mix, lambda_mix, mu_mix, delta30)
nn_results_40 <- pcp_lod_NN(mix, lambda_mix, mu_mix, delta40)
nn_results_50 <- pcp_lod_NN(mix, lambda_mix, mu_mix, delta50)

L_lod0 <- results_0[[1]]
S_lod0 <- results_0[[2]]
L_lod10 <- results_10[[1]]
S_lod10 <- results_10[[2]]
L_lod20 <- results_20[[1]]
S_lod20 <- results_20[[2]]
L_lod30 <- results_30[[1]]
S_lod30 <- results_30[[2]]
L_lod40 <- results_40[[1]]
S_lod40 <- results_40[[2]]
L_lod50 <- results_50[[1]]
S_lod50 <- results_50[[2]]

nn_L_lod0 <- nn_results_0[[1]]
nn_S_lod0 <- nn_results_0[[2]]
nn_L_lod10 <- nn_results_10[[1]]
nn_S_lod10 <- nn_results_10[[2]]
nn_L_lod20 <- nn_results_20[[1]]
nn_S_lod20 <- nn_results_20[[2]]
nn_L_lod30 <- nn_results_30[[1]]
nn_S_lod30 <- nn_results_30[[2]]
nn_L_lod40 <- nn_results_40[[1]]
nn_S_lod40 <- nn_results_40[[2]]
nn_L_lod50 <- nn_results_50[[1]]
nn_S_lod50 <- nn_results_50[[2]]

all_equal(nn_L_lod0, L_lod0)
all_equal(nn_L_lod10, L_lod10)
all_equal(nn_L_lod20, L_lod20)
all_equal(nn_L_lod30, L_lod30)
all_equal(nn_L_lod40, L_lod40)
all_equal(nn_L_lod50, L_lod50)
```

```{r, subzero_old, cache = TRUE, include=FALSE, echo=FALSE}
results_0_0  <- original_pcp(mix,               lambda_mix, mu_mix)
results_10_0 <- original_pcp(mix_data_lod_10_0, lambda_mix, mu_mix)
results_20_0 <- original_pcp(mix_data_lod_20_0, lambda_mix, mu_mix)
results_30_0 <- original_pcp(mix_data_lod_30_0, lambda_mix, mu_mix)
results_40_0 <- original_pcp(mix_data_lod_40_0, lambda_mix, mu_mix)
results_50_0 <- original_pcp(mix_data_lod_50_0, lambda_mix, mu_mix)

L_lod0_0 <- results_0_0[[1]]
S_lod0_0 <- results_0_0[[2]]
L_lod10_0 <- results_10_0[[1]]
S_lod10_0 <- results_10_0[[2]]
L_lod20_0 <- results_20_0[[1]]
S_lod20_0 <- results_20_0[[2]]
L_lod30_0 <- results_30_0[[1]]
S_lod30_0 <- results_30_0[[2]]
L_lod40_0 <- results_40_0[[1]]
S_lod40_0 <- results_40_0[[2]]
L_lod50_0 <- results_50_0[[1]]
S_lod50_0 <- results_50_0[[2]]

results_0_sqrt2  <- original_pcp(mix,                   lambda_mix, mu_mix)
results_10_sqrt2 <- original_pcp(mix_data_lod_10_sqrt2, lambda_mix, mu_mix)
results_20_sqrt2 <- original_pcp(mix_data_lod_20_sqrt2, lambda_mix, mu_mix)
results_30_sqrt2 <- original_pcp(mix_data_lod_30_sqrt2, lambda_mix, mu_mix)
results_40_sqrt2 <- original_pcp(mix_data_lod_40_sqrt2, lambda_mix, mu_mix)
results_50_sqrt2 <- original_pcp(mix_data_lod_50_sqrt2, lambda_mix, mu_mix)

L_lod0_sqrt2 <- results_0_sqrt2[[1]]
S_lod0_sqrt2 <- results_0_sqrt2[[2]]
L_lod10_sqrt2 <- results_10_sqrt2[[1]]
S_lod10_sqrt2 <- results_10_sqrt2[[2]]
L_lod20_sqrt2 <- results_20_sqrt2[[1]]
S_lod20_sqrt2 <- results_20_sqrt2[[2]]
L_lod30_sqrt2 <- results_30_sqrt2[[1]]
S_lod30_sqrt2 <- results_30_sqrt2[[2]]
L_lod40_sqrt2 <- results_40_sqrt2[[1]]
S_lod40_sqrt2 <- results_40_sqrt2[[2]]
L_lod50_sqrt2 <- results_50_sqrt2[[1]]
S_lod50_sqrt2 <- results_50_sqrt2[[2]]
```

## X - L - S

```{r}
F_norm <- as_tibble(cbind(lod0 = norm((mix - L_lod0 - S_lod0), type = "F")/norm((mix), type = "F"),
      lod10 = norm((mix - L_lod10 - S_lod10), type = "F")/norm((mix), type = "F"),
      lod20 = norm((mix - L_lod20 - S_lod20), type = "F")/norm((mix), type = "F"),
      lod30 = norm((mix - L_lod30 - S_lod30), type = "F")/norm((mix), type = "F"),
      lod40 = norm((mix - L_lod40 - S_lod40), type = "F")/norm((mix), type = "F"),
      lod50 = norm((mix - L_lod50 - S_lod50), type = "F")/norm((mix), type = "F"))) %>% 
  gather(percent_blod, norm) %>% 
  mutate(Matrix = "Both")

rel_error_neg <- F_norm %>% ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point() + geom_path(aes(group = 1)) + theme_bw() +
  labs(x = "Percent Below LOD", y = "Relative Error\n(norm(X-L-S) / norm(X))",
       title = "Jingkai's <LOD PCP")

nn_F_norm <- as_tibble(cbind(lod0 = norm((mix - nn_L_lod0 - nn_S_lod0), type = "F")/norm((mix), type = "F"),
      lod10 = norm((mix - nn_L_lod10 - nn_S_lod10), type = "F")/norm((mix), type = "F"),
      lod20 = norm((mix - nn_L_lod20 - nn_S_lod20), type = "F")/norm((mix), type = "F"),
      lod30 = norm((mix - nn_L_lod30 - nn_S_lod30), type = "F")/norm((mix), type = "F"),
      lod40 = norm((mix - nn_L_lod40 - nn_S_lod40), type = "F")/norm((mix), type = "F"),
      lod50 = norm((mix - nn_L_lod50 - nn_S_lod50), type = "F")/norm((mix), type = "F"))) %>% 
  gather(percent_blod, norm) %>% 
  mutate(Matrix = "Both")

rel_error_nn <- nn_F_norm %>% ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point() + geom_path(aes(group = 1)) + theme_bw() +
  labs(x = "Percent Below LOD", y = "Relative Error\n(norm(X-L-S) / norm(X))",
       title = "<LOD PCP with measured values")

F_norm_0 <- as_tibble(cbind(lod0 = norm((mix - L_lod0_0 - S_lod0_0), type = "F")/norm((mix), type = "F"),
      lod10 = norm((mix - L_lod10_0 - S_lod10_0), type = "F")/norm((mix), type = "F"),
      lod20 = norm((mix - L_lod20_0 - S_lod20_0), type = "F")/norm((mix), type = "F"),
      lod30 = norm((mix - L_lod30_0 - S_lod30_0), type = "F")/norm((mix), type = "F"),
      lod40 = norm((mix - L_lod40_0 - S_lod40_0), type = "F")/norm((mix), type = "F"),
      lod50 = norm((mix - L_lod50_0 - S_lod50_0), type = "F")/norm((mix), type = "F"))) %>% 
  gather(percent_blod, norm) %>% 
  mutate(Matrix = "Both")

rel_error_0 <- F_norm_0 %>% ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point() + geom_path(aes(group = 1)) + theme_bw() +
  labs(x = "Percent Below LOD", y = "Relative Error\n(norm(X-L-S) / norm(X))",
       title = "Original PCP with constant zero")

F_norm_sqrt2 <- as_tibble(cbind(lod0 = norm((mix - L_lod0_sqrt2 - S_lod0_sqrt2), type = "F")/norm((mix), type = "F"),
      lod10 = norm((mix - L_lod10_sqrt2 - S_lod10_sqrt2), type = "F")/norm((mix), type = "F"),
      lod20 = norm((mix - L_lod20_sqrt2 - S_lod20_sqrt2), type = "F")/norm((mix), type = "F"),
      lod30 = norm((mix - L_lod30_sqrt2 - S_lod30_sqrt2), type = "F")/norm((mix), type = "F"),
      lod40 = norm((mix - L_lod40_sqrt2 - S_lod40_sqrt2), type = "F")/norm((mix), type = "F"),
      lod50 = norm((mix - L_lod50_sqrt2 - S_lod50_sqrt2), type = "F")/norm((mix), type = "F"))) %>% 
  gather(percent_blod, norm) %>% 
  mutate(Matrix = "Both")

rel_error_s2 <- F_norm_sqrt2 %>% ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point() + geom_path(aes(group = 1)) + theme_bw() +
  labs(x = "Percent Below LOD", y = "Relative Error\n(norm(X-L-S) / norm(X))",
       title = "Original PCP with LOD/sqrt(2)")
```

### Viz

```{r}
(rel_error_neg + 
     ylim(0, 0.3) + 
     xlab("")) +
   (rel_error_nn + 
      ylim(0, 0.3) + 
      xlab("") + ylab(""))

((rel_error_0  + ylim(0, 0.3)) + 
 (rel_error_s2 + ylim(0, 0.3) + ylab("")))
```

## Individual Solution Matrices

```{r}
L_diff <- as_tibble(cbind(lod0 = norm((L_lod0 - L_lod0), type = "F")/norm((L_lod0), type = "F"),
      lod10 = norm((L_lod10 - L_lod0), type = "F")/norm((L_lod0), type = "F"),
      lod20 = norm((L_lod20 - L_lod0), type = "F")/norm((L_lod0), type = "F"),
      lod30 = norm((L_lod30 - L_lod0), type = "F")/norm((L_lod0), type = "F"),
      lod40 = norm((L_lod40 - L_lod0), type = "F")/norm((L_lod0), type = "F"),
      lod50 = norm((L_lod50 - L_lod0), type = "F")/norm((L_lod0), type = "F"))) %>% 
  gather(percent_blod, norm) %>% 
  mutate(Matrix = "Low-Rank")

S_diff <- as_tibble(cbind(lod0 = norm((S_lod0 - S_lod0), type = "F")/norm((S_lod0), type = "F"),
      lod10 = norm((S_lod10 - S_lod0), type = "F")/norm((S_lod0), type = "F"),
      lod20 = norm((S_lod20 - S_lod0), type = "F")/norm((S_lod0), type = "F"),
      lod30 = norm((S_lod30 - S_lod0), type = "F")/norm((S_lod0), type = "F"),
      lod40 = norm((S_lod40 - S_lod0), type = "F")/norm((S_lod0), type = "F"),
      lod50 = norm((S_lod50 - S_lod0), type = "F")/norm((S_lod0), type = "F"))) %>% 
  gather(percent_blod, norm) %>% 
  mutate(Matrix = "Sparse")

ls_plot_neg <- rbind(L_diff, S_diff) %>% ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point(aes(color = Matrix)) + geom_path(aes(group = Matrix, color = Matrix)) + theme_bw() +
  labs(x = "Percent Below LOD", y = "Relative Error in Solution Matrices\n(norm(difference) / norm(lod0))",
       title = "Jingkai's <LOD PCP") + theme(legend.position = "bottom")

nn_L_diff <- as_tibble(cbind(lod0 = norm((nn_L_lod0 - nn_L_lod0), type = "F")/norm((nn_L_lod0), type = "F"),
      lod10 = norm((nn_L_lod10 - nn_L_lod0), type = "F")/norm((nn_L_lod0), type = "F"),
      lod20 = norm((nn_L_lod20 - nn_L_lod0), type = "F")/norm((nn_L_lod0), type = "F"),
      lod30 = norm((nn_L_lod30 - nn_L_lod0), type = "F")/norm((nn_L_lod0), type = "F"),
      lod40 = norm((nn_L_lod40 - nn_L_lod0), type = "F")/norm((nn_L_lod0), type = "F"),
      lod50 = norm((nn_L_lod50 - nn_L_lod0), type = "F")/norm((nn_L_lod0), type = "F"))) %>% 
  gather(percent_blod, norm) %>% 
  mutate(Matrix = "Low-Rank")

nn_S_diff <- as_tibble(cbind(lod0 = norm((nn_S_lod0 - nn_S_lod0), type = "F")/norm((nn_S_lod0), type = "F"),
      lod10 = norm((nn_S_lod10 - nn_S_lod0), type = "F")/norm((nn_S_lod0), type = "F"),
      lod20 = norm((nn_S_lod20 - nn_S_lod0), type = "F")/norm((nn_S_lod0), type = "F"),
      lod30 = norm((nn_S_lod30 - nn_S_lod0), type = "F")/norm((nn_S_lod0), type = "F"),
      lod40 = norm((nn_S_lod40 - nn_S_lod0), type = "F")/norm((nn_S_lod0), type = "F"),
      lod50 = norm((nn_S_lod50 - nn_S_lod0), type = "F")/norm((nn_S_lod0), type = "F"))) %>% 
  gather(percent_blod, norm) %>% 
  mutate(Matrix = "Sparse")

ls_plot_nn <- rbind(nn_L_diff, nn_S_diff) %>% ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point(aes(color = Matrix)) + geom_path(aes(group = Matrix, color = Matrix)) + theme_bw() +
  labs(x = "Percent Below LOD", y = "Relative Error in Solution Matrices\n(norm(difference) / norm(lod0))",
       title = "<LOD PCP with measured values") + theme(legend.position = "bottom")

L_diff_0 <- as_tibble(cbind(lod0 = norm((L_lod0_0 - L_lod0_0), type = "F")/norm((L_lod0_0), type = "F"),
      lod10 = norm((L_lod10_0 - L_lod0_0), type = "F")/norm((L_lod0_0), type = "F"),
      lod20 = norm((L_lod20_0 - L_lod0_0), type = "F")/norm((L_lod0_0), type = "F"),
      lod30 = norm((L_lod30_0 - L_lod0_0), type = "F")/norm((L_lod0_0), type = "F"),
      lod40 = norm((L_lod40_0 - L_lod0_0), type = "F")/norm((L_lod0_0), type = "F"),
      lod50 = norm((L_lod50_0 - L_lod0_0), type = "F")/norm((L_lod0_0), type = "F"))) %>% 
  gather(percent_blod, norm) %>% 
  mutate(Matrix = "Low-Rank")

S_diff_0 <- as_tibble(cbind(lod0 = norm((S_lod0_0 - S_lod0_0), type = "F")/norm((S_lod0_0), type = "F"),
      lod10 = norm((S_lod10_0 - S_lod0_0), type = "F")/norm((S_lod0_0), type = "F"),
      lod20 = norm((S_lod20_0 - S_lod0_0), type = "F")/norm((S_lod0_0), type = "F"),
      lod30 = norm((S_lod30_0 - S_lod0_0), type = "F")/norm((S_lod0_0), type = "F"),
      lod40 = norm((S_lod40_0 - S_lod0_0), type = "F")/norm((S_lod0_0), type = "F"),
      lod50 = norm((S_lod50_0 - S_lod0_0), type = "F")/norm((S_lod0_0), type = "F"))) %>% 
  gather(percent_blod, norm) %>% 
  mutate(Matrix = "Sparse")

ls_plot_0 <- rbind(L_diff_0, S_diff_0) %>% ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point(aes(color = Matrix)) + geom_path(aes(group = Matrix, color = Matrix)) + theme_bw() +
  labs(x = "Percent Below LOD", y = "Relative Error in Solution Matrices\n(norm(difference) / norm(lod0))",
       title = "Original PCP with constant zero") + theme(legend.position = "bottom")

L_diff_sqrt2 <- as_tibble(cbind(lod0 = norm((L_lod0_sqrt2 - L_lod0_sqrt2), type = "F")/norm((L_lod0_sqrt2), type = "F"),
      lod10 = norm((L_lod10_sqrt2 - L_lod0_sqrt2), type = "F")/norm((L_lod0_sqrt2), type = "F"),
      lod20 = norm((L_lod20_sqrt2 - L_lod0_sqrt2), type = "F")/norm((L_lod0_sqrt2), type = "F"),
      lod30 = norm((L_lod30_sqrt2 - L_lod0_sqrt2), type = "F")/norm((L_lod0_sqrt2), type = "F"),
      lod40 = norm((L_lod40_sqrt2 - L_lod0_sqrt2), type = "F")/norm((L_lod0_sqrt2), type = "F"),
      lod50 = norm((L_lod50_sqrt2 - L_lod0_sqrt2), type = "F")/norm((L_lod0_sqrt2), type = "F"))) %>% 
  gather(percent_blod, norm) %>% 
  mutate(Matrix = "Low-Rank")

S_diff_sqrt2 <- as_tibble(cbind(lod0 = norm((S_lod0_sqrt2 - S_lod0_sqrt2), type = "F")/norm((S_lod0_sqrt2), type = "F"),
      lod10 = norm((S_lod10_sqrt2 - S_lod0_sqrt2), type = "F")/norm((S_lod0_sqrt2), type = "F"),
      lod20 = norm((S_lod20_sqrt2 - S_lod0_sqrt2), type = "F")/norm((S_lod0_sqrt2), type = "F"),
      lod30 = norm((S_lod30_sqrt2 - S_lod0_sqrt2), type = "F")/norm((S_lod0_sqrt2), type = "F"),
      lod40 = norm((S_lod40_sqrt2 - S_lod0_sqrt2), type = "F")/norm((S_lod0_sqrt2), type = "F"),
      lod50 = norm((S_lod50_sqrt2 - S_lod0_sqrt2), type = "F")/norm((S_lod0_sqrt2), type = "F"))) %>% 
  gather(percent_blod, norm) %>% 
  mutate(Matrix = "Sparse")

ls_plot_s2 <- rbind(L_diff_sqrt2, S_diff_sqrt2) %>% ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point(aes(color = Matrix)) + geom_path(aes(group = Matrix, color = Matrix)) + theme_bw() +
  labs(x = "Percent Below LOD", y = "Relative Error in Solution Matrices\n(norm(difference) / norm(lod0_sqrt2))",
       title = "Original PCP with LOD/sqrt(2)") + theme(legend.position = "bottom")
```

### Viz

```{r}
(ls_plot_neg + 
     ylim(0, 0.6) + 
     xlab("") + theme(legend.position = "none")) +
   (ls_plot_nn + 
      ylim(0, 0.6) + 
      xlab("") + ylab("") + theme(legend.position = "none"))

(ls_plot_0 +
          ylim(0, 0.6) + theme(legend.position = "none")) + 
        (ls_plot_s2 + 
           ylim(0, 0.6) + 
           ylab(""))
```

## Values \<LOD vs \>LOD

```{r}
# BELOW LOD
# TRUE = <LOD
tf_lod_0 <- mixture_data %>% 
  as_tibble() %>% 
  mutate_all(function(x) ifelse(x == -1, TRUE, FALSE))
l_blod_0 <- as.matrix(tf_lod_0*L_lod0)
s_blod_0 <- as.matrix(tf_lod_0*S_lod0)
blod_0 <- as.matrix(mixture_data*tf_lod_0)

tf_lod_10 <- mix_data_lod_10 %>% 
  as_tibble() %>%
  mutate_all(function(x) ifelse(x == -1, TRUE, FALSE))
l_blod_10 <- as.matrix(tf_lod_10*L_lod10)
s_blod_10 <- as.matrix(tf_lod_10*S_lod10)
blod_10 <- as.matrix(mixture_data*tf_lod_10)

tf_lod_20 <- mix_data_lod_20 %>% 
  as_tibble() %>% 
  mutate_all(function(x) ifelse(x == -1, TRUE, FALSE))
l_blod_20 <- as.matrix(tf_lod_20*L_lod20)
s_blod_20 <- as.matrix(tf_lod_20*S_lod20)
blod_20 <- as.matrix(mixture_data*tf_lod_20)

tf_lod_30 <- mix_data_lod_30 %>% 
  as_tibble() %>% 
  mutate_all(function(x) ifelse(x == -1, TRUE, FALSE))
l_blod_30 <- as.matrix(tf_lod_30*L_lod30)
s_blod_30 <- as.matrix(tf_lod_30*S_lod30)
blod_30 <- as.matrix(mixture_data*tf_lod_30)

tf_lod_40 <- mix_data_lod_40 %>% 
  as_tibble() %>% 
  mutate_all(function(x) ifelse(x == -1, TRUE, FALSE))
l_blod_40 <- as.matrix(tf_lod_40*L_lod40)
s_blod_40 <- as.matrix(tf_lod_40*S_lod40)
blod_40 <- as.matrix(mixture_data*tf_lod_40)

tf_lod_50 <- mix_data_lod_50 %>% 
  as_tibble() %>% 
  mutate_all(function(x) ifelse(x == -1, TRUE, FALSE))
l_blod_50 <- as.matrix(tf_lod_50*L_lod50)
s_blod_50 <- as.matrix(tf_lod_50*S_lod50)
blod_50 <- as.matrix(mixture_data*tf_lod_50) 

#Subtract true values and divide by norm of true
less_diff <- as_tibble(cbind(lod0 = norm((blod_0 - l_blod_0 - s_blod_0), type = "F"), #/norm((mix), type = "F"),
      lod10 = norm((blod_10 - l_blod_10 - s_blod_10), type = "F")/norm((blod_10), type = "F"),
      lod20 = norm((blod_20 - l_blod_20 - s_blod_20), type = "F")/norm((blod_20), type = "F"),
      lod30 = norm((blod_30 - l_blod_30 - s_blod_30), type = "F")/norm((blod_30), type = "F"),
      lod40 = norm((blod_40 - l_blod_40 - s_blod_40), type = "F")/norm((blod_40), type = "F"),
      lod50 = norm((blod_50 - l_blod_50 - s_blod_50), type = "F")/norm((blod_50), type = "F"))) %>% 
  gather(percent_blod, norm) %>% 
  mutate(Values = "< LOD")

l_above_blod_0 <- as.matrix((!tf_lod_0)*L_lod0)
s_above_blod_0 <- as.matrix((!tf_lod_0)*S_lod0)

l_above_blod_10 <- as.matrix((!tf_lod_10)*L_lod10)
s_above_blod_10 <- as.matrix((!tf_lod_10)*S_lod10)

l_above_blod_20 <- as.matrix((!tf_lod_20)*L_lod20)
s_above_blod_20 <- as.matrix((!tf_lod_20)*S_lod20)

l_above_blod_30 <- as.matrix((!tf_lod_30)*L_lod30)
s_above_blod_30 <- as.matrix((!tf_lod_30)*S_lod30)

l_above_blod_40 <- as.matrix((!tf_lod_40)*L_lod40)
s_above_blod_40 <- as.matrix((!tf_lod_40)*S_lod40)

l_above_blod_50 <- as.matrix((!tf_lod_50)*L_lod50)
s_above_blod_50 <- as.matrix((!tf_lod_50)*S_lod50)

#divide by true values
above_diff <- as_tibble(cbind(
  lod0  = norm((mix  - l_above_blod_0  - s_above_blod_0),  type = "F")/norm(mix,  type = "F"),
  lod10 = norm((mix_data_lod_10_0 - l_above_blod_10 - s_above_blod_10), type = "F")/norm(mix_data_lod_10_0, type = "F"),
  lod20 = norm((mix_data_lod_20_0 - l_above_blod_20 - s_above_blod_20), type = "F")/norm(mix_data_lod_20_0, type = "F"),
  lod30 = norm((mix_data_lod_30_0 - l_above_blod_30 - s_above_blod_30), type = "F")/norm(mix_data_lod_30_0, type = "F"),
  lod40 = norm((mix_data_lod_40_0 - l_above_blod_40 - s_above_blod_40), type = "F")/norm(mix_data_lod_40_0, type = "F"),
  lod50 = norm((mix_data_lod_50_0 - l_above_blod_50 - s_above_blod_50), type = "F")/norm(mix_data_lod_50_0, type = "F"))) %>% 
  gather(percent_blod, norm) %>% 
  mutate(Values = "> LOD")

ab_neg <- rbind(above_diff, less_diff) %>% 
  ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point(aes(color = Values)) + geom_path(aes(group = Values, color = Values)) + theme_bw() +
  labs(x = "Percent Below LOD", 
       y = "Relative Error in Values < LOD & > LOD\n(norm(X-L-S) / norm(X))",
       title = "Jingkai's <LOD PCP") + theme(legend.position = "bottom")

nn_l_blod_0 <- as.matrix(tf_lod_0*nn_L_lod0)
nn_s_blod_0 <- as.matrix(tf_lod_0*nn_S_lod0)

nn_l_blod_10 <- as.matrix(tf_lod_10*nn_L_lod10)
nn_s_blod_10 <- as.matrix(tf_lod_10*nn_S_lod10)

nn_l_blod_20 <- as.matrix(tf_lod_20*nn_L_lod20)
nn_s_blod_20 <- as.matrix(tf_lod_20*nn_S_lod20)

nn_l_blod_30 <- as.matrix(tf_lod_30*nn_L_lod30)
nn_s_blod_30 <- as.matrix(tf_lod_30*nn_S_lod30)

nn_l_blod_40 <- as.matrix(tf_lod_40*nn_L_lod40)
nn_s_blod_40 <- as.matrix(tf_lod_40*nn_S_lod40)

nn_l_blod_50 <- as.matrix(tf_lod_50*nn_L_lod50)
nn_s_blod_50 <- as.matrix(tf_lod_50*nn_S_lod50)

#Subtract true values and divide by norm of true
nn_less_diff <- as_tibble(cbind(lod0 = norm((blod_0 - nn_l_blod_0 - nn_s_blod_0), type = "F"), #/norm((mix), type = "F"),
      lod10 = norm((blod_10 - nn_l_blod_10 - nn_s_blod_10), type = "F")/norm((blod_10), type = "F"),
      lod20 = norm((blod_20 - nn_l_blod_20 - nn_s_blod_20), type = "F")/norm((blod_20), type = "F"),
      lod30 = norm((blod_30 - nn_l_blod_30 - nn_s_blod_30), type = "F")/norm((blod_30), type = "F"),
      lod40 = norm((blod_40 - nn_l_blod_40 - nn_s_blod_40), type = "F")/norm((blod_40), type = "F"),
      lod50 = norm((blod_50 - nn_l_blod_50 - nn_s_blod_50), type = "F")/norm((blod_50), type = "F"))) %>% 
  gather(percent_blod, norm) %>% 
  mutate(Values = "< LOD")

nn_l_above_blod_0 <- as.matrix((!tf_lod_0)*nn_L_lod0)
nn_s_above_blod_0 <- as.matrix((!tf_lod_0)*nn_S_lod0)

nn_l_above_blod_10 <- as.matrix((!tf_lod_10)*nn_L_lod10)
nn_s_above_blod_10 <- as.matrix((!tf_lod_10)*nn_S_lod10)

nn_l_above_blod_20 <- as.matrix((!tf_lod_20)*nn_L_lod20)
nn_s_above_blod_20 <- as.matrix((!tf_lod_20)*nn_S_lod20)

nn_l_above_blod_30 <- as.matrix((!tf_lod_30)*nn_L_lod30)
nn_s_above_blod_30 <- as.matrix((!tf_lod_30)*nn_S_lod30)

nn_l_above_blod_40 <- as.matrix((!tf_lod_40)*nn_L_lod40)
nn_s_above_blod_40 <- as.matrix((!tf_lod_40)*nn_S_lod40)

nn_l_above_blod_50 <- as.matrix((!tf_lod_50)*nn_L_lod50)
nn_s_above_blod_50 <- as.matrix((!tf_lod_50)*nn_S_lod50)

#divide by true values
nn_above_diff <- as_tibble(cbind(
  lod0  = norm((mix  - nn_l_above_blod_0  - nn_s_above_blod_0),  type = "F")/norm(mix,  type = "F"),
  lod10 = norm((mix_data_lod_10_0 - nn_l_above_blod_10 - nn_s_above_blod_10), type = "F")/norm(mix_data_lod_10_0, type = "F"),
  lod20 = norm((mix_data_lod_20_0 - nn_l_above_blod_20 - nn_s_above_blod_20), type = "F")/norm(mix_data_lod_20_0, type = "F"),
  lod30 = norm((mix_data_lod_30_0 - nn_l_above_blod_30 - nn_s_above_blod_30), type = "F")/norm(mix_data_lod_30_0, type = "F"),
  lod40 = norm((mix_data_lod_40_0 - nn_l_above_blod_40 - nn_s_above_blod_40), type = "F")/norm(mix_data_lod_40_0, type = "F"),
  lod50 = norm((mix_data_lod_50_0 - nn_l_above_blod_50 - nn_s_above_blod_50), type = "F")/norm(mix_data_lod_50_0, type = "F"))) %>% 
  gather(percent_blod, norm) %>% 
  mutate(Values = "> LOD")

ab_nn <- rbind(nn_above_diff, nn_less_diff) %>% 
  ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point(aes(color = Values)) + geom_path(aes(group = Values, color = Values)) + theme_bw() +
  labs(x = "Percent Below LOD", 
       y = "Relative Error in Values < LOD & > LOD\n(norm(X-L-S) / norm(X))",
       title = "<LOD PCP with measured values") + theme(legend.position = "bottom")

l_blod_0_0 <- as.matrix(tf_lod_0*L_lod0_0)
s_blod_0_0 <- as.matrix(tf_lod_0*S_lod0_0)

l_blod_10_0 <- as.matrix(tf_lod_10*L_lod10_0)
s_blod_10_0 <- as.matrix(tf_lod_10*S_lod10_0)

l_blod_20_0 <- as.matrix(tf_lod_20*L_lod20_0)
s_blod_20_0 <- as.matrix(tf_lod_20*S_lod20_0)

l_blod_30_0 <- as.matrix(tf_lod_30*L_lod30_0)
s_blod_30_0 <- as.matrix(tf_lod_30*S_lod30_0)

l_blod_40_0 <- as.matrix(tf_lod_40*L_lod40_0)
s_blod_40_0 <- as.matrix(tf_lod_40*S_lod40_0)

l_blod_50_0 <- as.matrix(tf_lod_50*L_lod50_0)
s_blod_50_0 <- as.matrix(tf_lod_50*S_lod50_0)

#Subtract true values and divide by norm of true
less_diff_0 <- as_tibble(cbind(
      lod0 = norm((blod_0 - l_blod_0_0 - s_blod_0_0), type = "F"), #/norm((blod_0), type = "F"),
      lod10 = norm((blod_10 - l_blod_10_0 - s_blod_10_0), type = "F")/norm((blod_10), type = "F"),
      lod20 = norm((blod_20 - l_blod_20_0 - s_blod_20_0), type = "F")/norm((blod_20), type = "F"),
      lod30 = norm((blod_30 - l_blod_30_0 - s_blod_30_0), type = "F")/norm((blod_30), type = "F"),
      lod40 = norm((blod_40 - l_blod_40_0 - s_blod_40_0), type = "F")/norm((blod_40), type = "F"),
      lod50 = norm((blod_50 - l_blod_50_0 - s_blod_50_0), type = "F")/norm((blod_50), type = "F"))) %>% 
  gather(percent_blod, norm) %>% 
  mutate(Values = "< LOD")

l_above_blod_0_0 <- as.matrix((!tf_lod_0)*L_lod0_0)
s_above_blod_0_0 <- as.matrix((!tf_lod_0)*S_lod0_0)

l_above_blod_10_0 <- as.matrix((!tf_lod_10)*L_lod10_0)
s_above_blod_10_0 <- as.matrix((!tf_lod_10)*S_lod10_0)

l_above_blod_20_0 <- as.matrix((!tf_lod_20)*L_lod20_0)
s_above_blod_20_0 <- as.matrix((!tf_lod_20)*S_lod20_0)

l_above_blod_30_0 <- as.matrix((!tf_lod_30)*L_lod30_0)
s_above_blod_30_0 <- as.matrix((!tf_lod_30)*S_lod30_0)

l_above_blod_40_0 <- as.matrix((!tf_lod_40)*L_lod40_0)
s_above_blod_40_0 <- as.matrix((!tf_lod_40)*S_lod40_0)

l_above_blod_50_0 <- as.matrix((!tf_lod_50)*L_lod50_0)
s_above_blod_50_0 <- as.matrix((!tf_lod_50)*S_lod50_0)

#divide by true values
above_diff_0 <- as_tibble(cbind(
  lod0  = norm((mix  - l_above_blod_0_0  - s_above_blod_0_0),  type = "F")/norm(mix,  type = "F"),
  lod10 = norm((mix_data_lod_10_0 - l_above_blod_10_0 - s_above_blod_10_0), type = "F")/norm(mix_data_lod_10_0, type = "F"),
  lod20 = norm((mix_data_lod_20_0 - l_above_blod_20_0 - s_above_blod_20_0), type = "F")/norm(mix_data_lod_20_0, type = "F"),
  lod30 = norm((mix_data_lod_30_0 - l_above_blod_30_0 - s_above_blod_30_0), type = "F")/norm(mix_data_lod_30_0, type = "F"),
  lod40 = norm((mix_data_lod_40_0 - l_above_blod_40_0 - s_above_blod_40_0), type = "F")/norm(mix_data_lod_40_0, type = "F"),
  lod50 = norm((mix_data_lod_50_0 - l_above_blod_50_0 - s_above_blod_50_0), type = "F")/norm(mix_data_lod_50_0, type = "F"))) %>% 
  gather(percent_blod, norm) %>% 
  mutate(Values = "> LOD")

ab_0 <- rbind(above_diff_0, less_diff_0) %>% 
  ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point(aes(color = Values)) + geom_path(aes(group = Values, color = Values)) + theme_bw() +
  labs(x = "Percent Below LOD", 
       y = "Relative Error in Values < LOD & > LOD\n(norm(X-L-S) / norm(X))",
       title = "Original PCP with constant zero") + theme(legend.position = "bottom")

L_blod_0_sqrt2 <- as.matrix(tf_lod_0*L_lod0_sqrt2)
S_blod_0_sqrt2 <- as.matrix(tf_lod_0*S_lod0_sqrt2)

L_blod_10_sqrt2 <- as.matrix(tf_lod_10*L_lod10_sqrt2)
S_blod_10_sqrt2 <- as.matrix(tf_lod_10*S_lod10_sqrt2)

L_blod_20_sqrt2 <- as.matrix(tf_lod_20*L_lod20_sqrt2)
S_blod_20_sqrt2 <- as.matrix(tf_lod_20*S_lod20_sqrt2)

L_blod_30_sqrt2 <- as.matrix(tf_lod_30*L_lod30_sqrt2)
S_blod_30_sqrt2 <- as.matrix(tf_lod_30*S_lod30_sqrt2)

L_blod_40_sqrt2 <- as.matrix(tf_lod_40*L_lod40_sqrt2)
S_blod_40_sqrt2 <- as.matrix(tf_lod_40*S_lod40_sqrt2)

L_blod_50_sqrt2 <- as.matrix(tf_lod_50*L_lod50_sqrt2)
S_blod_50_sqrt2 <- as.matrix(tf_lod_50*S_lod50_sqrt2)

less_diff_sqrt2 <- as_tibble(
  cbind(lod0  = norm((blod_0  - L_blod_0_sqrt2  - S_blod_0_sqrt2),  type = "F"), #/norm((blod_0), type = "F"),
        lod10 = norm((blod_10 - L_blod_10_sqrt2 - S_blod_10_sqrt2), type = "F")/norm((blod_10), type = "F"),
        lod20 = norm((blod_20 - L_blod_20_sqrt2 - S_blod_20_sqrt2), type = "F")/norm((blod_20), type = "F"),
        lod30 = norm((blod_30 - L_blod_30_sqrt2 - S_blod_30_sqrt2), type = "F")/norm((blod_30), type = "F"),
        lod40 = norm((blod_40 - L_blod_40_sqrt2 - S_blod_40_sqrt2), type = "F")/norm((blod_40), type = "F"),
        lod50 = norm((blod_50 - L_blod_50_sqrt2 - S_blod_50_sqrt2), type = "F")/norm((blod_50), type = "F"))) %>% 
  gather(percent_blod, norm) %>% 
  mutate(Values = "< LOD")

L_above_blod_0_sqrt2 <- as.matrix((!tf_lod_0)*L_lod0_sqrt2)
S_above_blod_0_sqrt2 <- as.matrix((!tf_lod_0)*S_lod0_sqrt2)

L_above_blod_10_sqrt2 <- as.matrix((!tf_lod_10)*L_lod10_sqrt2)
S_above_blod_10_sqrt2 <- as.matrix((!tf_lod_10)*S_lod10_sqrt2)

L_above_blod_20_sqrt2 <- as.matrix((!tf_lod_20)*L_lod20_sqrt2)
S_above_blod_20_sqrt2 <- as.matrix((!tf_lod_20)*S_lod20_sqrt2)

L_above_blod_30_sqrt2 <- as.matrix((!tf_lod_30)*L_lod30_sqrt2)
S_above_blod_30_sqrt2 <- as.matrix((!tf_lod_30)*S_lod30_sqrt2)

L_above_blod_40_sqrt2 <- as.matrix((!tf_lod_40)*L_lod40_sqrt2)
S_above_blod_40_sqrt2 <- as.matrix((!tf_lod_40)*S_lod40_sqrt2)

L_above_blod_50_sqrt2 <- as.matrix((!tf_lod_50)*L_lod50_sqrt2)
S_above_blod_50_sqrt2 <- as.matrix((!tf_lod_50)*S_lod50_sqrt2)

#divide by true values
above_diff_sqrt2 <- as_tibble(cbind(
  lod0  = norm((mix  - L_above_blod_0_sqrt2  - S_above_blod_0_sqrt2),  type = "F")/norm(mix,  type = "F"),
  lod10 = norm((mix_data_lod_10_0 - L_above_blod_10_sqrt2 - S_above_blod_10_sqrt2), type = "F")/norm(mix_data_lod_10_0, type = "F"),
  lod20 = norm((mix_data_lod_20_0 - L_above_blod_20_sqrt2 - S_above_blod_20_sqrt2), type = "F")/norm(mix_data_lod_20_0, type = "F"),
  lod30 = norm((mix_data_lod_30_0 - L_above_blod_30_sqrt2 - S_above_blod_30_sqrt2), type = "F")/norm(mix_data_lod_30_0, type = "F"),
  lod40 = norm((mix_data_lod_40_0 - L_above_blod_40_sqrt2 - S_above_blod_40_sqrt2), type = "F")/norm(mix_data_lod_40_0, type = "F"),
  lod50 = norm((mix_data_lod_50_0 - L_above_blod_50_sqrt2 - S_above_blod_50_sqrt2), type = "F")/norm(mix_data_lod_50_0, type = "F"))) %>% 
  gather(percent_blod, norm) %>% 
  mutate(Values = "> LOD")

ab_s2 <- rbind(above_diff_sqrt2, less_diff_sqrt2) %>% 
  ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point(aes(color = Values)) + geom_path(aes(group = Values, color = Values)) + theme_bw() +
  labs(x = "Percent Below LOD", 
       y = "Relative Error in Values < LOD & > LOD\n(norm(X-L-S) / norm(X))",
       title = "Original PCP with LOD/sqrt(2)") + theme(legend.position = "bottom")
```

### Viz

```{r}
(ab_neg + 
     ylim(0, 1) + 
     xlab("") + theme(legend.position = "none")) +
   (ab_nn + 
      ylim(0, 1) + 
      xlab("") + ylab("") + theme(legend.position = "none"))

(ab_0 + 
     ylim(0, 1) + 
     theme(legend.position = "none")) +
   (ab_s2 + 
      ylim(0, 1) + 
      ylab("") + theme(legend.position = "none"))
```

## SVD

```{r}
svd(L_lod0)$d

svd(L_lod50)$d
```

### Right singular vectors

```{r}
# Extract right singular vectors from each low rank solution matrix
V_lod0  <-  svd(L_lod0)$v[,1:5]
V_lod10 <- svd(L_lod10)$v[,1:5]
V_lod20 <- svd(L_lod20)$v[,1:5]
V_lod30 <- svd(L_lod30)$v[,1:5]
V_lod40 <- svd(L_lod40)$v[,1:5]
V_lod50 <- svd(L_lod50)$v[,1:5]

# Hack to flip singular vectos -- Use correlation
# cor(V_lod0, V_lod10)
# cor(V_lod0, V_lod20)
# cor(V_lod0, V_lod30)
# cor(V_lod0, V_lod40)
# cor(V_lod0, V_lod50)

# Hack -- Flip
V_lod30[,4] <- -V_lod30[,4]
V_lod30[,3] <- -V_lod30[,3]
V_lod40[,3] <- -V_lod40[,3]
V_lod40[,4] <- -V_lod40[,4]
V_lod40[,5] <- -V_lod40[,5]
V_lod50[,3] <- -V_lod50[,3]
V_lod50[,4] <- -V_lod50[,4]
V_lod50[,5] <- -V_lod50[,5]

V_diff <- as_tibble(cbind(lod0 =norm((V_lod0 - V_lod0), type = "F")/norm((V_lod0), type = "F"),
      lod10 =norm((V_lod10 - V_lod0), type = "F")/norm((V_lod0), type = "F"),
      lod20 =norm((V_lod20 - V_lod0), type = "F")/norm((V_lod0), type = "F"),
      lod30 =norm((V_lod30 - V_lod0), type = "F")/norm((V_lod0), type = "F"),
      lod40 =norm((V_lod40 - V_lod0), type = "F")/norm((V_lod0), type = "F"),
      lod50 =norm((V_lod50 - V_lod0), type = "F")/norm((V_lod0), type = "F"))) %>% 
  gather(percent_blod, norm)

#V_diff

right_neg <- V_diff %>% ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point() + geom_path(aes(group = 1)) + theme_bw() +
  labs(x = "Percent Below LOD", 
       y = "Relative Error in Low-Rank Solution Singular Vectors\n(norm(SV - SV_lod0) / norm(SV_lod0))",
       title = "Jingkai's <LOD PCP")

# Extract right singular vectors from each low rank solution matrix
nn_V_lod0  <-  svd(nn_L_lod0)$v[,1:5]
nn_V_lod10 <- svd(nn_L_lod10)$v[,1:5]
nn_V_lod20 <- svd(nn_L_lod20)$v[,1:5]
nn_V_lod30 <- svd(nn_L_lod30)$v[,1:5]
nn_V_lod40 <- svd(nn_L_lod40)$v[,1:5]
nn_V_lod50 <- svd(nn_L_lod50)$v[,1:5]

# cor(nn_V_lod0, nn_V_lod10)
# cor(nn_V_lod0, nn_V_lod20)
# cor(nn_V_lod0, nn_V_lod30)
# cor(nn_V_lod0, nn_V_lod40)
# cor(nn_V_lod0, nn_V_lod50)

# Hack -- Flip
nn_V_lod30[,3] <- -nn_V_lod30[,3]
nn_V_lod30[,4] <- -nn_V_lod30[,4]
nn_V_lod40[,3] <- -nn_V_lod40[,3]
nn_V_lod40[,4] <- -nn_V_lod40[,4]
nn_V_lod40[,5] <- -nn_V_lod40[,5]
nn_V_lod50[,3] <- -nn_V_lod50[,3]
nn_V_lod50[,4] <- -nn_V_lod50[,4]
nn_V_lod50[,5] <- -nn_V_lod50[,5]

nn_V_diff <- as_tibble(cbind(lod0 =norm((nn_V_lod0 - nn_V_lod0), type = "F")/norm((nn_V_lod0), type = "F"),
      lod10 =norm((nn_V_lod10 - nn_V_lod0), type = "F")/norm((nn_V_lod0), type = "F"),
      lod20 =norm((nn_V_lod20 - nn_V_lod0), type = "F")/norm((nn_V_lod0), type = "F"),
      lod30 =norm((nn_V_lod30 - nn_V_lod0), type = "F")/norm((nn_V_lod0), type = "F"),
      lod40 =norm((nn_V_lod40 - nn_V_lod0), type = "F")/norm((nn_V_lod0), type = "F"),
      lod50 =norm((nn_V_lod50 - nn_V_lod0), type = "F")/norm((nn_V_lod0), type = "F"))) %>% 
  gather(percent_blod, norm)

#nn_V_diff

right_nn <- nn_V_diff %>% ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point() + geom_path(aes(group = 1)) + theme_bw() +
  labs(x = "Percent Below LOD", 
       y = "Relative Error in Low-Rank Solution Singular Vectors\n(norm(SV - SV_lod0) / norm(SV_lod0))",
       title = "<LOD PCP with measured values")

# Extract right singular vectors from each low rank solution matrix
V_lod0_0  <-  svd(L_lod0_0)$v[,1:5]
V_lod10_0 <- svd(L_lod10_0)$v[,1:5]
V_lod20_0 <- svd(L_lod20_0)$v[,1:5]
V_lod30_0 <- svd(L_lod30_0)$v[,1:5]
V_lod40_0 <- svd(L_lod40_0)$v[,1:5]
V_lod50_0 <- svd(L_lod50_0)$v[,1:5]

# cor(V_lod0_0, V_lod10_0)
# cor(V_lod0_0, V_lod20_0)
# cor(V_lod0_0, V_lod30_0)
# cor(V_lod0_0, V_lod40_0)
# cor(V_lod0_0, V_lod50_0)

# Hack -- Flip
V_lod20_0[,5] <- -V_lod20_0[,5]
V_lod40_0[,4] <- -V_lod40_0[,4]
V_lod50_0[,3] <- -V_lod50_0[,3]
V_lod50_0[,5] <- -V_lod50_0[,5]

V_diff_0 <- as_tibble(cbind(lod0 =norm((V_lod0_0 - V_lod0_0), type = "F")/norm((V_lod0_0), type = "F"),
      lod10 =norm((V_lod10_0 - V_lod0_0), type = "F")/norm((V_lod0_0), type = "F"),
      lod20 =norm((V_lod20_0 - V_lod0_0), type = "F")/norm((V_lod0_0), type = "F"),
      lod30 =norm((V_lod30_0 - V_lod0_0), type = "F")/norm((V_lod0_0), type = "F"),
      lod40 =norm((V_lod40_0 - V_lod0_0), type = "F")/norm((V_lod0_0), type = "F"),
      lod50 =norm((V_lod50_0 - V_lod0_0), type = "F")/norm((V_lod0_0), type = "F"))) %>% 
  gather(percent_blod, norm)

#V_diff_0

right_0 <- V_diff_0 %>% ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point() + geom_path(aes(group = 1)) + theme_bw() +
  labs(x = "Percent Below LOD", 
       y = "Relative Error in Low-Rank Solution Singular Vectors\n(norm(SV - SV_lod0) / norm(SV_lod0))",
       title = "Original PCP with constant zero")

# Extract right singular vectors from each low rank solution matrix
V_lod0_sqrt2  <-  svd(L_lod0_sqrt2)$v[,1:5]
V_lod10_sqrt2 <- svd(L_lod10_sqrt2)$v[,1:5]
V_lod20_sqrt2 <- svd(L_lod20_sqrt2)$v[,1:5]
V_lod30_sqrt2 <- svd(L_lod30_sqrt2)$v[,1:5]
V_lod40_sqrt2 <- svd(L_lod40_sqrt2)$v[,1:5]
V_lod50_sqrt2 <- svd(L_lod50_sqrt2)$v[,1:5]

# cor(V_lod0_sqrt2, V_lod10_sqrt2)
# cor(V_lod0_sqrt2, V_lod20_sqrt2)
# cor(V_lod0_sqrt2, V_lod30_sqrt2)
# cor(V_lod0_sqrt2, V_lod40_sqrt2)
# cor(V_lod0_sqrt2, V_lod50_sqrt2)

# Hack -- Flip
V_lod40_sqrt2[,3] <- -V_lod40_sqrt2[,3]
V_lod40_sqrt2[,5] <- -V_lod40_sqrt2[,5]
V_lod50_sqrt2[,3] <- -V_lod50_sqrt2[,3]
V_lod50_sqrt2[,4] <- -V_lod50_sqrt2[,4]

V_diff_sqrt2 <- as_tibble(cbind(lod0 =norm((V_lod0_sqrt2 - V_lod0_sqrt2), type = "F")/norm((V_lod0_sqrt2), type = "F"),
      lod10 =norm((V_lod10_sqrt2 - V_lod0_sqrt2), type = "F")/norm((V_lod0_sqrt2), type = "F"),
      lod20 =norm((V_lod20_sqrt2 - V_lod0_sqrt2), type = "F")/norm((V_lod0_sqrt2), type = "F"),
      lod30 =norm((V_lod30_sqrt2 - V_lod0_sqrt2), type = "F")/norm((V_lod0_sqrt2), type = "F"),
      lod40 =norm((V_lod40_sqrt2 - V_lod0_sqrt2), type = "F")/norm((V_lod0_sqrt2), type = "F"),
      lod50 =norm((V_lod50_sqrt2 - V_lod0_sqrt2), type = "F")/norm((V_lod0_sqrt2), type = "F"))) %>% 
  gather(percent_blod, norm)

#V_diff_sqrt2

right_s2 <- V_diff_sqrt2 %>% ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point() + geom_path(aes(group = 1)) + theme_bw() +
  labs(x = "Percent Below LOD", 
       y = "Relative Error in Low-Rank Solution Singular Vectors\n(norm(SV - SV_lod0) / norm(SV_lod0))",
       title = "Original PCP with LOD/sqrt(2)")
```

#### Viz

```{r, message=FALSE, warning=FALSE}
as_tibble(V_lod0) %>% 
  mutate(PM = colnames(mix),
         LOD = "LOD 0") %>% 
  full_join(., as_tibble(V_lod10) %>%
  mutate(PM = colnames(mix),
         LOD = "LOD 10")) %>%
  full_join(., as_tibble(V_lod20) %>%
  mutate(PM = colnames(mix),
         LOD = "LOD 20")) %>%
  full_join(., as_tibble(V_lod30) %>%
  mutate(PM = colnames(mix),
         LOD = "LOD 30")) %>%
  full_join(., as_tibble(V_lod40) %>%
  mutate(PM = colnames(mix),
         LOD = "LOD 40")) %>%
  full_join(., as_tibble(V_lod50) %>%
  mutate(PM = colnames(mix),
         LOD = "LOD 50")) %>%
  gather(key = singular_vector, value = magnitude, V1:V5) %>%
  ggplot(aes(x = PM, y = magnitude)) + geom_point() + 
  geom_segment(aes(xend = PM, yend = 0)) +
  facet_grid(LOD ~ singular_vector) +
  geom_hline(yintercept = 0, linetype = "dashed", 
             color = "red") +
  theme_bw(base_size = 12) + labs(x = "", y = "Magnitude", title = "Jingkai's <LOD PCP") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.background = element_rect(fill = "white")) +
  geom_hline(yintercept = 0, size = 0.2) + 
  theme(legend.position = c(0.85, 0.10), 
                legend.background = element_rect(fill = "white", colour = NA),
        legend.text=element_text(size=15),
        legend.title = element_blank(),
        strip.text.x = element_text(size = 13),
        axis.title.y = element_text(size = 18))
```

```{r, message=FALSE}
as_tibble(nn_V_lod0) %>% 
  mutate(PM = colnames(mix),
         LOD = "LOD 0") %>% 
  full_join(., as_tibble(nn_V_lod10) %>%
  mutate(PM = colnames(mix),
         LOD = "LOD 10")) %>%
  full_join(., as_tibble(nn_V_lod20) %>%
  mutate(PM = colnames(mix),
         LOD = "LOD 20")) %>%
  full_join(., as_tibble(nn_V_lod30) %>%
  mutate(PM = colnames(mix),
         LOD = "LOD 30")) %>%
  full_join(., as_tibble(nn_V_lod40) %>%
  mutate(PM = colnames(mix),
         LOD = "LOD 40")) %>%
  full_join(., as_tibble(nn_V_lod50) %>%
  mutate(PM = colnames(mix),
         LOD = "LOD 50")) %>%
  gather(key = singular_vector, value = magnitude, V1:V5) %>%
  ggplot(aes(x = PM, y = magnitude)) + geom_point() + 
  geom_segment(aes(xend = PM, yend = 0)) +
  facet_grid(LOD ~ singular_vector) +
  geom_hline(yintercept = 0, linetype = "dashed", 
             color = "red") +
  theme_bw(base_size = 12) + labs(x = "", y = "Magnitude", title = "<LOD PCP with measured values") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.background = element_rect(fill = "white")) +
  geom_hline(yintercept = 0, size = 0.2) + 
  theme(legend.position = c(0.85, 0.10), 
                legend.background = element_rect(fill = "white", colour = NA),
        legend.text=element_text(size=15),
        legend.title = element_blank(),
        strip.text.x = element_text(size = 13),
        axis.title.y = element_text(size = 18))
```

```{r, message=FALSE}
as_tibble(V_lod0_0) %>% 
  mutate(PM = colnames(mix),
         LOD = "LOD 0") %>% 
  full_join(., as_tibble(V_lod10_0) %>%
  mutate(PM = colnames(mix),
         LOD = "LOD 10")) %>%
  full_join(., as_tibble(V_lod20_0) %>%
  mutate(PM = colnames(mix),
         LOD = "LOD 20")) %>%
  full_join(., as_tibble(V_lod30_0) %>%
  mutate(PM = colnames(mix),
         LOD = "LOD 30")) %>%
  full_join(., as_tibble(V_lod40_0) %>%
  mutate(PM = colnames(mix),
         LOD = "LOD 40")) %>%
  full_join(., as_tibble(V_lod50_0) %>%
  mutate(PM = colnames(mix),
         LOD = "LOD 50")) %>%
  gather(key = singular_vector, value = magnitude, V1:V5) %>%
  ggplot(aes(x = PM, y = magnitude)) + geom_point() + 
  geom_segment(aes(xend = PM, yend = 0)) +
  facet_grid(LOD ~ singular_vector) +
  geom_hline(yintercept = 0, linetype = "dashed", 
             color = "red") +
  theme_bw(base_size = 12) + labs(x = "", y = "Magnitude", title = "Original PCP with constant zero") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.background = element_rect(fill = "white")) +
  geom_hline(yintercept = 0, size = 0.2) + 
  theme(legend.position = c(0.85, 0.10), 
                legend.background = element_rect(fill = "white", colour = NA),
        legend.text=element_text(size=15),
        legend.title = element_blank(),
        strip.text.x = element_text(size = 13),
        axis.title.y = element_text(size = 18))
```

```{r, message=FALSE}
as_tibble(V_lod0_sqrt2) %>% 
  mutate(PM = colnames(mix),
         LOD = "LOD 0") %>% 
  full_join(., as_tibble(V_lod10_sqrt2) %>%
  mutate(PM = colnames(mix),
         LOD = "LOD 10")) %>%
  full_join(., as_tibble(V_lod20_sqrt2) %>%
  mutate(PM = colnames(mix),
         LOD = "LOD 20")) %>%
  full_join(., as_tibble(V_lod30_sqrt2) %>%
  mutate(PM = colnames(mix),
         LOD = "LOD 30")) %>%
  full_join(., as_tibble(V_lod40_sqrt2) %>%
  mutate(PM = colnames(mix),
         LOD = "LOD 40")) %>%
  full_join(., as_tibble(V_lod50_sqrt2) %>%
  mutate(PM = colnames(mix),
         LOD = "LOD 50")) %>%
  gather(key = singular_vector, value = magnitude, V1:V5) %>%
  ggplot(aes(x = PM, y = magnitude)) + geom_point() + 
  geom_segment(aes(xend = PM, yend = 0)) +
  facet_grid(LOD ~ singular_vector) +
  geom_hline(yintercept = 0, linetype = "dashed", 
             color = "red") +
  theme_bw(base_size = 12) + labs(x = "", y = "Magnitude", title = "Original PCP with LOD/sqrt(2)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.background = element_rect(fill = "white")) +
  geom_hline(yintercept = 0, size = 0.2) + 
  theme(legend.position = c(0.85, 0.10), 
                legend.background = element_rect(fill = "white", colour = NA),
        legend.text=element_text(size=15),
        legend.title = element_blank(),
        strip.text.x = element_text(size = 13),
        axis.title.y = element_text(size = 18))
```

```{r}
(right_neg + 
     ylim(0, 1) + 
     xlab("")) +
   (right_nn + 
      ylim(0, 1) + 
      xlab("") + ylab(""))

(right_0 + 
     ylim(0, 1)) +
   (right_s2 + 
      ylim(0, 1) + 
      ylab(""))
```

### Left singular vectors

```{r}
u_lod0  <-  svd(L_lod0)$u[,1:5]
u_lod10 <- svd(L_lod10)$u[,1:5]
u_lod20 <- svd(L_lod20)$u[,1:5]
u_lod30 <- svd(L_lod30)$u[,1:5]
u_lod40 <- svd(L_lod40)$u[,1:5]
u_lod50 <- svd(L_lod50)$u[,1:5]

# Hack -- Flip
u_lod30[,4] <- -u_lod30[,4]
u_lod30[,3] <- -u_lod30[,3]
u_lod40[,3] <- -u_lod40[,3]
u_lod40[,4] <- -u_lod40[,4]
u_lod40[,5] <- -u_lod40[,5]
u_lod50[,3] <- -u_lod50[,3]
u_lod50[,4] <- -u_lod50[,4]
u_lod50[,5] <- -u_lod50[,5]

u_diff <- as_tibble(cbind(lod0 =norm((u_lod0 - u_lod0), type = "F")/norm((u_lod0), type = "F"),
      lod10 =norm((u_lod10 - u_lod0), type = "F")/norm((u_lod0), type = "F"),
      lod20 =norm((u_lod20 - u_lod0), type = "F")/norm((u_lod0), type = "F"),
      lod30 =norm((u_lod30 - u_lod0), type = "F")/norm((u_lod0), type = "F"),
      lod40 =norm((u_lod40 - u_lod0), type = "F")/norm((u_lod0), type = "F"),
      lod50 =norm((u_lod50 - u_lod0), type = "F")/norm((u_lod0), type = "F"))) %>% 
  gather(percent_blod, norm)

# u_diff
left_neg <- u_diff %>% ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point() + geom_path(aes(group = 1)) + theme_bw() +
  labs(x = "Percent Below LOD", 
       y = "Relative Error in Low-Rank Solution Singular Vectors\n(norm(SV - SV_lod0) / norm(SV_lod0))",
       title = "Jingkai's <LOD PCP")

nn_u_lod0  <-  svd(nn_L_lod0)$u[,1:5]
nn_u_lod10 <- svd(nn_L_lod10)$u[,1:5]
nn_u_lod20 <- svd(nn_L_lod20)$u[,1:5]
nn_u_lod30 <- svd(nn_L_lod30)$u[,1:5]
nn_u_lod40 <- svd(nn_L_lod40)$u[,1:5]
nn_u_lod50 <- svd(nn_L_lod50)$u[,1:5]

# Hack -- Flip
nn_u_lod30[,4] <- -nn_u_lod30[,4]
nn_u_lod30[,3] <- -nn_u_lod30[,3]
nn_u_lod40[,3] <- -nn_u_lod40[,3]
nn_u_lod40[,4] <- -nn_u_lod40[,4]
nn_u_lod40[,5] <- -nn_u_lod40[,5]
nn_u_lod50[,3] <- -nn_u_lod50[,3]
nn_u_lod50[,4] <- -nn_u_lod50[,4]
nn_u_lod50[,5] <- -nn_u_lod50[,5]

nn_u_diff <- as_tibble(cbind(lod0 =norm((nn_u_lod0 - nn_u_lod0), type = "F")/norm((nn_u_lod0), type = "F"),
      lod10 =norm((nn_u_lod10 - nn_u_lod0), type = "F")/norm((nn_u_lod0), type = "F"),
      lod20 =norm((nn_u_lod20 - nn_u_lod0), type = "F")/norm((nn_u_lod0), type = "F"),
      lod30 =norm((nn_u_lod30 - nn_u_lod0), type = "F")/norm((nn_u_lod0), type = "F"),
      lod40 =norm((nn_u_lod40 - nn_u_lod0), type = "F")/norm((nn_u_lod0), type = "F"),
      lod50 =norm((nn_u_lod50 - nn_u_lod0), type = "F")/norm((nn_u_lod0), type = "F"))) %>% 
  gather(percent_blod, norm)

left_nn <- nn_u_diff %>% ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point() + geom_path(aes(group = 1)) + theme_bw() +
  labs(x = "Percent Below LOD", 
       y = "Relative Error in Low-Rank Solution Singular Vectors\n(norm(SV - SV_lod0) / norm(SV_lod0))",
       title = "<LOD PCP with measured values")

u_lod0_0  <-  svd(L_lod0_0)$u[,1:5]
u_lod10_0 <- svd(L_lod10_0)$u[,1:5]
u_lod20_0 <- svd(L_lod20_0)$u[,1:5]
u_lod30_0 <- svd(L_lod30_0)$u[,1:5]
u_lod40_0 <- svd(L_lod40_0)$u[,1:5]
u_lod50_0 <- svd(L_lod50_0)$u[,1:5]

# Hack -- Flip
u_lod20_0[,5] <- -u_lod20_0[,5]
u_lod40_0[,4] <- -u_lod40_0[,4]
u_lod50_0[,3] <- -u_lod50_0[,3]
u_lod50_0[,5] <- -u_lod50_0[,5]

u_diff_0 <- as_tibble(cbind(lod0 =norm((u_lod0_0 - u_lod0_0), type = "F")/norm((u_lod0_0), type = "F"),
      lod10 =norm((u_lod10_0 - u_lod0_0), type = "F")/norm((u_lod0_0), type = "F"),
      lod20 =norm((u_lod20_0 - u_lod0_0), type = "F")/norm((u_lod0_0), type = "F"),
      lod30 =norm((u_lod30_0 - u_lod0_0), type = "F")/norm((u_lod0_0), type = "F"),
      lod40 =norm((u_lod40_0 - u_lod0_0), type = "F")/norm((u_lod0_0), type = "F"),
      lod50 =norm((u_lod50_0 - u_lod0_0), type = "F")/norm((u_lod0_0), type = "F"))) %>% 
  gather(percent_blod, norm)

left_0 <- u_diff_0 %>% ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point() + geom_path(aes(group = 1)) + theme_bw() +
  labs(x = "Percent Below LOD", 
       y = "Relative Error in Low-Rank Solution Singular Vectors\n(norm(SV - SV_lod0) / norm(SV_lod0))",
       title = "Original PCP with constant zero")

u_lod0_sqrt2  <-  svd(L_lod0_sqrt2)$u[,1:5]
u_lod10_sqrt2 <- svd(L_lod10_sqrt2)$u[,1:5]
u_lod20_sqrt2 <- svd(L_lod20_sqrt2)$u[,1:5]
u_lod30_sqrt2 <- svd(L_lod30_sqrt2)$u[,1:5]
u_lod40_sqrt2 <- svd(L_lod40_sqrt2)$u[,1:5]
u_lod50_sqrt2 <- svd(L_lod50_sqrt2)$u[,1:5]

# Hack -- Flip
u_lod40_sqrt2[,3] <- -u_lod40_sqrt2[,3]
u_lod40_sqrt2[,5] <- -u_lod40_sqrt2[,5]
u_lod50_sqrt2[,3] <- -u_lod50_sqrt2[,3]
u_lod50_sqrt2[,4] <- -u_lod50_sqrt2[,4]

u_diff_sqrt2 <- as_tibble(cbind(lod0 =norm((u_lod0_sqrt2 - u_lod0_sqrt2), type = "F")/norm((u_lod0_sqrt2), type = "F"),
      lod10 =norm((u_lod10_sqrt2 - u_lod0_sqrt2), type = "F")/norm((u_lod0_sqrt2), type = "F"),
      lod20 =norm((u_lod20_sqrt2 - u_lod0_sqrt2), type = "F")/norm((u_lod0_sqrt2), type = "F"),
      lod30 =norm((u_lod30_sqrt2 - u_lod0_sqrt2), type = "F")/norm((u_lod0_sqrt2), type = "F"),
      lod40 =norm((u_lod40_sqrt2 - u_lod0_sqrt2), type = "F")/norm((u_lod0_sqrt2), type = "F"),
      lod50 =norm((u_lod50_sqrt2 - u_lod0_sqrt2), type = "F")/norm((u_lod0_sqrt2), type = "F"))) %>% 
  gather(percent_blod, norm)

left_s2 <- u_diff_sqrt2 %>% ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point() + geom_path(aes(group = 1)) + theme_bw() +
  labs(x = "Percent Below LOD", 
       y = "Relative Error in Low-Rank Solution Singular Vectors\n(norm(SV - SV_lod0) / norm(SV_lod0))",
       title = "Original PCP with LOD/sqrt(2)")
```

#### Viz

```{r}
(left_neg + 
     ylim(0, 1.25) + xlab("")) +
   (left_nn + 
      ylim(0, 1.25) + 
      xlab("") + ylab(""))

(left_0 + 
     ylim(0, 1.25)) +
   (left_s2 + 
      ylim(0, 1.25) + 
      ylab(""))
```

### Singular Values

```{r}
d_lod0  <- svd(L_lod0)$d[1:5]
d_lod10 <- svd(L_lod10)$d[1:5]
d_lod20 <- svd(L_lod20)$d[1:5]
d_lod30 <- svd(L_lod30)$d[1:5]
d_lod40 <- svd(L_lod40)$d[1:5]
d_lod50 <- svd(L_lod50)$d[1:5]

norm_vec <- function(x) sqrt(sum(x^2))

d_diff <- as_tibble(cbind(lod0 = norm_vec(d_lod0 - d_lod0)/norm_vec(d_lod0),
      lod10 = norm_vec(d_lod10 - d_lod0)/norm_vec(d_lod0),
      lod20 = norm_vec(d_lod20 - d_lod0)/norm_vec(d_lod0),
      lod30 = norm_vec(d_lod30 - d_lod0)/norm_vec(d_lod0),
      lod40 = norm_vec(d_lod40 - d_lod0)/norm_vec(d_lod0),
      lod50 = norm_vec(d_lod50 - d_lod0)/norm_vec(d_lod0))) %>% 
  gather(percent_blod, norm)

d_neg <- d_diff %>% ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point() + geom_path(aes(group = 1)) + theme_bw() +
  labs(x = "Percent Below LOD", 
       y = "Relative Error in Low-Rank Solution Singular Values\n(norm(SV - SV_lod0) / norm(SV_lod0))",
       title = "Jingkai's <LOD PCP")

nn_d_lod0  <- svd(nn_L_lod0)$d[1:5]
nn_d_lod10 <- svd(nn_L_lod10)$d[1:5]
nn_d_lod20 <- svd(nn_L_lod20)$d[1:5]
nn_d_lod30 <- svd(nn_L_lod30)$d[1:5]
nn_d_lod40 <- svd(nn_L_lod40)$d[1:5]
nn_d_lod50 <- svd(nn_L_lod50)$d[1:5]

nn_d_diff <- as_tibble(cbind(lod0 = norm_vec(nn_d_lod0 - nn_d_lod0)/norm_vec(nn_d_lod0),
      lod10 = norm_vec(nn_d_lod10 - nn_d_lod0)/norm_vec(nn_d_lod0),
      lod20 = norm_vec(nn_d_lod20 - nn_d_lod0)/norm_vec(nn_d_lod0),
      lod30 = norm_vec(nn_d_lod30 - nn_d_lod0)/norm_vec(nn_d_lod0),
      lod40 = norm_vec(nn_d_lod40 - nn_d_lod0)/norm_vec(nn_d_lod0),
      lod50 = norm_vec(nn_d_lod50 - nn_d_lod0)/norm_vec(nn_d_lod0))) %>% 
  gather(percent_blod, norm)

d_nn <- nn_d_diff %>% ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point() + geom_path(aes(group = 1)) + theme_bw() +
  labs(x = "Percent Below LOD", 
       y = "Relative Error in Low-Rank Solution Singular Values\n(norm(SV - SV_lod0) / norm(SV_lod0))",
       title = "<LOD PCP with measured values")

d_lod0_0  <- svd(L_lod0_0)$d[1:5]
d_lod10_0 <- svd(L_lod10_0)$d[1:5]
d_lod20_0 <- svd(L_lod20_0)$d[1:5]
d_lod30_0 <- svd(L_lod30_0)$d[1:5]
d_lod40_0 <- svd(L_lod40_0)$d[1:5]
d_lod50_0 <- svd(L_lod50_0)$d[1:5]

d_diff_0 <- as_tibble(cbind(lod0 = norm_vec(d_lod0_0 - d_lod0_0)/norm_vec(d_lod0_0),
      lod10 = norm_vec(d_lod10_0 - d_lod0_0)/norm_vec(d_lod0_0),
      lod20 = norm_vec(d_lod20_0 - d_lod0_0)/norm_vec(d_lod0_0),
      lod30 = norm_vec(d_lod30_0 - d_lod0_0)/norm_vec(d_lod0_0),
      lod40 = norm_vec(d_lod40_0 - d_lod0_0)/norm_vec(d_lod0_0),
      lod50 = norm_vec(d_lod50_0 - d_lod0_0)/norm_vec(d_lod0_0))) %>% 
  gather(percent_blod, norm)

d_0 <- d_diff_0 %>% ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point() + geom_path(aes(group = 1)) + theme_bw() +
  labs(x = "Percent Below LOD", 
       y = "Relative Error in Low-Rank Solution Singular Values\n(norm(SV - SV_lod0) / norm(SV_lod0))",
       title = "Original PCP with constant zero")

d_lod0_sqrt2  <- svd(L_lod0_sqrt2)$d[1:5]
d_lod10_sqrt2 <- svd(L_lod10_sqrt2)$d[1:5]
d_lod20_sqrt2 <- svd(L_lod20_sqrt2)$d[1:5]
d_lod30_sqrt2 <- svd(L_lod30_sqrt2)$d[1:5]
d_lod40_sqrt2 <- svd(L_lod40_sqrt2)$d[1:5]
d_lod50_sqrt2 <- svd(L_lod50_sqrt2)$d[1:5]

d_diff_sqrt2 <- as_tibble(cbind(lod0 = norm_vec(d_lod0_sqrt2 - d_lod0_sqrt2)/norm_vec(d_lod0_sqrt2),
      lod10 = norm_vec(d_lod10_sqrt2 - d_lod0_sqrt2)/norm_vec(d_lod0_sqrt2),
      lod20 = norm_vec(d_lod20_sqrt2 - d_lod0_sqrt2)/norm_vec(d_lod0_sqrt2),
      lod30 = norm_vec(d_lod30_sqrt2 - d_lod0_sqrt2)/norm_vec(d_lod0_sqrt2),
      lod40 = norm_vec(d_lod40_sqrt2 - d_lod0_sqrt2)/norm_vec(d_lod0_sqrt2),
      lod50 = norm_vec(d_lod50_sqrt2 - d_lod0_sqrt2)/norm_vec(d_lod0_sqrt2))) %>% 
  gather(percent_blod, norm)

d_s2 <- d_diff_sqrt2 %>% ggplot(aes(x = percent_blod, y = norm)) + 
  geom_point() + geom_path(aes(group = 1)) + theme_bw() +
  labs(x = "Percent Below LOD", 
       y = "Relative Error in Low-Rank Solution Singular Values\n(norm(SV - SV_lod0) / norm(SV_lod0))",
       title = "Original PCP with LOD/sqrt(2)")
```

#### Viz

```{r}
(d_neg + 
     ylim(0, 0.3) + 
     xlab("")) +
   (d_nn + 
      ylim(0, 0.3) + 
      xlab("") + ylab(""))

(d_0 + ylim(0, 0.3)) + 
        (d_s2 + 
           ylim(0, 0.3) + 
           ylab(""))
```

